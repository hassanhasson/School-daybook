<script>
(function(){
  "use strict";

  // ===== Helpers =====
  const $=(s,r=document)=>r.querySelector(s);
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const DBKEY='daybook_cloud_v1', DOCS_BUCKET='student-docs', BACKUPS_BUCKET='backups';

  // حالة التطبيق
  window.d = window.d || { roster:[], attSessions:[], behavior:[], grades:[], terms:[] };
  try{ const raw=localStorage.getItem(DBKEY); if(raw){ window.d=JSON.parse(raw); } }catch{}

  function saveAll(){ try{ localStorage.setItem(DBKEY, JSON.stringify(window.d)); }catch{} }

  // كائن عام لربط/نداءات
  window.Daybook = window.Daybook || {};

  // حراس Supabase
  function hasSupa(){ if(!window.supa){ console.warn('Supabase client غير مهيأ'); return false; } return true; }

  // ===== نسخ احتياطي / استعادة =====
  async function backupToCloud(){
    try{
      if(!hasSupa()) return alert('Supabase غير مهيأ.');
      const blob=new Blob([JSON.stringify(window.d||{})],{type:'application/json'});
      const path=`backup_${Date.now()}.json`;
      const up=await supa.storage.from(BACKUPS_BUCKET).upload(path, blob, {contentType:'application/json', upsert:false});
      if(up.error){
        if(/Bucket not found/i.test(up.error.message)) return alert('⚠️ أنشئ bucket اسمه backups في Supabase ▸ Storage');
        throw up.error;
      }
      alert('تم حفظ نسخة احتياطية في السحابة');
    }catch(e){ alert('فشل النسخ الاحتياطي: '+e.message); }
  }
  async function restoreLatestFromCloud(){
    try{
      if(!hasSupa()) return alert('Supabase غير مهيأ.');
      const list=await supa.storage.from(BACKUPS_BUCKET).list('',{sortBy:{column:'created_at',order:'desc'},limit:1});
      if(list.error){
        if(/Bucket not found/i.test(list.error.message)) return alert('⚠️ أنشئ bucket اسمه backups');
        throw list.error;
      }
      if(!list.data?.length) return alert('لا توجد نسخ احتياطية');
      const dl=await supa.storage.from(BACKUPS_BUCKET).download(list.data[0].name);
      if(dl.error) throw dl.error;
      window.d = JSON.parse(await dl.data.text());
      saveAll(); alert('تمت الاستعادة'); location.reload();
    }catch(e){ alert('فشل الاستعادة: '+e.message); }
  }
  $('#s_backup_cloud')?.addEventListener('click', backupToCloud);
  $('#s_restore_cloud')?.addEventListener('click', restoreLatestFromCloud);
  Daybook.backupToCloud=backupToCloud; Daybook.restoreLatestFromCloud=restoreLatestFromCloud;

  // مسح بيانات الجهاز
  Daybook.resetLocal = function(){ if(confirm('مسح بيانات الجهاز؟')){ localStorage.removeItem(DBKEY); location.reload(); } };

  // ===== تحسين المرفقات =====
  function iconFor(m){ if(!m) return '📎'; if(m.startsWith('image/'))return'🖼️'; if(m.includes('pdf'))return'📄'; if(m.startsWith('video/'))return'🎞️'; if(m.includes('zip'))return'🗜️'; return'📎'; }
  function humanSize(b){ let s=+b||0,u=['B','KB','MB','GB','TB'],i=0; while(s>=1024&&i<u.length-1){s/=1024;i++;} return s? (s.toFixed(1)+' '+u[i]):'—'; }
  Daybook.enhanceAttachmentsUI = function(root=document){
    root.querySelectorAll('[data-copy]')?.forEach(btn=>{
      btn.onclick=()=>navigator.clipboard.writeText(btn.dataset.copy).then(()=>alert('تم نسخ الرابط'));
    });
    root.querySelectorAll('[data-size-bytes]')?.forEach(el=>{ el.textContent=humanSize(el.dataset.sizeBytes); });
    root.querySelectorAll('[data-mime]')?.forEach(el=>{ el.textContent=iconFor(el.dataset.mime); });
  };
  Daybook.uploadStudentFile = async function(path,file){
    try{
      if(!hasSupa()) return alert('Supabase غير مهيأ.');
      const up=await supa.storage.from(DOCS_BUCKET).upload(path, file, { upsert:false });
      if(up.error){
        if(/Bucket not found/i.test(up.error.message)) return alert('⚠️ أنشئ bucket اسمه student-docs');
        throw up.error;
      }
      return up.data;
    }catch(e){ alert('Storage error: '+e.message); return null; }
  };

  // ===== ملخص الحضور =====
  function refreshAttendanceSummary(){
    const tag=$('#a_summary'); if(!tag) return;
    const date=$('#a_date')?.value||'', cls=$('#a_class')?.value||'';
    const sess=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&(!date||s.date===date));
    tag.textContent=`جلسات: ${sess.length}`;
  }
  $('#a_date')?.addEventListener('change', refreshAttendanceSummary);
  $('#a_class')?.addEventListener('change', refreshAttendanceSummary);

  // ===== إحصائيات التقارير =====
  function refreshReportStats(){
    const tag=$('#rp_stats'); if(!tag) return;
    const from=$('#rp_from')?.value||'0000-00-00';
    const to=$('#rp_to')?.value||'9999-12-31';
    const cls=$('#rp_class')?.value||'';
    const sess=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&s.date>=from&&s.date<=to);
    const entries=sess.reduce((n,s)=>n+(s.entries?.length||0),0);
    const all=(d.grades||[]).filter(g=>(!cls||g.class===cls)&&g.date>=from&&g.date<=to).map(g=>+g.total||0);
    const avg=all.length?(all.reduce((a,b)=>a+b,0)/all.length).toFixed(1):'—';
    tag.textContent=`جلسات: ${sess.length} | قيود حضور: ${entries} | متوسط الدرجات: ${avg}`;
  }
  ['rp_from','rp_to','rp_class'].forEach(id=>$('#'+id)?.addEventListener('change', refreshReportStats));
  $('#rp_print')?.addEventListener('click', ()=>window.print());

  // ===== تحليل الدرجات + تعبئة قائمة طلاب الدرجات =====
  function fillGradesStudents(){
    const sel=$('#g_student'); if(!sel) return;
    const cls=$('#g_class')?.value||'';
    const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
    sel.innerHTML=list.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join('');
  }
  $('#g_class')?.addEventListener('change', fillGradesStudents);

  function buildGradesAnalysis(){
    const box=$('#g_analysis'); if(!box) return;
    const cls=$('#g_class')?.value||'';
    const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
    const lastBy={}; [...(d.grades||[])].reverse().forEach(g=>{ if(!lastBy[g.studentId]) lastBy[g.studentId]=g; });
    const rows=list.map(s=>({ name:s.name, total:+(lastBy[s.id]?.total||0) }));
    const top=rows.slice().sort((a,b)=>b.total-a.total).slice(0,5);
    const weak=rows.filter(r=>r.total<50).sort((a,b)=>a.total-b.total).slice(0,5);
    box.style.display='block';
    box.innerHTML=`
      <h3>تحليل سريع</h3>
      <div class="grid">
        <div><strong>أعلى 5:</strong><ol>${top.map(r=>`<li>${esc(r.name)} — ${r.total}</li>`).join('')}</ol></div>
        <div><strong>بحاجة دعم (&lt;50):</strong><ol>${weak.map(r=>`<li>${esc(r.name)} — ${r.total}</li>`).join('')}</ol></div>
      </div>`;
  }
  $('#g_analyze')?.addEventListener('click', buildGradesAnalysis);

  // ===== مذكرة الطالب =====
  function sm_fillStudents(){
    const sel=$('#sm_student'); if(!sel) return;
    const list=(d.roster||[]).filter(s=>s&&s.name);
    sel.innerHTML=list.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join('');
  }
  function sm_attendanceStats(id,from,to){
    let pr=0,ab=0,lt=0,lv=0,tot=0;
    (d.attSessions||[]).forEach(ss=>{
      if(ss.date<from||ss.date>to) return;
      const e=(ss.entries||[]).find(x=>x.studentId===id); if(!e) return;
      tot++; const s=e.status;
      if(s==='حاضر') pr++; else if(s==='غائب') ab++; else if(s==='متأخر') lt++; else if(s==='استئذان') lv++;
    });
    return {present:pr, absent:ab, late:lt, leave:lv, total:tot, pct: tot?Math.round(pr/tot*100):null};
  }
  function sm_behaviorStats(id,from,to){
    let pos=0,neg=0;
    const items=(d.behavior||[]).filter(b=>b.studentId===id && b.date>=from && b.date<=to);
    items.forEach(b=>{ if(b.type==='positive') pos+=(+b.points||0); else neg+=Math.abs(+b.points||0); });
    return { pos, neg, latest: items.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,3) };
  }
  function sm_gradeStats(id,from,to){
    const rows=(d.grades||[]).filter(g=>g.studentId===id && g.date>=from && g.date<=to);
    if(!rows.length) return {best:null,last:null};
    const best=rows.slice().sort((a,b)=>(+b.total||0)-(+a.total||0))[0];
    const last=rows.slice().sort((a,b)=>b.date.localeCompare(a.date))[0];
    return {best,last};
  }
  function sm_buildText(){
    const pv=$('#sm_preview'); const sid=$('#sm_student')?.value;
    if(!pv||!sid) return;
    const stu=(d.roster||[]).find(s=>s.id===sid);
    const from=$('#sm_from')?.value||'0000-00-00', to=$('#sm_to')?.value||'9999-12-31';
    const ia=$('#sm_att')?.checked, ib=$('#sm_beh')?.checked, ig=$('#sm_grd')?.checked;
    let html=`<h2>مذكرة بشأن الطالب / ${esc(stu?.name||'')}</h2>
      <div class="meta">الصف: ${esc(stu?.class||'—')} — المدة: ${esc(from)} إلى ${esc(to)}</div>`;
    if(ia){ const A=sm_attendanceStats(sid,from,to);
      html+=`<div class="sec"><strong>أولًا: الحضور والانضباط</strong><br>
      الجلسات: ${A.total||0}. حضر: ${A.present}, غياب: ${A.absent}, تأخر: ${A.late}, استئذان: ${A.leave}.
      ${A.pct!=null?`نسبة الحضور: ${A.pct}%`:''}</div>`; }
    if(ib){ const B=sm_behaviorStats(sid,from,to);
      const latest=B.latest.map(b=>`• ${esc(b.date)} — ${b.type==='positive'?'إيجابي':'سلبي'} (${b.points||0}): ${esc(b.category||'')} — ${esc(b.note||'')}`).join('<br>');
      html+=`<div class="sec"><strong>ثانيًا: السلوكيات</strong><br>
      مجموع الإيجابي: ${B.pos}، السلبي: ${B.neg}.<br>${latest?`أحدث الملاحظات:<br>${latest}`:'لا توجد ملاحظات في هذه الفترة.'}</div>`; }
    if(ig){ const G=sm_gradeStats(sid,from,to), L=G.last||{};
      html+=`<div class="sec"><strong>ثالثًا: التحصيل الدراسي</strong><br>
      أفضل مجموع: ${G.best?(+G.best.total||0):'—'}.
      أحدث رصد: ${esc(G.last?G.last.date:'—')}
      ${G.last?` — واجبات ${+L.homework||0}/10، مهام ${+L.tasks||0}/20، مشاركة ${+L.particip||0}/10، اختبار ${+L.quiz||0}/20، نهائي ${+L.final||0}/40، المجموع ${+L.total||0}/100`:''}
      </div>`; }
    html+=`<div class="sec"><strong>خلاصة وتوصيات</strong><br>
    – متابعة الواجبات والاختبارات القصيرة.<br>
    – تعزيز السلوك الإيجابي داخل الصف.<br>
    – الحفاظ على الحضور المنتظم ومعالجة التأخر مبكرًا.<br></div>
    <div style="margin-top:18px">حرر في: ${new Date().toLocaleDateString('ar')} — توقيع المعلم: ____________</div>`;
    pv.innerHTML=html;
  }
  $('#sm_build')?.addEventListener('click', sm_buildText);
  $('#sm_print')?.addEventListener('click', ()=>window.print());
  (function(){ const t=new Date().toISOString().slice(0,10); if($('#sm_from')&&!$('#sm_from').value) $('#sm_from').value=t; if($('#sm_to')&&!$('#sm_to').value) $('#sm_to').value=t; })();

  // ===== نقاط ربط تُستدعى من كودك الحالي بعد السحب من Supabase =====
  Daybook.afterRosterChanged = function(){ try{ sm_fillStudents(); fillGradesStudents(); }catch(e){ console.warn(e); } };
  Daybook.afterAttendanceChanged = function(){ try{ refreshAttendanceSummary(); }catch(e){ console.warn(e); } };
  Daybook.afterReportFiltersChanged = function(){ try{ refreshReportStats(); }catch(e){ console.warn(e); } };

  // تشغيل أولي
  Daybook.afterRosterChanged(); Daybook.afterAttendanceChanged(); Daybook.afterReportFiltersChanged();

})();
</script>