<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>School Daybook — Supabase</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    :root{--bg:#0f2435;--ink:#111;--muted:#666;--card:#fff;--pill:#e9eef3;--accent:#16a34a}
    body{margin:0;background:#f5f7fb;color:var(--ink);font-family:"Noto Sans Arabic",system-ui,Segoe UI,Roboto}
    header{background:var(--bg);color:#fff;padding:16px 20px;font-weight:700}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .pill{background:var(--pill);border-radius:999px;padding:8px 12px;border:0;cursor:pointer}
    .pill.active{background:#dbeafe}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 16px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border-radius:14px;box-shadow:0 1px 3px #0001;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;min-width:160px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee}
    th{color:#334155;text-align:right;background:#f8fafc}
    .small{color:var(--muted);font-size:.86rem}
    .danger{background:#ef4444}
  </style>

  <!-- مكتبة Supabase (UMD) يجب أن تكون قبل سكربت التطبيق -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <script>
  // ==== الإعداد المؤكد لـ Supabase ====
  // هذه هي القيم التي زوّدتني بها:
  const SUPABASE_URL = "https://alamidjtlxuquvjvvcac.supabase.co";
  const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU";

  // نحاول إنشاء العميل بأمان حتى لو فشلت المكتبة ما يطيح الموقع.
  let sb = null;
  (function initSupabase(){
    try{
      if (window.supabase && typeof window.supabase.createClient === "function"){
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: false }, // بدون تسجيل دخول
        });
        console.log("✅ Supabase client ready");
      } else {
        console.warn("⚠️ Supabase UMD not loaded; running local-only.");
      }
    }catch(e){
      console.error("Supabase init error", e);
    }
  })();

  // ==== أدوات مساعدة بسيطة ====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // ترتيب أبجدي عربي (للعرض فقط)
  function sortArabic(list, key){
    const coll = new Intl.Collator('ar', {sensitivity:'base'});
    return list.slice().sort((a,b)=>coll.compare((a[key]||''),(b[key]||'')));
  }

  // تخزين محلي احتياطي (إذا تعطل السحابة لا يتعطل الموقع)
  const LS_KEY = "daybook_students_v2";
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return [] } }
  function saveLocal(rows){ localStorage.setItem(LS_KEY, JSON.stringify(rows||[])); }

  // حالة الواجهة
  let students = loadLocal();   // يبدأ محلياً، ثم نحاول السحب من السحابة
  let syncing = false;

  // رسم الجدول
  function renderTable(){
    const tbody = $("#students-body");
    tbody.innerHTML = "";
    // ترتيب للعرض
    const view = sortArabic(students, "name");
    view.forEach((s, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${s.name||""}</td>
        <td>${s.class_name||""}</td>
        <td>
          <button class="pill danger" type="button" data-id="${s.id||""}" data-action="del">حذف</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // إضافة طالب
  async function addStudent(){
    const name = $("#in_name").value.trim();
    const cls  = $("#in_class").value.trim();
    if(!name){ alert("أدخل اسم الطالب"); return; }

    // محلياً أولاً
    const row = { id: crypto.randomUUID(), name, class_name: cls };
    students.push(row);
    saveLocal(students);
    renderTable();

    // إلى السحابة (لو متاح)
    if(sb){
      try{
        const { error } = await sb.from("students").insert({
          id: row.id, name: row.name, class_name: row.class_name
        });
        if(error) console.warn("Insert cloud error:", error.message);
      }catch(e){ console.warn("Cloud insert exception:", e.message); }
    }
    $("#in_name").value = ""; $("#in_class").value="";
  }

  // حذف طالب
  async function deleteStudent(id){
    // محلي
    students = students.filter(s=>s.id!==id);
    saveLocal(students);
    renderTable();
    // سحابة
    if(sb){
      try{
        const { error } = await sb.from("students").delete().eq("id", id);
        if(error) console.warn("Cloud delete error:", error.message);
      }catch(e){ console.warn("Cloud delete exception:", e.message); }
    }
  }

  // مزامنة ↔️
  async function syncPull(){
    if(!sb){ alert("لا يوجد اتصال Supabase – يعمل محلياً فقط."); return; }
    if(syncing) return; syncing = true; toggleSync(true);
    try{
      const { data, error } = await sb.from("students").select("id,name,class_name");
      if(error) throw error;
      // دمج و حفظ
      const remote = data||[];
      // اختر النسخة الأحدث ببساطة (نأخذ السحابة كما هي)
      students = remote.length ? remote : students;
      saveLocal(students);
      renderTable();
      toast("تم السحب من السحابة");
    }catch(e){
      console.error(e); alert("فشل السحب من السحابة");
    }finally{ syncing=false; toggleSync(false); }
  }

  async function syncPush(){
    if(!sb){ alert("لا يوجد اتصال Supabase – يعمل محلياً فقط."); return; }
    if(syncing) return; syncing = true; toggleSync(true);
    try{
      // مسح الجدول ورفع المحلي (طريقة بسيطة مضمونة)
      await sb.from("students").delete().neq("id", "00000000-0000-0000-0000-000000000000");
      if(students.length){
        const { error } = await sb.from("students").insert(students.map(s=>({
          id:s.id, name:s.name, class_name:s.class_name
        })));
        if(error) throw error;
      }
      toast("تم رفع المحلي للسحابة");
    }catch(e){
      console.error(e); alert("فشل الرفع للسحابة");
    }finally{ syncing=false; toggleSync(false); }
  }

  function toggleSync(busy){
    const btn = $("#btnSync");
    btn.disabled = !!busy;
    btn.textContent = busy ? "…Sync" : "Sync ↕";
  }
  function toast(msg){
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.cssText="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;z-index:9999";
    document.body.appendChild(el); setTimeout(()=>el.remove(),1600);
  }

  // ربط الأحداث بعد تحميل DOM
  document.addEventListener("DOMContentLoaded", ()=>{
    // أزرار التبويب شكل فقط (أمثلة)
    $$(".pill.tab").forEach(b=>{
      b.addEventListener("click",()=>{$$(".pill.tab").forEach(x=>x.classList.remove("active")); b.classList.add("active")});
    });

    // إضافة طالب
    $("#btnAdd").addEventListener("click", addStudent);

    // حذف من الجدول (تفويض)
    $("#students-body").addEventListener("click", e=>{
      const t = e.target;
      if(t && t.dataset && t.dataset.action==="del"){
        const id = t.dataset.id; if(id) deleteStudent(id);
      }
    });

    // مزامنة
    $("#btnSync").addEventListener("click", async ()=>{
      // ضغطه قصيرة = سحب، مع Shift = رفع
      if(event.shiftKey) await syncPush(); else await syncPull();
    });

    // حاول سحب مبدئي إذا العميل جاهز
    if(sb) syncPull();
    renderTable();
  });
  </script>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
      <div>School Daybook — Supabase</div>
      <button id="btnSync" class="btn" type="button">Sync ↕</button>
    </div>
  </header>

  <main class="wrap" id="app">
    <!-- شريط تبويب بسيط (للتوافق مع بقية الصفحات عندك) -->
    <div class="bar">
      <button class="pill tab active" type="button">الطلاب</button>
      <button class="pill tab" type="button">الحضور</button>
      <button class="pill tab" type="button">السلوك</button>
      <button class="pill tab" type="button">الدرجات</button>
      <button class="pill tab" type="button">التقارير</button>
      <button class="pill tab" type="button">المرفقات</button>
    </div>

    <section class="card">
      <h3>إدارة الطلاب</h3>
      <div class="row" style="margin:8px 0">
        <input id="in_class"  placeholder="الصف/الشعبة: مثال ٦/أ">
        <input id="in_name"   placeholder="اسم الطالب">
        <button id="btnAdd" class="btn" type="button">إضافة</button>
      </div>
      <div class="small">* الترتيب أبجدي عربي في العرض فقط</div>

      <div class="card" style="padding:0;margin-top:12px">
        <table>
          <thead>
            <tr><th>#</th><th>الاسم</th><th>الصف</th><th>إجراءات</th></tr>
          </thead>
          <tbody id="students-body"></tbody>
        </table>
      </div>
    </section>
  </main>
</body>
</html>
