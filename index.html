<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <title>School Daybook โ iPad Ready</title>

  <!-- ูุงููููู (ุงุฎุชูุงุฑู) -->
  <link rel="icon" href="favicon.png" type="image/png"/>

  <!-- ููุท ุจุณูุท -->
  <style>
    :root{--ink:#0b2239;--bg:#f5f7fb;--muted:#6b7280;--ok:#10b981;--danger:#ef4444;--tab:#e5e7eb;}
    html,body{margin:0;padding:0;background:var(--bg);color:#111;font-family:"Noto Sans Arabic",system-ui,AppleSystem,Segoe UI,Roboto,Arial;}
    header{background:#0f172a;color:#fff;padding:14px 18px;font-weight:700;border-bottom:3px solid #111827;}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .tabs button{background:var(--tab);border:1px solid #cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer}
    .tabs button.active{background:#c7d2fe;border-color:#6366f1;font-weight:700}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    input,select,button{font-size:15px}
    input,select{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    .btn.primary{background:#22c55e;color:#fff;border-color:#16a34a}
    .btn.warn{background:#fee2e2;border-color:#fecaca}
    .btn.danger{background:#ef4444;color:#fff;border-color:#b91c1c}
    .btn.ghost{background:#f3f4f6}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px;text-align:start}
    th{background:#f8fafc}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
    .right{margin-inline-start:auto}
  </style>

  <!-- Babel: ูุถูู ุงูุชูุงูู ุนูู iPad ูุงููุชุตูุญุงุช ุงููุฏููุฉ -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Supabase (ุงุฎุชูุงุฑู ูููุฑููุงุช/ุงูุณุญุงุจุฉ) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header>School Daybook โ Supabase + iPad</header>
  <div class="wrap">
    <div class="toolbar">
      <button id="btnSyncPull" class="btn">โญณ ุณุญุจ ูู ุงูุณุญุงุจุฉ</button>
      <button id="btnSyncPush" class="btn">โญฑ ุฑูุน ููุณุญุงุจุฉ</button>
      <span class="muted">ุงูุญูุธ ูุญูููุง ูุชู ุชููุงุฆููุง</span>
      <span class="right muted" id="status"></span>
    </div>

    <div class="tabs">
      <button data-tab="students" class="active">ุงูุทูุงุจ</button>
      <button data-tab="attendance">ุงูุญุถูุฑ</button>
      <button data-tab="behavior">ุงูุณููู</button>
      <button data-tab="grades">ุงูุฏุฑุฌุงุช</button>
      <button data-tab="reports">ุงูุชูุงุฑูุฑ</button>
      <button data-tab="attachments">ุงููุฑููุงุช</button>
      <button data-tab="settings">ุงูุฅุนุฏุงุฏุงุช</button>
    </div>

    <!-- ุงูุทูุงุจ -->
    <section id="tab-students" class="card">
      <div class="row">
        <input id="inName" placeholder="ุงุณู ุงูุทุงูุจ ูุซุงู: ูุญูุฏ ุฃุญูุฏ"/>
        <input id="inCode" placeholder="ุงููุนุฑูู (ุงุฎุชูุงุฑู)"/>
        <input id="inClass" placeholder="ุงูุตู/ุงูุดุนุจุฉ ูุซุงู: 6/ุจ"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnAddStudent" class="btn primary">ุฅุถุงูุฉ</button>
        <input id="searchName" class="right" placeholder="...ุงุจุญุซ ูู ุงูุฃุณูุงุก"/>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th style="width:60px">#</th><th>ุงูุงุณู</th><th>ุงููุนุฑู</th><th>ุงูุตู/ุงูุดุนุจุฉ</th><th style="width:160px">ุฅุฌุฑุงุกุงุช</th></tr></thead>
          <tbody id="tblStudents"></tbody>
        </table>
      </div>
    </section>

    <!-- ุงูุญุถูุฑ -->
    <section id="tab-attendance" class="card" hidden>
      <div class="row">
        <select id="selStudentA"></select>
        <input id="inDateA" type="date"/>
        <select id="selStatusA">
          <option value="present">ุญุงุถุฑ</option>
          <option value="absent">ุบุงุฆุจ</option>
          <option value="late">ูุชุฃุฎุฑ</option>
          <option value="excused">ูุณุชุฃุฐู</option>
        </select>
        <select id="selPeriodA" title="ุฑูู ุงูุญุตุฉ">
          <option value="1">ุงูุญุตุฉ 1</option><option value="2">ุงูุญุตุฉ 2</option>
          <option value="3">ุงูุญุตุฉ 3</option><option value="4">ุงูุญุตุฉ 4</option>
          <option value="5">ุงูุญุตุฉ 5</option><option value="6">ุงูุญุตุฉ 6</option>
          <option value="7">ุงูุญุตุฉ 7</option>
        </select>
        <input id="inNotesA" placeholder="ููุงุญุธุงุช"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnAddA" class="btn primary">ุญูุธ ุงูุญุถูุฑ</button>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th style="width:60px">#</th><th>ุงูุทุงูุจ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุญุตุฉ</th><th>ุงูุญุงูุฉ</th><th>ููุงุญุธุงุช</th><th style="width:100px">ุญุฐู</th></tr></thead>
          <tbody id="tblA"></tbody>
        </table>
      </div>
    </section>

    <!-- ุงูุณููู -->
    <section id="tab-behavior" class="card" hidden>
      <div class="row">
        <select id="selStudentB"></select>
        <input id="inDateB" type="date"/>
        <select id="selTypeB">
          <option value="positive">ุฅูุฌุงุจู</option>
          <option value="negative">ุณูุจู</option>
        </select>
        <select id="selPeriodB" title="ุฑูู ุงูุญุตุฉ">
          <option value="1">ุงูุญุตุฉ 1</option><option value="2">ุงูุญุตุฉ 2</option>
          <option value="3">ุงูุญุตุฉ 3</option><option value="4">ุงูุญุตุฉ 4</option>
          <option value="5">ุงูุญุตุฉ 5</option><option value="6">ุงูุญุตุฉ 6</option>
          <option value="7">ุงูุญุตุฉ 7</option>
        </select>
        <input id="inPointsB" type="number" step="1" placeholder="ููุงุท (ูุซุงู +2 ุฃู -1)"/>
        <input id="inNotesB" placeholder="ููุงุญุธุงุช"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnAddB" class="btn primary">ุญูุธ ุงูุณููู</button>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th style="width:60px">#</th><th>ุงูุทุงูุจ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุญุตุฉ</th><th>ุงูููุน</th><th>ุงูููุงุท</th><th>ููุงุญุธุงุช</th><th style="width:100px">ุญุฐู</th></tr></thead>
          <tbody id="tblB"></tbody>
        </table>
      </div>
    </section>

    <!-- ุงูุฏุฑุฌุงุช (ูุฎุชุตุฑุ ูุงุจู ููุชูุณุนุฉ) -->
    <section id="tab-grades" class="card" hidden>
      <div class="row">
        <select id="selStudentG"></select>
        <select id="selItemG">
          <option value="participation">ูุดุงุฑูุฉ (10)</option>
          <option value="homework">ูุงุฌุจุงุช (10)</option>
          <option value="tasks">ููุงู ุฃุฏุงุฆูุฉ (20)</option>
          <option value="quiz">ุงุฎุชุจุงุฑ ูุตูุฑ (20)</option>
          <option value="final">ุงุฎุชุจุงุฑ ููุงุฆู (40)</option>
        </select>
        <input id="inScoreG" type="number" step="0.5" placeholder="ุงูุฏุฑุฌุฉ"/>
        <input id="inNotesG" placeholder="ููุงุญุธุฉ (ุงุฎุชูุงุฑู)"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnAddG" class="btn primary">ุญูุธ ุงูุฏุฑุฌุฉ</button>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th style="width:60px">#</th><th>ุงูุทุงูุจ</th><th>ุงูุจูุฏ</th><th>ุงูุฏุฑุฌุฉ</th><th>ููุงุญุธุฉ</th><th style="width:100px">ุญุฐู</th></tr></thead>
          <tbody id="tblG"></tbody>
        </table>
      </div>
    </section>

    <!-- ุงูุชูุงุฑูุฑ (ุณุฑูุน) -->
    <section id="tab-reports" class="card" hidden>
      <div class="row">
        <select id="selStudentR"></select>
        <input id="inReportMsg" placeholder="ูุต ุงูููุงุญุธุฉ/ุงูุชูุฑูุฑ"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnPrintR" class="btn">๐จ๏ธ ุทุจุงุนุฉ ุชูุฑูุฑ</button>
      </div>
      <div id="reportPreview" class="card" style="display:none"></div>
    </section>

    <!-- ุงููุฑููุงุช -->
    <section id="tab-attachments" class="card" hidden>
      <div class="row">
        <select id="selStudentFiles"></select>
        <input id="inFile" type="file"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnUpload" class="btn primary">ุฑูุน ููู</button>
        <span class="muted">ุชูุฑูุน ุฅูู Bucket: <code>student-docs</code></span>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th style="width:60px">#</th><th>ุงูุงุณู/ุงูููุน</th><th>ุงูุญุฌู</th><th>ุงูุชุงุฑูุฎ</th><th>ุฑุงุจุท</th><th style="width:100px">ุญุฐู</th></tr></thead>
          <tbody id="tblFiles"></tbody>
        </table>
      </div>
    </section>

    <!-- ุงูุฅุนุฏุงุฏุงุช -->
    <section id="tab-settings" class="card" hidden>
      <div class="row">
        <input id="inSupabaseUrl" placeholder="SUPABASE_URL"/>
        <input id="inSupabaseAnon" placeholder="SUPABASE_ANON_KEY"/>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnSaveSettings" class="btn primary">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
        <button id="btnClearData" class="btn danger">ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ</button>
      </div>
      <div class="muted" style="margin-top:6px">ุฅุฐุง ุชูุฑูุช ุงูุฅุนุฏุงุฏุงุช ูุงุฑุบุฉ ูุนูู ุงููููุน ูุญูููุง ููุท.</div>
    </section>
  </div>

  <!-- ุชุทุจูู: ES5 ุนุจุฑ Babel ูุถูุงู ุงูุชูุงูู -->
  <script type="text/babel"
    data-presets="env"
    data-plugins="proposal-logical-assignment-operators,proposal-optional-chaining,proposal-nullish-coalescing-operator">
/* ========= ุญุงูุฉ ุงูุชุทุจูู ========= */
var LS_KEY = 'daybook_cloud_v1';
var state = {
  students: [],
  attendance: [],
  behavior: [],
  grades: [],
  files: [],
  settings: { supabaseUrl:'', supabaseAnon:'' }
};
var sb = null; // supabase client (ุงุฎุชูุงุฑู)

/* ========= ุฃุฏูุงุช ุนุงูุฉ ========= */
function $(id){ return document.getElementById(id); }
function toast(msg){ $('status').textContent = msg; setTimeout(function(){ $('status').textContent=''; }, 2500); }
function sortArabicNames(list){
  list.sort(function(a,b){
    var an=(a.name||'').trim(), bn=(b.name||'').trim();
    return an.localeCompare(bn,'ar',{sensitivity:'base',numeric:true});
  });
}
function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
}
function loadLocal(){
  var s = localStorage.getItem(LS_KEY);
  if(!s) return;
  try{
    var obj = JSON.parse(s);
    state = Object.assign(state, obj||{});
  }catch(e){}
}
function refreshAll(){
  renderStudents();
  fillStudentSelects();
  renderAttendance();
  renderBehavior();
  renderGrades();
  renderFiles();
}

/* ========= ุชุจููุจุงุช ========= */
Array.prototype.forEach.call(document.querySelectorAll('.tabs button'), function(btn){
  btn.addEventListener('click', function(){
    Array.prototype.forEach.call(document.querySelectorAll('.tabs button'), function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    var t = btn.getAttribute('data-tab');
    Array.prototype.forEach.call(document.querySelectorAll('section[id^="tab-"]'), function(sec){
      sec.hidden = (sec.id !== 'tab-'+t);
    });
  });
});

/* ========= ุงูุทูุงุจ ========= */
function renderStudents(){
  sortArabicNames(state.students);
  var q = ($('searchName').value||'').trim();
  var list = state.students.filter(function(s){ return !q || (s.name||'').indexOf(q) !== -1; });
  var html = list.map(function(s,i){
    return '<tr>'+
      '<td>'+(i+1)+'</td>'+
      '<td>'+escapeHtml(s.name)+'</td>'+
      '<td>'+(s.code||'')+'</td>'+
      '<td>'+(s.classroom||'')+'</td>'+
      '<td>'+
        '<button class="btn ghost" data-edit="'+s.id+'">ุชุนุฏูู</button> '+
        '<button class="btn warn" data-del="'+s.id+'">ุญุฐู</button>'+
      '</td>'+
    '</tr>';
  }).join('');
  $('tblStudents').innerHTML = html;
  // ุฑุจุท ุฃุฒุฑุงุฑ
  Array.prototype.forEach.call(document.querySelectorAll('[data-del]'), function(b){
    b.onclick = function(){
      var id = b.getAttribute('data-del');
      state.students = state.students.filter(function(x){ return x.id!==id; });
      saveLocal(); refreshAll();
    };
  });
  Array.prototype.forEach.call(document.querySelectorAll('[data-edit]'), function(b){
    b.onclick = function(){
      var id = b.getAttribute('data-edit');
      var s = state.students.find(function(x){return x.id===id;});
      if(!s) return;
      $('inName').value = s.name||'';
      $('inCode').value = s.code||'';
      $('inClass').value = s.classroom||'';
      // ุนูุฏ ุงูุถุบุท "ุฅุถุงูุฉ" ุณูุชู ุงูุชุนุฏูู ูุฃู ููุณ ุงูููู
    };
  });
}
$('btnAddStudent').onclick = function(){
  var name = $('inName').value.trim();
  if(!name){ toast('ุงูุชุจ ุงูุงุณู'); return; }
  var code = $('inCode').value.trim();
  var classroom = $('inClass').value.trim();
  // ูู ุงูุงุณู ููุฌูุฏ ุจุชุนุฏูู ูููููู
  var ex = state.students.find(function(s){return s.name===name;});
  if(ex){
    ex.code=code; ex.classroom=classroom;
  }else{
    state.students.push({ id:genId(), name:name, code:code, classroom:classroom });
  }
  $('inName').value=''; $('inCode').value=''; $('inClass').value='';
  saveLocal(); refreshAll();
};
$('searchName').oninput = renderStudents;

function fillStudentSelects(){
  var opts = state.students.map(function(s){ return '<option value="'+s.id+'">'+escapeHtml(s.name)+' ('+(s.classroom||'')+')</option>'; }).join('');
  ['selStudentA','selStudentB','selStudentG','selStudentR','selStudentFiles'].forEach(function(id){
    $(id).innerHTML = opts;
  });
}

/* ========= ุงูุญุถูุฑ ========= */
function renderAttendance(){
  var html = state.attendance.map(function(r,i){
    var stu = state.students.find(function(s){return s.id===r.student_id;});
    return '<tr>'+
      '<td>'+(i+1)+'</td>'+
      '<td>'+(stu?escapeHtml(stu.name):'โ')+'</td>'+
      '<td>'+r.date+'</td>'+
      '<td>'+(r.period||'')+'</td>'+
      '<td>'+mapStatus(r.status)+'</td>'+
      '<td>'+(r.notes||'')+'</td>'+
      '<td><button class="btn warn" data-del-a="'+r.id+'">ุญุฐู</button></td>'+
    '</tr>';
  }).join('');
  $('tblA').innerHTML = html;
  Array.prototype.forEach.call(document.querySelectorAll('[data-del-a]'), function(b){
    b.onclick = function(){
      var id = b.getAttribute('data-del-a');
      state.attendance = state.attendance.filter(function(x){return x.id!==id;});
      saveLocal(); renderAttendance();
    };
  });
}
$('btnAddA').onclick = function(){
  var st = $('selStudentA').value;
  if(!st){ toast('ุงุฎุชุฑ ุงูุทุงูุจ'); return; }
  var date = $('inDateA').value || today();
  var status = $('selStatusA').value;
  var period = parseInt($('selPeriodA').value,10) || 1;
  var notes = $('inNotesA').value.trim();
  state.attendance.push({ id:genId(), student_id:st, date:date, status:status, period:period, notes:notes });
  saveLocal(); renderAttendance();
};

/* ========= ุงูุณููู ========= */
function renderBehavior(){
  var html = state.behavior.map(function(r,i){
    var stu = state.students.find(function(s){return s.id===r.student_id;});
    return '<tr>'+
      '<td>'+(i+1)+'</td>'+
      '<td>'+(stu?escapeHtml(stu.name):'โ')+'</td>'+
      '<td>'+r.date+'</td>'+
      '<td>'+(r.period||'')+'</td>'+
      '<td>'+(r.type==='positive'?'ุฅูุฌุงุจู':'ุณูุจู')+'</td>'+
      '<td>'+(r.points||0)+'</td>'+
      '<td>'+(r.notes||'')+'</td>'+
      '<td><button class="btn warn" data-del-b="'+r.id+'">ุญุฐู</button></td>'+
    '</tr>';
  }).join('');
  $('tblB').innerHTML = html;
  Array.prototype.forEach.call(document.querySelectorAll('[data-del-b]'), function(b){
    b.onclick = function(){
      var id = b.getAttribute('data-del-b');
      state.behavior = state.behavior.filter(function(x){return x.id!==id;});
      saveLocal(); renderBehavior();
    };
  });
}
$('btnAddB').onclick = function(){
  var st = $('selStudentB').value;
  if(!st){ toast('ุงุฎุชุฑ ุงูุทุงูุจ'); return; }
  var date = $('inDateB').value || today();
  var type = $('selTypeB').value;
  var period = parseInt($('selPeriodB').value,10) || 1;
  var points = parseInt($('inPointsB').value||'0',10);
  var notes = $('inNotesB').value.trim();
  state.behavior.push({ id:genId(), student_id:st, date:date, type:type, period:period, points:points, notes:notes });
  saveLocal(); renderBehavior();
};

/* ========= ุงูุฏุฑุฌุงุช (ูุฎุชุตุฑ) ========= */
function renderGrades(){
  var html = state.grades.map(function(r,i){
    var stu = state.students.find(function(s){return s.id===r.student_id;});
    return '<tr>'+
      '<td>'+(i+1)+'</td>'+
      '<td>'+(stu?escapeHtml(stu.name):'โ')+'</td>'+
      '<td>'+mapItem(r.item)+'</td>'+
      '<td>'+r.score+'</td>'+
      '<td>'+(r.notes||'')+'</td>'+
      '<td><button class="btn warn" data-del-g="'+r.id+'">ุญุฐู</button></td>'+
    '</tr>';
  }).join('');
  $('tblG').innerHTML = html;
  Array.prototype.forEach.call(document.querySelectorAll('[data-del-g]'), function(b){
    b.onclick = function(){
      var id = b.getAttribute('data-del-g');
      state.grades = state.grades.filter(function(x){return x.id!==id;});
      saveLocal(); renderGrades();
    };
  });
}
$('btnAddG').onclick = function(){
  var st = $('selStudentG').value;
  if(!st){ toast('ุงุฎุชุฑ ุงูุทุงูุจ'); return; }
  var item = $('selItemG').value;
  var score = parseFloat($('inScoreG').value||'0');
  var notes = $('inNotesG').value.trim();
  state.grades.push({ id:genId(), student_id:st, item:item, score:score, notes:notes });
  saveLocal(); renderGrades();
};

/* ========= ุงูุชูุงุฑูุฑ ========= */
$('btnPrintR').onclick = function(){
  var sid = $('selStudentR').value;
  if(!sid){ toast('ุงุฎุชุฑ ุงูุทุงูุจ'); return; }
  var stu = state.students.find(function(s){return s.id===sid;});
  var msg = $('inReportMsg').value || 'โ';
  var html = '<h3>ุชูุฑูุฑ ูุชุงุจุนุฉ</h3>'+
             '<p><b>ุงูุทุงูุจ:</b> '+escapeHtml(stu.name)+' โ '+(stu.classroom||'')+'</p>'+
             '<p>'+escapeHtml(msg)+'</p>';
  $('reportPreview').style.display='block';
  $('reportPreview').innerHTML = html;
  window.print();
};

/* ========= ุงููุฑููุงุช + Supabase ========= */
function supaReady(){
  var u = (state.settings||{}).supabaseUrl||'';
  var k = (state.settings||{}).supabaseAnon||'';
  if(!u || !k) return false;
  try{ sb = supabase.createClient(u,k); return true; }catch(e){ sb=null; return false; }
}
async function ensureBucket(){
  if(!supaReady()) return;
  try{
    var r = await sb.storage.listBuckets();
    var ok = (r.data||[]).some(function(b){return b.name==='student-docs';});
    if(!ok){ await sb.storage.createBucket('student-docs',{public:true}); }
  }catch(e){ console.log('bucket',e); }
}
async function ensureStudentOnCloud(stu){
  if(!supaReady() || !stu) return;
  try{
    var q = await sb.from('students').select('id').eq('id',stu.id).maybeSingle();
    if(!q.data){ await sb.from('students').insert({id:stu.id, name:stu.name, grade:stu.classroom, section:stu.classroom}); }
  }catch(e){ console.log('ensure student',e); }
}
function renderFiles(){
  var html = state.files.map(function(f,i){
    return '<tr>'+
      '<td>'+(i+1)+'</td>'+
      '<td>'+escapeHtml(f.name)+'</td>'+
      '<td>'+humanSize(f.size)+'</td>'+
      '<td>'+ (f.created_at||'') +'</td>'+
      '<td>'+(f.url?('<a href="'+f.url+'" target="_blank">ูุชุญ</a>'):'โ')+'</td>'+
      '<td><button class="btn warn" data-del-file="'+(f.id||'')+'">ุญุฐู</button></td>'+
    '</tr>';
  }).join('');
  $('tblFiles').innerHTML = html;
  Array.prototype.forEach.call(document.querySelectorAll('[data-del-file]'), function(b){
    b.onclick = function(){
      var id=b.getAttribute('data-del-file');
      state.files = state.files.filter(function(x){return (x.id||'')!==id;});
      saveLocal(); renderFiles();
    };
  });
}
$('btnUpload').onclick = async function(){
  var sid = $('selStudentFiles').value;
  var stu = state.students.find(function(s){return s.id===sid;});
  var f = $('inFile').files[0];
  if(!sid || !f){ toast('ุงุฎุชุฑ ุงูุทุงูุจ ูุงูููู'); return; }
  // ูุญูููุง ูุณุฌูู ููุทุ ูุฅู ุชููุฑุช ุณูุจุงุจูุณ ูุฑูุน
  var entry = { id:genId(), student_id:sid, name:f.name, size:f.size, created_at:now() };
  try{
    if(supaReady()){
      await ensureBucket(); await ensureStudentOnCloud(stu);
      var path = sid+'/'+Date.now()+'_'+sanitizeName(f.name);
      var up = await sb.storage.from('student-docs').upload(path, f, { upsert:false });
      if(!up.error){
        var pub = sb.storage.from('student-docs').getPublicUrl(path);
        entry.url = (pub.data && pub.data.publicUrl) || '';
        // ุงุฎุชูุงุฑู: ุณุฌูู ูู ุฌุฏูู attachments ุฅู ููุฌุฏ
        try{
          await sb.from('attachments').insert({
            id: entry.id, student_id: sid, name: f.name, size: f.size, url: entry.url, created_at: new Date().toISOString()
          });
        }catch(_){}
      }
    }
  }catch(e){ console.log('upload',e); }
  state.files.push(entry);
  saveLocal(); renderFiles();
};

/* ========= ุงูุฅุนุฏุงุฏุงุช ========= */
$('btnSaveSettings').onclick = function(){
  state.settings.supabaseUrl = $('inSupabaseUrl').value.trim();
  state.settings.supabaseAnon = $('inSupabaseAnon').value.trim();
  saveLocal(); toast('ุญููุธุช ุงูุฅุนุฏุงุฏุงุช'); ensureBucket();
};
$('btnClearData').onclick = function(){
  if(!confirm('ูุชุฃูุฏ ูู ุญุฐู ูู ุงูุจูุงูุงุช ุงููุญููุฉุ')) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
};

/* ========= ูุฒุงููุฉ (ุดูููุฉ) ========= */
$('btnSyncPull').onclick = function(){
  // ููุงููุง ุณูุจุงุจูุณ ูู ุฃุฑุฏุช ูุงุญููุง. ุญุงูููุง ููุท ูู LocalStorage (ุชู).
  toast('ุงููุถุน ุงูุญุงูู ูุญูู. ูุง ุชูุฌุฏ ูุฒุงููุฉ ุณุญุงุจูุฉ ุจุฏูู ููุงุชูุญ Supabase.');
};
$('btnSyncPush').onclick = function(){
  toast('ุงููุถุน ุงูุญุงูู ูุญูู. ูุง ุชูุฌุฏ ูุฒุงููุฉ ุณุญุงุจูุฉ ุจุฏูู ููุงุชูุญ Supabase.');
};

/* ========= ุฃุฏูุงุช ูุณุงุนุฏุฉ ========= */
function mapStatus(s){
  return {present:'ุญุงุถุฑ',absent:'ุบุงุฆุจ',late:'ูุชุฃุฎุฑ',excused:'ูุณุชุฃุฐู'}[s] || s;
}
function mapItem(x){
  return {
    participation:'ูุดุงุฑูุฉ',homework:'ูุงุฌุจุงุช',tasks:'ููุงู ุฃุฏุงุฆูุฉ',quiz:'ุงุฎุชุจุงุฑ ูุตูุฑ',final:'ุงุฎุชุจุงุฑ ููุงุฆู'
  }[x] || x;
}
function genId(){ return 'id'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
function today(){ var d=new Date(); return d.toISOString().slice(0,10); }
function now(){ return new Date().toISOString().replace('T',' ').slice(0,19); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);}); }
function humanSize(n){ if(!n&&n!==0) return 'โ'; var u=['B','KB','MB','GB']; var i=0; while(n>1024 && i<u.length-1){ n/=1024;i++; } return n.toFixed( (i?1:0) )+' '+u[i]; }
function sanitizeName(s){ return (s||'').replace(/[^\u0600-\u06FF\w.\-]+/g,'_'); }

/* ========= ุฅููุงุน ========= */
(function boot(){
  loadLocal();
  $('inSupabaseUrl').value = (state.settings||{}).supabaseUrl||'';
  $('inSupabaseAnon').value = (state.settings||{}).supabaseAnon||'';
  refreshAll();
  ensureBucket(); // ุฅู ููุฌุฏุช ููุงุชูุญ ุณูุจุงุจูุณ
})();
  </script>
</body>
</html>
