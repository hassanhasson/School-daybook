<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <!DOCTYPE html>
<html lang="ar">
<head>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Daybook</title>

  <!-- أيقونة الموقع -->
  <link rel="icon" href="favicon.png" type="image/png">

  <!-- بقية روابط CSS أو مكتبات -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  ...
</body>
</html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>School Daybook — Final (No-Auth)</title>
<meta name="theme-color" content="#0ea5e9">
<style>
:root{--bg:#0f172a;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--card:#fff;--primary:#0ea5e9;--ok:#10b981;--warn:#ef4444}
*{box-sizing:border-box}html,body{margin:0;background:#f1f5f9;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans Arabic',sans-serif}
header{background:var(--bg);color:#fff;padding:12px 16px}header h1{margin:0 0 4px;font-size:18px}#sync{font-size:12px;opacity:.8}
nav{display:flex;gap:6px;flex-wrap:wrap;background:#e2e8f0;padding:8px 12px}
nav button{border:0;background:#cbd5e1;padding:8px 12px;border-radius:8px;cursor:pointer}
nav button.active{background:#fff}
main{padding:12px}
.panel{display:none}.panel.active{display:block}
.section{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}.grid .wide{grid-column:1/-1}
.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:10px;background:#fff;overflow:hidden}
.table th,.table td{padding:8px;border-bottom:1px solid var(--line);font-size:14px;text-align:right}
.table thead th{background:#f8fafc}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.controls button,.controls label.import{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.secondary{background:var(--ok);color:#fff;border-color:var(--ok)}
.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
.badge{display:inline-block;padding:3px 8px;border-radius:99px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
small.muted{color:var(--muted)}
a.btn{padding:4px 8px;border:1px solid var(--line);border-radius:6px;text-decoration:none}
.memo-doc{background:#fff;border:1px solid var(--line);border-radius:8px;padding:16px;min-height:220px;line-height:1.9;font-size:15px}
.memo-doc h2{margin:0 0 8px;font-size:18px}.memo-doc .meta{color:#475569;margin-bottom:10px}.memo-doc .sec{margin:10px 0}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
@media print{header,nav,.controls,.section:not(.printable){display:none !important}body{background:#fff}.section{border:none}@page{size:A4;margin:12mm}}
/* خطأ غير قاتل */
#errToast{position:fixed;bottom:12px;left:12px;max-width:90vw;background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:.95;display:none;z-index:9999}
</style>
</head>
<body>
<header>
  <h1>School Daybook — Final (No-Auth)</h1>
  <div id="sync">جاهز</div>
</header>

<nav id="tabs">
  <button data-tab="students" class="active">الطلاب</button>
  <button data-tab="attendance">الحضور</button>
  <button data-tab="behavior">السلوك</button>
  <button data-tab="grades">الدرجات</button>
  <button data-tab="reports">التقارير</button>
  <button data-tab="memo">مذكرة الطالب</button>
  <button data-tab="settings">إعدادات</button>
  <span style="flex:1"></span>
  <button id="syncAll" class="secondary">Sync ↕︎</button>
</nav>

<main>

  <!-- الطلاب -->
  <section id="panel-students" class="panel active">
    <div class="section">
      <div class="grid">
        <label>اسم الطالب<input id="st_name" placeholder="مثال: محمد الأحمد"></label>
        <label>المعرّف (اختياري)<input id="st_code" placeholder="إن وجد"></label>
        <label>الصف/الشعبة<input id="st_class" placeholder="مثال: 3/ب"></label>
        <div class="wide controls">
          <button id="st_add" class="primary">إضافة</button>
          <button id="st_pull">سحب من السحابة</button>
          <button id="st_push">رفع للسحابة</button>
          <label class="import">استيراد CSV<input type="file" id="st_csv" accept=".csv,text/csv"></label>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="controls">
        <input id="st_search" placeholder="بحث في الأسماء..." style="flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:8px">
      </div>
      <table class="table" id="st_table">
        <thead><tr><th>#</th><th>الاسم</th><th>المعرف</th><th>الصف/الشعبة</th><th>إجراءات</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h3 style="margin:0 0 8px">مرفقات الطالب</h3>
      <div class="grid">
        <label>اختر الطالب<select id="st_for_upload"></select></label>
        <label>اختر ملفًا<input type="file" id="st_file"></label>
        <div class="wide controls">
          <button id="st_upload" class="primary">رفع الملف</button>
          <button id="st_list">تحديث قائمة الملفات</button>
        </div>
      </div>
      <table class="table" id="files_table">
        <thead><tr><th>#</th><th>النوع/الاسم</th><th>الحجم</th><th>التاريخ</th><th>رابط</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
      <small class="muted">تُرفع إلى Bucket <code>student-docs</code>. لو ظهر “Bucket not found” أنشئه من Supabase ▸ Storage.</small>
    </div>
  </section>

  <!-- الحضور -->
  <section id="panel-attendance" class="panel">
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="a_class"></select></label>
        <label>التاريخ<input type="date" id="a_date"></label>
      </div>
      <div class="controls">
        <button id="all_present">الكل حاضر</button>
        <button id="all_absent">الكل غائب</button>
        <button id="toggle_pa">قلب</button>
        <button id="a_save" class="primary">حفظ الجلسة</button>
        <button id="a_pull">سحب</button>
        <button id="a_push">رفع</button>
        <span id="a_sumBadge" class="badge" style="margin-inline-start:auto">جلسات: 0</span>
      </div>
      <table class="table" id="a_table">
        <thead><tr><th>#</th><th>الطالب</th><th>الحالة</th><th>ملاحظة</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- السلوك -->
  <section id="panel-behavior" class="panel">
    <div class="section">
      <div class="grid">
        <label>التاريخ<input type="date" id="b_date"></label>
        <label>الطالب<select id="b_student"></select></label>
        <label>النوع
          <select id="b_type"><option value="positive">إيجابي</option><option value="negative">سلبي</option></select>
        </label>
        <label>الفئة<input id="b_cat" placeholder="انضباط/تعاون.."></label>
        <label>النقاط<input type="number" id="b_points" value="1"></label>
        <label class="wide">ملاحظة<textarea id="b_note" rows="2"></textarea></label>
        <div class="wide controls">
          <button id="b_add" class="primary">إضافة</button>
          <button id="b_pull">سحب</button>
          <button id="b_push">رفع</button>
        </div>
      </div>
    </div>
    <div class="section">
      <table class="table" id="b_table">
        <thead><tr><th>#</th><th>التاريخ</th><th>الطالب</th><th>النوع</th><th>الفئة</th><th>النقاط</th><th>ملاحظة</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- الدرجات -->
  <section id="panel-grades" class="panel">
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="g_class"></select></label>
        <label>التاريخ<input type="date" id="g_date"></label>
      </div>
      <table class="table" id="g_table">
        <thead><tr>
          <th>#</th><th>الطالب</th>
          <th>واجبات (10)</th><th>مهام (20)</th><th>مشاركة (10)</th><th>اختبار قصير (20)</th><th>نهائي (40)</th><th>المجموع</th>
        </tr></thead><tbody></tbody>
      </table>
      <div class="controls">
        <button id="g_save" class="primary">حفظ</button>
        <button id="g_pull">سحب</button>
        <button id="g_push">رفع</button>
        <button id="g_analyze">تحليل سريع</button>
      </div>
      <div id="g_analysis" class="section" style="display:none"></div>
    </div>
  </section>

  <!-- التقارير -->
  <section id="panel-reports" class="panel">
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="rp_class"></select></label>
        <label>من<input type="date" id="rp_from"></label>
        <label>إلى<input type="date" id="rp_to"></label>
        <div class="wide controls">
          <button id="rp_run" class="primary">توليد تقرير</button>
          <button id="rp_print">طباعة</button>
          <span id="rp_stats" class="badge" style="margin-inline-start:auto">—</span>
        </div>
      </div>
      <div class="section printable" style="margin-top:0">
        <table class="table" id="rp_table">
          <thead><tr><th>#</th><th>الطالب</th><th>حضور</th><th>غياب</th><th>استئذان</th><th>إيجابي</th><th>سلبي</th><th>أعلى مجموع</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- مذكرة الطالب -->
  <section id="panel-memo" class="panel">
    <div class="section">
      <h3 style="margin:0 0 8px">مذكرة الطالب</h3>
      <div class="grid">
        <label>الطالب<select id="sm_student"></select></label>
        <label>من<input type="date" id="sm_from"></label>
        <label>إلى<input type="date" id="sm_to"></label>
        <div class="wide">
          <label class="badge"><input type="checkbox" id="sm_att" checked> الحضور</label>
          <label class="badge"><input type="checkbox" id="sm_beh" checked> السلوك</label>
          <label class="badge"><input type="checkbox" id="sm_grd" checked> الدرجات</label>
        </div>
        <div class="wide controls">
          <button id="sm_build" class="primary">توليد</button>
          <button id="sm_print">طباعة</button>
        </div>
      </div>
    </div>
    <div class="section printable">
      <div id="sm_preview" class="memo-doc" contenteditable="true"></div>
      <small class="muted">يمكنك تعديل النص قبل الطباعة. سيتم طباعة هذه المساحة فقط.</small>
    </div>
  </section>

  <!-- الإعدادات -->
  <section id="panel-settings" class="panel">
    <div class="section">
      <h3 style="margin:0 0 8px">إعدادات عامة</h3>
      <div class="controls">
        <button id="s_backup_cloud">نسخة احتياطية للسحابة</button>
        <button id="s_restore_cloud">استعادة من السحابة</button>
        <button id="s_reset" class="warn">🗑️ مسح بيانات الجهاز</button>
      </div>
      <small class="muted">Buckets المطلوبة: <code>student-docs</code> للمرفقات، <code>backups</code> للنسخ.</small>
    </div>
  </section>

</main>

<div id="errToast"></div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ===== تهيئة Supabase ===== */
const SUPABASE_URL='https://alamidjtlxuquvjvvcac.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU';
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<script>
/* ======= حماية من الشاشة البيضاء ======= */
(function(){
  const toast = document.getElementById('errToast');
  function showErr(msg){ try{ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 6000); }catch{} }
  window.addEventListener('error', e=>{ console.error(e); showErr('JS: '+(e.message||e)); });
  window.addEventListener('unhandledrejection', e=>{ console.error(e); showErr('Promise: '+(e.reason?.message||e.reason)); });
})();
</script>

<script>
/* ================== التطبيق ================== */
(function(){
"use strict";
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const DBKEY='daybook_cloud_v1', DOCS_BUCKET='student-docs', BACKUPS_BUCKET='backups';
const syncNote=t=>{ const el=$('#sync'); if(el) el.textContent=t; };

let d={ roster:[], attSessions:[], behavior:[], grades:[], terms:[] };
try{ const raw=localStorage.getItem(DBKEY); if(raw) d=JSON.parse(raw); }catch{}
function save(){ try{ localStorage.setItem(DBKEY, JSON.stringify(d)); }catch{} }

/* ===== Tabs ===== */
$$('#tabs button[data-tab]').forEach(b=>b.addEventListener('click',()=>{
  $$('#tabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  $$('.panel').forEach(p=>p.classList.remove('active')); $('#panel-'+b.dataset.tab).classList.add('active');
}));

/* ===== Helpers ===== */
const UUID_RE=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
const today=()=>new Date().toISOString().slice(0,10);
function sanitize(){
  let ch=false;
  d.roster=(d.roster||[]).filter(s=>s && (s.name||s.student_name)).map(s=>{ if(s.student_name && !s.name){ s.name=s.student_name; ch=true; } if(!UUID_RE.test(s.id||'')){ s.id=crypto.randomUUID(); ch=true; } s.class=s.class||s.class_name||''; s.code=s.code||''; return s; });
  d.attSessions=(d.attSessions||[]).map(ss=>{ if(!UUID_RE.test(ss.id||'')){ ss.id=crypto.randomUUID(); ch=true; } ss.entries=(ss.entries||[]).map(e=>{ if(!e.studentId&&e.student_id){ e.studentId=e.student_id; ch=true; } return e; }); return ss; });
  d.behavior=(d.behavior||[]).map(b=>{ if(!UUID_RE.test(b.id||'')){ b.id=crypto.randomUUID(); ch=true; } if(!b.studentId&&b.student_id){ b.studentId=b.student_id; ch=true; } return b; });
  d.grades=(d.grades||[]).map(g=>{ if(!UUID_RE.test(g.id||'')){ g.id=crypto.randomUUID(); ch=true; } if(!g.studentId&&g.student_id){ g.studentId=g.student_id; ch=true; } return g; });
  if(ch) save();
}

/* ===== ربط القوائم حسب الصف ===== */
function classes(){ return [...new Set((d.roster||[]).map(s=>s.class).filter(Boolean))]; }
function fillClassSelect(sel){
  if(!sel) return;
  const opts=['<option value="">— الكل —</option>'].concat(classes().map(c=>`<option>${esc(c)}</option>`)).join('');
  sel.innerHTML=opts;
}
function fillAllClassFilters(){
  fillClassSelect($('#a_class')); fillClassSelect($('#g_class')); fillClassSelect($('#rp_class'));
}

/* ===== الطلاب ===== */
function renderStudents(filter=''){
  const tb=$('#st_table tbody'); if(!tb) return; tb.innerHTML='';
  const list=(d.roster||[]).filter(s=>s && s.name && (!filter || s.name.includes(filter)));
  let i=1; list.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td><td>${esc(s.code||'—')}</td><td>${esc(s.class||'—')}</td>
      <td><button data-e="${s.id}">تعديل</button> <button data-x="${s.id}" class="warn">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.roster=d.roster.filter(x=>x.id!==b.dataset.x); save(); renderStudents($('#st_search')?.value.trim()||''); fillAllDropdowns(); });
  tb.querySelectorAll('[data-e]').forEach(b=>b.onclick=()=>{ const s=d.roster.find(x=>x.id===b.dataset.e); if(!s) return;
    const name=prompt('الاسم:',s.name)||s.name; const cls=prompt('الصف/الشعبة:',s.class||'')||''; s.name=name; s.class=cls; save(); renderStudents($('#st_search')?.value.trim()||''); fillAllDropdowns(); });
}
$('#st_add')?.addEventListener('click',()=>{ const name=$('#st_name')?.value.trim(); if(!name) return alert('أدخل الاسم');
  d.roster.push({id:crypto.randomUUID(), name, code:$('#st_code')?.value.trim()||'', class:$('#st_class')?.value.trim()||''});
  save(); $('#st_name').value=''; $('#st_code').value=''; $('#st_class').value=''; renderStudents(); fillAllDropdowns();
});
$('#st_search')?.addEventListener('input',e=>renderStudents(e.target.value.trim()));

$('#st_csv')?.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
  const rows=txt.split(/\r?\n/).map(r=>r.trim()).filter(Boolean); const h=rows[0].toLowerCase().split(',').map(s=>s.trim());
  const iName=h.indexOf('name'), iClass=h.indexOf('class'), iCode=h.indexOf('code'); if(iName===-1) return alert('CSV لازم عمود name');
  for(let i=1;i<rows.length;i++){ const cols=rows[i].split(','); const name=(cols[iName]||'').trim(); if(!name) continue;
    d.roster.push({id:crypto.randomUUID(), name, class:iClass>-1?(cols[iClass]||'').trim():'', code:iCode>-1?(cols[iCode]||'').trim():''});
  } save(); renderStudents(); fillAllDropdowns(); alert('تم الاستيراد'); });

/* سحب/رفع طلاب */
$('#st_pull')?.addEventListener('click',async()=>{ syncNote('سحب الطلاب…');
  const {data,error}=await supa.from('students').select('*').order('created_at'); if(error) return alert(error.message);
  d.roster=(data||[]).map(r=>({id:r.id, name:r.name, code:r.code||'', class:r.class||''})); save(); sanitize(); renderStudents(); fillAllDropdowns(); syncNote('تم');
});
$('#st_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('رفع الطلاب…');
  await supa.from('students').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.roster?.length){ const rows=d.roster.map(s=>({id:s.id,name:s.name,code:s.code||null,class:s.class||null})); const {error}=await supa.from('students').insert(rows); if(error) return alert(error.message); }
  syncNote('تم');
});

/* قوائم مشتركة */
function fillAllDropdowns(){
  const roster=(d.roster||[]).filter(s=>s && s.name);
  $('#b_student') && ($('#b_student').innerHTML=roster.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join(''));
  $('#st_for_upload') && ($('#st_for_upload').innerHTML=roster.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join(''));
  $('#sm_student') && ($('#sm_student').innerHTML=roster.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join(''));
  fillAllClassFilters();
}

/* ===== الحضور ===== */
$('#a_date') && ($('#a_date').value=today());
function buildAttendance(){
  const cls=$('#a_class')?.value||''; const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
  const tb=$('#a_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; list.forEach(s=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td>
      <td><select data-s="${s.id}"><option value=""></option><option>حاضر</option><option>غائب</option><option>متأخر</option><option>استئذان</option></select></td>
      <td><input data-n="${s.id}" placeholder="ملاحظة"></td>`; tb.appendChild(tr); });
  refreshAttBadge();
}
function refreshAttBadge(){
  const date=$('#a_date')?.value||''; const cls=$('#a_class')?.value||''; const count=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&s.date===date).length;
  $('#a_sumBadge') && ($('#a_sumBadge').textContent=`جلسات: ${count}`);
}
$('#a_class')?.addEventListener('change', ()=>{ buildAttendance(); });
$('#a_date')?.addEventListener('change', refreshAttBadge);
$('#all_present')?.addEventListener('click',()=>$$('#a_table select').forEach(s=>s.value='حاضر'));
$('#all_absent')?.addEventListener('click',()=>$$('#a_table select').forEach(s=>s.value='غائب'));
$('#toggle_pa')?.addEventListener('click',()=>$$('#a_table select').forEach(s=>s.value=(s.value==='حاضر'?'غائب':'حاضر')));
$('#a_save')?.addEventListener('click',()=>{ const cls=$('#a_class')?.value||'', date=$('#a_date')?.value||today();
  const rows=$$('#a_table tbody tr'); const entries=[]; rows.forEach(r=>{ const sel=r.querySelector('select'), note=r.querySelector('input'); const sid=sel.dataset.s, st=sel.value, nt=note.value.trim(); if(st||nt) entries.push({studentId:sid,status:st,note:nt}); });
  if(!entries.length) return alert('لا بيانات'); d.attSessions.push({id:crypto.randomUUID(),date,class:cls,entries}); save(); refreshAttBadge(); alert('تم الحفظ');
});
$('#a_pull')?.addEventListener('click',async()=>{ syncNote('سحب الحضور…');
  const s=await supa.from('attendance_sessions').select('*').order('date'); if(s.error) return alert(s.error.message);
  const e=await supa.from('attendance_entries').select('*'); if(e.error) return alert(e.error.message);
  const byId={}; (s.data||[]).forEach(x=>byId[x.id]={id:x.id,date:String(x.date),class:x.class,entries:[]});
  (e.data||[]).forEach(x=>{ if(byId[x.session_id]) byId[x.session_id].entries.push({studentId:x.student_id,status:x.status||'',note:x.note||''}); });
  d.attSessions=Object.values(byId); save(); buildAttendance(); refreshAttBadge(); syncNote('تم');
});
$('#a_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('رفع الحضور…');
  await supa.from('attendance_entries').delete().neq('id','00000000-0000-0000-0000-000000000000');
  await supa.from('attendance_sessions').delete().neq('id','00000000-0000-0000-0000-000000000000');
  for(const s of (d.attSessions||[])){ await supa.from('attendance_sessions').insert({id:s.id,date:s.date,class:s.class});
    if(s.entries?.length){ const rows=s.entries.map(e=>({session_id:s.id,student_id:e.studentId,status:e.status||null,note:e.note||null})); const {error}=await supa.from('attendance_entries').insert(rows); if(error) return alert(error.message); } }
  syncNote('تم');
});

/* ===== السلوك ===== */
$('#b_date') && ($('#b_date').value=today());
$('#b_add')?.addEventListener('click',()=>{ const e={id:crypto.randomUUID(),date:$('#b_date')?.value||today(),studentId:$('#b_student')?.value,type:$('#b_type')?.value,category:$('#b_cat')?.value.trim(),points:Number($('#b_points')?.value)||0,note:$('#b_note')?.value.trim()};
  if(!e.studentId) return alert('اختر الطالب'); d.behavior.push(e); save(); renderBehavior(); $('#b_note').value=''; });
function renderBehavior(){ const tb=$('#b_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; (d.behavior||[]).forEach(e=>{ const s=(d.roster||[]).find(x=>x.id===e.studentId);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i++}</td><td>${esc(e.date)}</td><td>${esc(s?s.name:'?')}</td><td>${e.type==='positive'?'إيجابي':'سلبي'}</td><td>${esc(e.category||'—')}</td><td>${e.points||0}</td><td>${esc(e.note||'—')}</td><td><button data-x="${e.id}" class="warn">🗑</button></td>`; tb.appendChild(tr); });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.behavior=d.behavior.filter(x=>x.id!==b.dataset.x); save(); renderBehavior(); });
}
$('#b_pull')?.addEventListener('click',async()=>{ syncNote('سحب السلوك…'); const r=await supa.from('behavior').select('*').order('date'); if(r.error) return alert(r.error.message);
  d.behavior=(r.data||[]).map(x=>({id:x.id,date:String(x.date),studentId:x.student_id,type:x.type,category:x.category,points:x.points||0,note:x.note||''})); save(); renderBehavior(); syncNote('تم'); });
$('#b_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('رفع السلوك…');
  await supa.from('behavior').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.behavior?.length){ const rows=d.behavior.map(e=>({id:e.id,date:e.date,student_id:e.studentId,type:e.type,category:e.category,points:e.points||0,note:e.note||null})); const {error}=await supa.from('behavior').insert(rows); if(error) return alert(error.message); }
  syncNote('تم');
});

/* ===== الدرجات ===== */
$('#g_date') && ($('#g_date').value=today());
function buildGrades(){
  const cls=$('#g_class')?.value||''; const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
  const tb=$('#g_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; list.forEach(s=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td>
      <td><input type="number" min="0" max="10" step="1" data-k="homework" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="20" step="1" data-k="tasks" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="10" step="1" data-k="particip" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="20" step="1" data-k="quiz" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="40" step="1" data-k="final" data-s="${s.id}"></td>
      <td data-total="${s.id}">0</td>`; tb.appendChild(tr); });
  tb.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',()=>{ const sid=inp.dataset.s; const vals={homework:0,tasks:0,particip:0,quiz:0,final:0};
    tb.querySelectorAll(`input[data-s="${sid}"]`).forEach(el=>{ vals[el.dataset.k]=Number(el.value)||0; });
    tb.querySelector(`[td][data-total="${sid}"]`) || null; const cell=tb.querySelector(`[data-total="${sid}"]`); if(cell) cell.textContent=vals.homework+vals.tasks+vals.particip+vals.quiz+vals.final; }));
}
$('#g_class')?.addEventListener('change', buildGrades);
$('#g_save')?.addEventListener('click',()=>{ const limits={homework:10,tasks:20,particip:10,quiz:20,final:40}; const cls=$('#g_class')?.value||'', date=$('#g_date')?.value||today();
  const rows=$$('#g_table tbody tr'); const recs=[]; let ok=true;
  rows.forEach(r=>{ const sid=r.querySelector('input')?.dataset.s; if(!sid) return;
    const get=k=>Number(r.querySelector(`input[data-k="${k}"][data-s="${sid}"]`)?.value)||0;
    const v={homework:get('homework'),tasks:get('tasks'),particip:get('particip'),quiz:get('quiz'),final:get('final')};
    for(const k in v){ const el=r.querySelector(`input[data-k="${k}"]`); if(v[k]<0||v[k]>limits[k]){ ok=false; if(el) el.style.background='#fee2e2'; } else if(el) el.style.background=''; }
    recs.push({id:crypto.randomUUID(),date,studentId:sid,class:cls,...v,total:v.homework+v.tasks+v.particip+v.quiz+v.final}); });
  if(!ok) return alert('تحقق من الحدود: 10/20/10/20/40');
  d.grades=d.grades.filter(g=>!(g.date===date && g.class===cls)); d.grades.push(...recs); save(); alert('تم الحفظ');
});
$('#g_pull')?.addEventListener('click',async()=>{ syncNote('سحب الدرجات…'); const r=await supa.from('grades').select('*').order('date'); if(r.error) return alert(r.error.message);
  d.grades=(r.data||[]).map(g=>({id:g.id,date:String(g.date),studentId:g.student_id,class:g.class,homework:g.homework||0,tasks:g.tasks||0,particip:g.particip||0,quiz:g.quiz||0,final:g.final||0,total:g.total||0})); save(); syncNote('تم'); });
$('#g_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('رفع الدرجات…');
  await supa.from('grades').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.grades?.length){ const rows=d.grades.map(g=>({id:g.id,date:g.date,student_id:g.studentId,class:g.class,homework:g.homework,tasks:g.tasks,particip:g.particip,quiz:g.quiz,final:g.final,total:g.total||null}));
    const {error}=await supa.from('grades').insert(rows); if(error) return alert(error.message); }
  syncNote('تم');
});
$('#g_analyze')?.addEventListener('click',()=>{ const box=$('#g_analysis'); if(!box) return; const cls=$('#g_class')?.value||'';
  const lastBy={}; [...(d.grades||[])].reverse().forEach(g=>{ if(!lastBy[g.studentId]) lastBy[g.studentId]=g; });
  const rows=(d.roster||[]).filter(s=>!cls||s.class===cls).map(s=>({name:s.name,total:+(lastBy[s.id]?.total||0)}));
  const top=rows.slice().sort((a,b)=>b.total-a.total).slice(0,5), weak=rows.filter(r=>r.total<50).sort((a,b)=>a.total-b.total).slice(0,5);
  box.style.display='block'; box.innerHTML=`<h3>تحليل سريع</h3><div class="grid">
    <div><strong>أعلى 5:</strong><ol>${top.map(r=>`<li>${esc(r.name)} — ${r.total}</li>`).join('')}</ol></div>
    <div><strong>بحاجة دعم (&lt;50):</strong><ol>${weak.map(r=>`<li>${esc(r.name)} — ${r.total}</li>`).join('')}</ol></div></div>`;
});

/* ===== التقارير ===== */
function refreshReportStats(){
  const tag=$('#rp_stats'); if(!tag) return; const from=$('#rp_from')?.value||'0000-00-00', to=$('#rp_to')?.value||'9999-12-31', cls=$('#rp_class')?.value||'';
  const sess=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&s.date>=from&&s.date<=to);
  const entries=sess.reduce((n,s)=>n+(s.entries?.length||0),0);
  const all=(d.grades||[]).filter(g=>(!cls||g.class===cls)&&g.date>=from&&g.date<=to).map(g=>+g.total||0);
  const avg=all.length?(all.reduce((a,b)=>a+b,0)/all.length).toFixed(1):'—';
  tag.textContent=`جلسات: ${sess.length} | قيود حضور: ${entries} | متوسط الدرجات: ${avg}`;
}
$('#rp_run')?.addEventListener('click',()=>{ const cls=$('#rp_class')?.value||'', from=$('#rp_from')?.value||'0000-00-00', to=$('#rp_to')?.value||'9999-12-31';
  const students=(d.roster||[]).filter(s=>!cls||s.class===cls); const body=$('#rp_table tbody'); if(!body) return; body.innerHTML='';
  let i=1; students.forEach(s=>{ let present=0,absent=0,leave=0; (d.attSessions||[]).filter(ss=>(!cls||ss.class===cls)&&ss.date>=from&&ss.date<=to).forEach(ss=>{ const e=ss.entries.find(x=>x.studentId===s.id); if(!e) return; if(e.status==='حاضر') present++; if(e.status==='غائب') absent++; if(e.status==='استئذان') leave++; });
    let pos=0,neg=0; (d.behavior||[]).filter(b=>b.studentId===s.id && b.date>=from && b.date<=to).forEach(b=>{ if(b.type==='positive') pos+=b.points||0; else neg+=Math.abs(b.points||0); });
    const g=(d.grades||[]).filter(g=>g.studentId===s.id && g.date>=from && g.date<=to); const maxTotal=g.length?Math.max(...g.map(x=>x.total||0)):0;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td><td>${present}</td><td>${absent}</td><td>${leave}</td><td>${pos}</td><td>${neg}</td><td>${maxTotal}</td>`; body.appendChild(tr); });
  refreshReportStats();
});
$('#rp_print')?.addEventListener('click',()=>window.print());
['#rp_from','#rp_to','#rp_class'].forEach(sel=>$(sel)?.addEventListener('change',refreshReportStats));

/* ===== مذكرة الطالب ===== */
$('#sm_from') && ($('#sm_from').value=today());
$('#sm_to') && ($('#sm_to').value=today());
function sm_attendanceStats(id,from,to){ let pr=0,ab=0,lt=0,lv=0,tot=0; (d.attSessions||[]).forEach(ss=>{ if(ss.date<from||ss.date>to) return; const e=(ss.entries||[]).find(x=>x.studentId===id); if(!e) return; tot++; if(e.status==='حاضر') pr++; else if(e.status==='غائب') ab++; else if(e.status==='متأخر') lt++; else if(e.status==='استئذان') lv++; }); return {present:pr,absent:ab,late:lt,leave:lv,total:tot,pct: tot?Math.round(pr/tot*100):null}; }
function sm_behaviorStats(id,from,to){ let pos=0,neg=0; const items=(d.behavior||[]).filter(b=>b.studentId===id && b.date>=from && b.date<=to); items.forEach(b=>{ if(b.type==='positive') pos+=(+b.points||0); else neg+=Math.abs(+b.points||0); }); return {pos,neg,latest:items.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,3)}; }
function sm_gradeStats(id,from,to){ const rows=(d.grades||[]).filter(g=>g.studentId===id && g.date>=from && g.date<=to); if(!rows.length) return {best:null,last:null}; const best=rows.slice().sort((a,b)=>(+b.total||0)-(+a.total||0))[0]; const last=rows.slice().sort((a,b)=>b.date.localeCompare(a.date))[0]; return {best,last}; }
$('#sm_build')?.addEventListener('click',()=>{ const pv=$('#sm_preview'); const sid=$('#sm_student')?.value; if(!pv||!sid) return alert('اختر الطالب'); const stu=(d.roster||[]).find(s=>s.id===sid);
  const from=$('#sm_from')?.value||'0000-00-00', to=$('#sm_to')?.value||'9999-12-31', ia=$('#sm_att')?.checked, ib=$('#sm_beh')?.checked, ig=$('#sm_grd')?.checked;
  let html=`<h2>مذكرة بشأن الطالب / ${esc(stu?.name||'')}</h2><div class="meta">الصف: ${esc(stu?.class||'—')} — المدة: ${esc(from)} إلى ${esc(to)}</div>`;
  if(ia){ const A=sm_attendanceStats(sid,from,to); html+=`<div class="sec"><strong>أولًا: الحضور والانضباط</strong><br>الجلسات: ${A.total||0}. حضر: ${A.present}, غياب: ${A.absent}, تأخر: ${A.late}, استئذان: ${A.leave}. ${A.pct!=null?`نسبة الحضور: ${A.pct}%`:''}</div>`; }
  if(ib){ const B=sm_behaviorStats(sid,from,to); const latest=B.latest.map(b=>`• ${esc(b.date)} — ${b.type==='positive'?'إيجابي':'سلبي'} (${b.points||0}): ${esc(b.category||'')} — ${esc(b.note||'')}`).join('<br>'); html+=`<div class="sec"><strong>ثانيًا: السلوكيات</strong><br>مجموع الإيجابي: ${B.pos}، السلبي: ${B.neg}.<br>${latest?`أحدث الملاحظات:<br>${latest}`:'لا توجد ملاحظات في هذه الفترة.'}</div>`; }
  if(ig){ const G=sm_gradeStats(sid,from,to), L=G.last||{}; html+=`<div class="sec"><strong>ثالثًا: التحصيل الدراسي</strong><br>أفضل مجموع: ${G.best?(+G.best.total||0):'—'}. أحدث رصد: ${esc(G.last?G.last.date:'—')}${G.last?` — واجبات ${+L.homework||0}/10، مهام ${+L.tasks||0}/20، مشاركة ${+L.particip||0}/10، اختبار ${+L.quiz||0}/20، نهائي ${+L.final||0}/40، المجموع ${+L.total||0}/100`:''}</div>`; }
  html+=`<div class="sec"><strong>خلاصة وتوصيات</strong><br>– متابعة الواجبات والاختبارات القصيرة.<br>– تعزيز السلوك الإيجابي داخل الصف.<br>– الحفاظ على الحضور المنتظم ومعالجة التأخر مبكرًا.<br></div><div style="margin-top:18px">حرر في: ${new Date().toLocaleDateString('ar')} — توقيع المعلم: ____________</div>`;
  pv.innerHTML=html;
});
$('#sm_print')?.addEventListener('click',()=>window.print());

/* ===== مرفقات ===== */
function iconFor(m){ if(!m) return '📎'; if(m.startsWith('image/'))return'🖼️'; if(m.includes('pdf'))return'📄'; if(m.startsWith('video/'))return'🎞️'; if(m.includes('zip'))return'🗜️'; return'📎'; }
function human(n){ if(!n) return '—'; if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB'; return (n/1024/1024/1024).toFixed(1)+' GB'; }
$('#st_upload')?.addEventListener('click',async()=>{ const f=$('#st_file')?.files?.[0]; if(!f) return alert('اختر ملف'); const sid=$('#st_for_upload')?.value; if(!UUID_RE.test(sid||'')) return alert('اختر الطالب');
  const path=`${sid}/${Date.now()}_${f.name}`; const up=await supa.storage.from(DOCS_BUCKET).upload(path,f,{contentType:f.type||undefined,upsert:false});
  if(up.error){ if(/Bucket not found/i.test(up.error.message)) alert('أنشئ bucket اسمه student-docs'); else alert(up.error.message); return; }
  const ins=await supa.from('attachments').insert({student_id:sid,name:f.name,path,mime:f.type||null,size:f.size||null}); if(ins.error) return alert(ins.error.message);
  alert('تم الرفع'); $('#st_file').value=''; listStudentFiles(sid);
});
$('#st_list')?.addEventListener('click',()=>{ const sid=$('#st_for_upload')?.value; if(!sid) return alert('اختر الطالب'); listStudentFiles(sid); });
async function listStudentFiles(sid){
  const q=await supa.from('attachments').select('*').eq('student_id',sid); if(q.error) return alert(q.error.message);
  const tb=$('#files_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; for(const r of (q.data||[])){ const pub=supa.storage.from(DOCS_BUCKET).getPublicUrl(r.path).data.publicUrl; const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td><span>${iconFor(r.mime)}</span> ${esc(r.name)}</td><td>${human(r.size||0)}</td><td>${new Date(r.uploaded_at||0).toLocaleString('ar')}</td>
      <td><a class="btn" target="_blank" href="${pub}">فتح</a> <button data-copy="${pub}">نسخ</button></td>
      <td><button class="warn" data-del="${r.id}" data-path="${esc(r.path)}">🗑</button></td>`; tb.appendChild(tr); }
  tb.querySelectorAll('button[data-copy]').forEach(b=>b.onclick=()=>{ navigator.clipboard.writeText(b.dataset.copy); b.textContent='نُسخ'; setTimeout(()=>b.textContent='نسخ',1200); });
  tb.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{ if(!confirm('تأكيد الحذف؟')) return; const path=btn.getAttribute('data-path'), id=btn.getAttribute('data-del');
    const del1=await supa.storage.from(DOCS_BUCKET).remove([path]); if(del1.error) return alert(del1.error.message); const del2=await supa.from('attachments').delete().eq('id',id); if(del2.error) return alert(del2.error.message); listStudentFiles($('#st_for_upload')?.value); });
}

/* ===== Sync شامل ===== */
$('#syncAll')?.addEventListener('click',async()=>{ try{
  syncNote('لقطة احتياطية…'); // بسيطة: حفظ محلي فقط
  save();
  syncNote('سحب من السحابة…');
  await $('#st_pull')?.onclick?.();
  await $('#a_pull')?.onclick?.();
  await $('#b_pull')?.onclick?.();
  await $('#g_pull')?.onclick?.();
  syncNote('تم');
}catch(e){ alert('تعذّرت المزامنة: '+(e.message||e)); syncNote('خطأ'); }});

/* ===== إعدادات ===== */
$('#s_backup_cloud')?.addEventListener('click',async()=>{ try{
  const blob=new Blob([JSON.stringify(d||{})],{type:'application/json'}); const name=`daybook_${Date.now()}.json`;
  const up=await supa.storage.from(BACKUPS_BUCKET).upload(name,blob,{contentType:'application/json',upsert:false});
  if(up.error){ if(/Bucket not found/i.test(up.error.message)) alert('أنشئ bucket اسمه backups'); else alert(up.error.message); return; }
  alert('تم حفظ نسخة احتياطية في السحابة');
}catch(e){ alert(e.message); }});
$('#s_restore_cloud')?.addEventListener('click',async()=>{ try{
  const list=await supa.storage.from(BACKUPS_BUCKET).list('',{sortBy:{column:'created_at',order:'desc'},limit:1});
  if(list.error) return alert(list.error.message); if(!list.data?.length) return alert('لا توجد نسخ');
  const dl=await supa.storage.from(BACKUPS_BUCKET).download(list.data[0].name); if(dl.error) return alert(dl.error.message);
  d=JSON.parse(await dl.data.text()); save(); alert('تمت الاستعادة'); location.reload();
}catch(e){ alert(e.message); }});
$('#s_reset')?.addEventListener('click',()=>{ if(confirm('مسح بيانات الجهاز؟')){ localStorage.removeItem(DBKEY); location.reload(); }});

/* ===== بناء أولي ===== */
function init(){
  sanitize(); renderStudents(); fillAllDropdowns(); buildAttendance(); renderBehavior(); buildGrades();
  $('#g_date') && ($('#g_date').value=today()); $('#b_date') && ($('#b_date').value=today());
}
init();

})(); // app IIFE
</script>
</body>
</html>
