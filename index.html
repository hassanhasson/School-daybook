<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>School Daybook â€” Supabase</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    :root{
      --ink:#0f172a; --bg:#f6f7fb; --card:#fff; --muted:#64748b; --border:#e5e7eb; --brand:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:"Noto Sans Arabic",system-ui,Segoe UI,Arial}
    header{background:var(--ink);color:#fff;padding:14px 16px;font-weight:700}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .tabs button{background:#fff;border:1px solid var(--border);padding:8px 14px;border-radius:10px;cursor:pointer}
    .tabs button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    input,select,button{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:8px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:8px;text-align:right}
    th{background:#f3f4f6}
    small.muted{color:var(--muted)}
    .hidden{display:none}
    ul{padding:0;list-style:none}
    li{padding:6px 0;border-bottom:1px solid var(--border)}
  </style>
</head>
<body>
  <header>ğŸ“˜ School Daybook â€” Supabase</header>
  <div class="wrap">
    <div class="tabs">
      <button data-tab="students" class="active">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-tab="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      <button data-tab="behavior">Ø§Ù„Ø³Ù„ÙˆÙƒ</button>
      <button data-tab="grades">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
      <button data-tab="attachments">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
    </div>

    <!-- Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <section id="tab-students" class="card">
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <div class="row">
        <input id="studentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input id="studentClass" placeholder="Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©">
        <button id="addStudent">Ø¥Ø¶Ø§ÙØ©</button>
        <button id="pullCloudStudents" title="Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
      </div>
      <small class="muted">ÙŠØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>
      <table>
        <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©</th></tr></thead>
        <tbody id="tblStudents"></tbody>
      </table>
    </section>

    <!-- Ø§Ù„Ø­Ø¶ÙˆØ± -->
    <section id="tab-attendance" class="card hidden">
      <h3>Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
      <div class="row">
        <select id="selStudentA"></select>
        <input id="dateA" type="date">
        <select id="periodA">
          <option value="1">Ø§Ù„Ø­ØµØ© 1</option><option value="2">Ø§Ù„Ø­ØµØ© 2</option>
          <option value="3">Ø§Ù„Ø­ØµØ© 3</option><option value="4">Ø§Ù„Ø­ØµØ© 4</option>
          <option value="5">Ø§Ù„Ø­ØµØ© 5</option><option value="6">Ø§Ù„Ø­ØµØ© 6</option>
          <option value="7">Ø§Ù„Ø­ØµØ© 7</option>
        </select>
        <select id="statusA">
          <option value="present">Ø­Ø§Ø¶Ø±</option>
          <option value="absent">ØºØ§Ø¦Ø¨</option>
          <option value="late">Ù…ØªØ£Ø®Ø±</option>
          <option value="excused">Ù…Ø³ØªØ£Ø°Ù†</option>
        </select>
        <button id="addAttendance">Ø­ÙØ¸</button>
      </div>
      <table>
        <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­ØµØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody id="tblAttendance"></tbody>
      </table>
    </section>

    <!-- Ø§Ù„Ø³Ù„ÙˆÙƒ -->
    <section id="tab-behavior" class="card hidden">
      <h3>Ø§Ù„Ø³Ù„ÙˆÙƒ</h3>
      <div class="row">
        <select id="selStudentB"></select>
        <input id="dateB" type="date">
        <select id="periodB">
          <option value="1">Ø§Ù„Ø­ØµØ© 1</option><option value="2">Ø§Ù„Ø­ØµØ© 2</option>
          <option value="3">Ø§Ù„Ø­ØµØ© 3</option><option value="4">Ø§Ù„Ø­ØµØ© 4</option>
          <option value="5">Ø§Ù„Ø­ØµØ© 5</option><option value="6">Ø§Ù„Ø­ØµØ© 6</option>
          <option value="7">Ø§Ù„Ø­ØµØ© 7</option>
        </select>
        <select id="typeB">
          <option value="positive">Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</option>
          <option value="negative">Ø³Ù„Ø¨ÙŠ</option>
        </select>
        <input id="pointsB" type="number" step="1" placeholder="Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button id="addBehavior">Ø­ÙØ¸</button>
      </div>
      <table>
        <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­ØµØ©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù†Ù‚Ø§Ø·</th></tr></thead>
        <tbody id="tblBehavior"></tbody>
      </table>
    </section>

    <!-- Ø§Ù„Ø¯Ø±Ø¬Ø§Øª -->
    <section id="tab-grades" class="card hidden">
      <h3>Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
      <div class="row">
        <select id="selStudentG"></select>
        <select id="itemG">
          <option value="participation">Ù…Ø´Ø§Ø±ÙƒØ© (10)</option>
          <option value="homework">ÙˆØ§Ø¬Ø¨Ø§Øª (10)</option>
          <option value="tasks">Ù…Ù‡Ø§Ù… Ø£Ø¯Ø§Ø¦ÙŠØ© (20)</option>
          <option value="quiz">Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± ØªØ­Ø±ÙŠØ±ÙŠ (20)</option>
          <option value="final">Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØµÙ„ (40)</option>
        </select>
        <input id="scoreG" type="number" step="0.5" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©">
        <button id="addGrade">Ø­ÙØ¸</button>
      </div>
      <table>
        <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead>
        <tbody id="tblGrades"></tbody>
      </table>
    </section>

    <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
    <section id="tab-attachments" class="card hidden">
      <h3>Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <div class="row">
        <select id="selStudentF"></select>
        <input type="file" id="fileInput">
        <button id="uploadFile">Ø±ÙØ¹ Ù…Ù„Ù</button>
        <button id="refreshFiles">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</button>
      </div>
      <small class="muted">ÙŠØ±ÙØ¹ Ø¥Ù„Ù‰ Bucket: <b>student-docs</b> (Ø®Ø§Ø±Ø¬ÙŠØ§Ù‹ Ø¹Ø§Ù…). Ù„Ùˆ Ø¸Ù‡Ø± â€œBucket not foundâ€ Ø£Ù†Ø´Ø¦Ù‡ ÙÙŠ Supabase/Storage ÙˆØ§Ø¬Ø¹Ù„Ù‡ Public.</small>
      <ul id="fileList"></ul>
    </section>
  </div>

  <!-- 1) Ù…ÙƒØªØ¨Ø© Supabase UMD ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ­Ù…Ù‘Ù„ Ù‚Ø¨Ù„ Ø³ÙƒØ±Ø¨ØªÙ†Ø§ -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <!-- 2) Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ÙØ§Ù†ÙŠÙ„Ø§ JS) -->
  <script>
  (function(){
    "use strict";

    // Ù…ÙØ§ØªÙŠØ­ Supabase â€” ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª â€œÙ…Ø¯Ù…ÙˆØ¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ùâ€
    var SUPABASE_URL = "https://alamidjtlxuquvjvvcac.supabase.co";
    var SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU";

    // ØªØ£ÙƒÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©
    if (!window.supabase || !window.supabase.createClient) {
      alert("Ù…ÙƒØªØ¨Ø© Supabase Ù„Ù… ØªÙØ­Ù…Ù‘Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ…Ù† Ø¹Ø¯Ù… Ø­Ø¬Ø¨ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª.");
      return;
    }
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Ø¹Ù†Ø§ØµØ± DOM
    var tabsBtns = document.querySelectorAll('.tabs button');
    var sections = {
      students: document.getElementById('tab-students'),
      attendance: document.getElementById('tab-attendance'),
      behavior: document.getElementById('tab-behavior'),
      grades: document.getElementById('tab-grades'),
      attachments: document.getElementById('tab-attachments')
    };

    tabsBtns.forEach(function(btn){
      btn.addEventListener('click', function(){
        tabsBtns.forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        var t = btn.getAttribute('data-tab');
        Object.keys(sections).forEach(function(key){
          sections[key].classList.toggle('hidden', key !== t);
        });
      });
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    var students = [];
    var attendance = [];
    var behavior = [];
    var grades = [];

    // Ø£Ø¯ÙˆØ§Øª
    function byNameAsc(a,b){
      return (a.name||"").localeCompare(b.name||"", 'ar', {sensitivity:'base'});
    }
    function fillStudentSelect(id){
      var el = document.getElementById(id);
      el.innerHTML = students.map(function(s){ return '<option value="'+s.id+'">'+s.name+'</option>'; }).join('');
    }
    function refreshAllStudentSelects(){
      fillStudentSelect('selStudentA');
      fillStudentSelect('selStudentB');
      fillStudentSelect('selStudentG');
      fillStudentSelect('selStudentF');
    }

    // ----- Ø§Ù„Ø·Ù„Ø§Ø¨ -----
    function renderStudents(){
      var tbody = document.getElementById('tblStudents');
      tbody.innerHTML = students.map(function(s, i){
        return '<tr><td>'+(i+1)+'</td><td>'+ (s.name||'') +'</td><td>'+ (s.classroom||'') +'</td></tr>';
      }).join('');
      refreshAllStudentSelects();
    }
    function loadStudents(){
      return sb.from('students').select('*').then(function(res){
        students = (res.data||[]).slice().sort(byNameAsc);
        renderStudents();
      });
    }
    document.getElementById('addStudent').addEventListener('click', function(){
      var name = document.getElementById('studentName').value.trim();
      var classroom = document.getElementById('studentClass').value.trim();
      if(!name){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'); return; }
      sb.from('students').insert({name:name, classroom:classroom}).select().then(function(res){
        if(res.error){ alert(res.error.message); return; }
        students.push(res.data[0]); students.sort(byNameAsc); renderStudents();
        document.getElementById('studentName').value='';
        document.getElementById('studentClass').value='';
      });
    });
    document.getElementById('pullCloudStudents').addEventListener('click', loadStudents);

    // ----- Ø§Ù„Ø­Ø¶ÙˆØ± -----
    function renderAttendance(){
      var tbody = document.getElementById('tblAttendance');
      tbody.innerHTML = attendance.map(function(a,i){
        var stu = students.find(function(s){ return s.id===a.student_id; });
        return '<tr><td>'+(i+1)+'</td><td>'+(stu?stu.name:'')+'</td><td>'+a.date+'</td><td>'+a.period+'</td><td>'+a.status+'</td></tr>';
      }).join('');
    }
    function loadAttendance(){
      return sb.from('attendance_entries').select('*').order('date',{ascending:false}).then(function(res){
        attendance = res.data||[]; renderAttendance();
      });
    }
    document.getElementById('addAttendance').addEventListener('click', function(){
      var student_id = document.getElementById('selStudentA').value;
      var date = document.getElementById('dateA').value;
      var status = document.getElementById('statusA').value;
      var period = parseInt(document.getElementById('periodA').value,10);
      if(!student_id || !date){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®'); return; }
      sb.from('attendance_entries').insert({student_id:student_id,date:date,status:status,period:period}).select().then(function(res){
        if(res.error){ alert(res.error.message); return; }
        attendance.unshift(res.data[0]); renderAttendance();
      });
    });

    // ----- Ø§Ù„Ø³Ù„ÙˆÙƒ -----
    function renderBehavior(){
      var tbody = document.getElementById('tblBehavior');
      tbody.innerHTML = behavior.map(function(b,i){
        var stu = students.find(function(s){ return s.id===b.student_id; });
        return '<tr><td>'+(i+1)+'</td><td>'+(stu?stu.name:'')+'</td><td>'+b.date+'</td><td>'+b.period+'</td><td>'+b.type+'</td><td>'+(b.points||'')+'</td></tr>';
      }).join('');
    }
    function loadBehavior(){
      return sb.from('behavior').select('*').order('date',{ascending:false}).then(function(res){
        behavior = res.data||[]; renderBehavior();
      });
    }
    document.getElementById('addBehavior').addEventListener('click', function(){
      var student_id = document.getElementById('selStudentB').value;
      var date = document.getElementById('dateB').value;
      var type = document.getElementById('typeB').value;
      var period = parseInt(document.getElementById('periodB').value,10);
      var points = parseInt(document.getElementById('pointsB').value,10) || null;
      if(!student_id || !date){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®'); return; }
      sb.from('behavior').insert({student_id:student_id,date:date,type:type,period:period,points:points}).select().then(function(res){
        if(res.error){ alert(res.error.message); return; }
        behavior.unshift(res.data[0]); renderBehavior();
      });
    });

    // ----- Ø§Ù„Ø¯Ø±Ø¬Ø§Øª -----
    function renderGrades(){
      var tbody = document.getElementById('tblGrades');
      tbody.innerHTML = grades.map(function(g,i){
        var stu = students.find(function(s){ return s.id===g.student_id; });
        return '<tr><td>'+(i+1)+'</td><td>'+(stu?stu.name:'')+'</td><td>'+g.item+'</td><td>'+g.score+'</td></tr>';
      }).join('');
    }
    function loadGrades(){
      return sb.from('grades').select('*').order('created_at',{ascending:false}).then(function(res){
        grades = res.data||[]; renderGrades();
      });
    }
    document.getElementById('addGrade').addEventListener('click', function(){
      var student_id = document.getElementById('selStudentG').value;
      var item = document.getElementById('itemG').value;
      var score = parseFloat(document.getElementById('scoreG').value);
      if(!student_id || isNaN(score)){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø©'); return; }
      sb.from('grades').insert({student_id:student_id,item:item,score:score}).select().then(function(res){
        if(res.error){ alert(res.error.message); return; }
        grades.unshift(res.data[0]); renderGrades();
      });
    });

    // ----- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -----
    var BUCKET = 'student-docs';
    function ensureBucketAndList(){
      // Ù†Ø¬Ø±Ø¨ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
      listFilesForSelected();
    }
    function currentStudentIdForFiles(){
      return document.getElementById('selStudentF').value || '';
    }
    function listFilesForSelected(){
      var sid = currentStudentIdForFiles();
      var ul = document.getElementById('fileList');
      ul.innerHTML = '';
      if(!sid){ return; }
      sb.storage.from(BUCKET).list(sid,{limit:100,sortBy:{column:'name',order:'asc'}}).then(function(res){
        if(res.error){
          alert(res.error.message + "\\nÙ„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Bucket not found: Ø£Ù†Ø´Ø¦ student-docs (Public) ÙÙŠ Storage.");
          return;
        }
        (res.data||[]).forEach(function(obj){
          var path = sid + '/' + obj.name;
          var pub = sb.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
          var li = document.createElement('li');
          li.innerHTML = '<a href="'+pub+'" target="_blank">'+obj.name+'</a> â€” <small>'+ (obj.updated_at||'') +'</small>';
          ul.appendChild(li);
        });
      });
    }
    document.getElementById('refreshFiles').addEventListener('click', listFilesForSelected);
    document.getElementById('selStudentF').addEventListener('change', listFilesForSelected);

    document.getElementById('uploadFile').addEventListener('click', function(){
      var sid = currentStudentIdForFiles();
      var f = document.getElementById('fileInput').files[0];
      if(!sid){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨'); return; }
      if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„Ù'); return; }
      var path = sid + '/' + Date.now() + '_' + f.name;
      sb.storage.from(BUCKET).upload(path,f,{upsert:false}).then(function(res){
        if(res.error){ alert(res.error.message); return; }
        listFilesForSelected();
      });
    });

    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    Promise.all([loadStudents(), loadAttendance(), loadBehavior(), loadGrades()]).then(function(){
      ensureBucketAndList();
    });
  })();
  </script>
</body>
</html>
