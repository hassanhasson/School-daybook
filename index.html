<script>
(function(){
  "use strict";

  /* ================== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ================== */
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc= s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const DBKEY='daybook_cloud_v1';
  const DOCS_BUCKET='student-docs';     // Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
  const BACKUPS_BUCKET='backups';        // Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ

  // Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© (ÙŠØ­Ù…Ù„ Ù…Ù† localStorage Ø¥Ù† ÙˆØ¬Ø¯)
  window.d = window.d || { roster:[], attSessions:[], behavior:[], grades:[], terms:[] };
  try{ const raw=localStorage.getItem(DBKEY); if(raw){ window.d=JSON.parse(raw); } }catch{}

  function saveAll(){ try{ localStorage.setItem(DBKEY, JSON.stringify(window.d)); }catch{} }

  // Ù…Ù„ØªÙ‚Ø· Ø£Ø®Ø·Ø§Ø¡ Ø­ØªÙ‰ Ù„Ø§ ØªØªØ­ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¨ÙŠØ¶Ø§Ø¡
  window.addEventListener('error', e=>{ console.error(e); });
  window.addEventListener('unhandledrejection', e=>{ console.error(e); });

  // ØªØ°ÙƒÙ‘Ø± Ø¢Ø®Ø± ØµÙ Ù…Ø®ØªØ§Ø±
  const LAST = {
    set(v){ try{ localStorage.setItem('last_class', v||''); }catch{} },
    get(){ try{ return localStorage.getItem('last_class')||''; }catch{ return '' } }
  };

  /* ================== Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ / Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ================== */
  async function backupToCloud(){
    if(!window.supa) return alert('Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£.');
    try{
      const blob=new Blob([JSON.stringify(window.d||{})],{type:'application/json'});
      const path=`backup_${Date.now()}.json`;
      const up=await supa.storage.from(BACKUPS_BUCKET).upload(path, blob, {contentType:'application/json', upsert:false});
      if(up.error){
        if(/Bucket not found/i.test(up.error.message)) return alert('Ø£Ù†Ø´Ø¦ bucket Ø§Ø³Ù…Ù‡ backups ÙÙŠ Supabase â–¸ Storage.');
        throw up.error;
      }
      alert('ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
    }catch(err){ alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: '+err.message); }
  }
  async function restoreLatestFromCloud(){
    if(!window.supa) return alert('Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£.');
    try{
      const L=await supa.storage.from(BACKUPS_BUCKET).list('',{sortBy:{column:'created_at',order:'desc'},limit:1});
      if(L.error){ 
        if(/Bucket not found/i.test(L.error.message)) return alert('Ø£Ù†Ø´Ø¦ bucket Ø§Ø³Ù…Ù‡ backups ÙÙŠ Supabase.');
        throw L.error;
      }
      if(!L.data?.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
      const dl=await supa.storage.from(BACKUPS_BUCKET).download(L.data[0].name);
      if(dl.error) throw dl.error;
      const obj=JSON.parse(await dl.data.text());
      window.d=obj; saveAll(); alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); location.reload();
    }catch(err){ alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: '+err.message); }
  }
  $('#s_backup_cloud')?.addEventListener('click', backupToCloud);
  $('#s_restore_cloud')?.addEventListener('click', restoreLatestFromCloud);

  // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
  function resetLocal(){ if(confirm('Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')){ localStorage.removeItem(DBKEY); location.reload(); } }
  window.Daybook = Object.assign(window.Daybook||{}, { resetLocal, backupToCloud, restoreLatestFromCloud });

  /* ================== ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ================== */
  function iconFor(m){ if(!m) return 'ğŸ“'; if(m.startsWith('image/'))return'ğŸ–¼ï¸'; if(m.includes('pdf'))return'ğŸ“„'; if(m.startsWith('video/'))return'ğŸï¸'; if(m.includes('zip'))return'ğŸ—œï¸'; return'ğŸ“'; }
  function humanSize(b){ let s=+b||0,u=['B','KB','MB','GB','TB'],i=0; while(s>=1024&&i<u.length-1){s/=1024;i++;} return s? (s.toFixed(1)+' '+u[i]):'â€”'; }
  function enhanceAttachmentsUI(root=document){
    root.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.onclick=()=>navigator.clipboard.writeText(btn.dataset.copy).then(()=>alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'));
    });
    root.querySelectorAll('[data-size-bytes]').forEach(el=>{ el.textContent=humanSize(el.dataset.sizeBytes); });
    root.querySelectorAll('[data-mime]').forEach(el=>{ el.textContent=iconFor(el.dataset.mime); });
  }
  window.Daybook = Object.assign(window.Daybook||{}, { enhanceAttachmentsUI });

  // Ù…Ø«Ø§Ù„ Ø±ÙØ¹ Ù…Ù„Ù (Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø­ÙŠØ« ØªØ¨Ù†ÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª)
  async function uploadStudentFile(path, file){
    if(!window.supa) return alert('Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£.');
    try{
      const up=await supa.storage.from(DOCS_BUCKET).upload(path, file, { upsert:false });
      if(up.error){
        if(/Bucket not found/i.test(up.error.message)) return alert('Ø£Ù†Ø´Ø¦ bucket Ø§Ø³Ù…Ù‡ student-docs ÙÙŠ Supabase.');
        throw up.error;
      }
      return up.data; // { path }
    }catch(err){ alert('Storage error: '+err.message); return null; }
  }
  window.Daybook.uploadStudentFile = uploadStudentFile;

  /* ================== Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ================== */
  function refreshAttendanceSummary(){
    const b=$('#a_summary'); if(!b) return;
    const date=$('#a_date')?.value||'', cls=$('#a_class')?.value||'';
    const sessions=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&(!date||s.date===date));
    b.textContent=`Ø¬Ù„Ø³Ø§Øª: ${sessions.length}`;
  }
  $('#a_date')?.addEventListener('change', refreshAttendanceSummary);
  $('#a_class')?.addEventListener('change', refreshAttendanceSummary);

  /* ================== Ø´Ø±ÙŠØ· Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ================== */
  function refreshReportStats(){
    const badge=$('#rp_stats'); if(!badge) return;
    const from=$('#rp_from')?.value||'0000-00-00', to=$('#rp_to')?.value||'9999-12-31', cls=$('#rp_class')?.value||'';
    const sess=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&s.date>=from&&s.date<=to);
    const totalEntries=sess.reduce((n,s)=>n+(s.entries?.length||0),0);
    const all=(d.grades||[]).filter(g=>(!cls||g.class===cls)&&g.date>=from&&g.date<=to).map(g=>+g.total||0);
    const avg=all.length?(all.reduce((a,b)=>a+b,0)/all.length).toFixed(1):'â€”';
    badge.textContent=`Ø¬Ù„Ø³Ø§Øª: ${sess.length} | Ù‚ÙŠÙˆØ¯ Ø­Ø¶ÙˆØ±: ${totalEntries} | Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: ${avg}`;
  }
  ['rp_from','rp_to','rp_class'].forEach(id=>$('#'+id)?.addEventListener('change', refreshReportStats));

  /* ================== ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ================== */
  function buildGradesAnalysis(){
    const box=$('#g_analysis'); if(!box) return;
    const cls=$('#g_class')?.value||'';
    const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
    const lastBy={}; [...(d.grades||[])].reverse().forEach(g=>{ if(!lastBy[g.studentId]) lastBy[g.studentId]=g; });
    const rows=list.map(s=>({name:s.name,total:+(lastBy[s.id]?.total||0)}));
    const top=rows.slice().sort((a,b)=>b.total-a.total).slice(0,5);
    const weak=rows.filter(r=>r.total<50).sort((a,b)=>a.total-b.total).slice(0,5);
    box.style.display='block';
    box.innerHTML=`
      <h3>ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</h3>
      <div class="grid">
        <div><strong>Ø£Ø¹Ù„Ù‰ 5:</strong><ol>${top.map(r=>`<li>${esc(r.name)} â€” ${r.total}</li>`).join('')}</ol></div>
        <div><strong>Ø¨Ø­Ø§Ø¬Ø© Ø¯Ø¹Ù… (&lt;50):</strong><ol>${weak.map(r=>`<li>${esc(r.name)} â€” ${r.total}</li>`).join('')}</ol></div>
      </div>`;
  }
  $('#g_analyze')?.addEventListener('click', buildGradesAnalysis);

  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ
  function fillGradesStudents(){
    const sel=$('#g_student'); if(!sel) return;
    const cls=$('#g_class')?.value||'';
    const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
    sel.innerHTML=list.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join('');
  }
  $('#g_class')?.addEventListener('change', ()=>{ LAST.set($('#g_class').value); fillGradesStudents(); });

  /* ================== Ø¨Ø­Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ================== */
  function hookStudentSearch(){
    const inp=$('#st_search'); if(!inp) return;
    inp.addEventListener('input', ()=>{
      const q=inp.value.trim();
      document.dispatchEvent(new CustomEvent('roster:search',{detail:{q}})); // ÙŠÙØªØ±Ø¶ Ø¬Ø¯ÙˆÙ„Ùƒ ÙŠØ³Ù…Ø¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«
    });
  }

  /* ================== Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ================== */
  function sm_fillStudents(){
    const sel=$('#sm_student'); if(!sel) return;
    const list=(d.roster||[]).filter(s=>s&&s.name);
    sel.innerHTML=list.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join('');
  }
  function sm_attendanceStats(id,from,to){
    let pr=0,ab=0,lt=0,lv=0,tot=0;
    (d.attSessions||[]).forEach(ss=>{
      if(ss.date<from||ss.date>to) return;
      const e=(ss.entries||[]).find(x=>x.studentId===id); if(!e) return;
      tot++; const s=e.status;
      if(s==='Ø­Ø§Ø¶Ø±') pr++; else if(s==='ØºØ§Ø¦Ø¨') ab++; else if(s==='Ù…ØªØ£Ø®Ø±') lt++; else if(s==='Ø§Ø³ØªØ¦Ø°Ø§Ù†') lv++;
    });
    return {present:pr, absent:ab, late:lt, leave:lv, total:tot, pct: tot?Math.round(pr/tot*100):null};
  }
  function sm_behaviorStats(id,from,to){
    let pos=0,neg=0;
    const items=(d.behavior||[]).filter(b=>b.studentId===id && b.date>=from && b.date<=to);
    items.forEach(b=>{ if(b.type==='positive') pos+=(+b.points||0); else neg+=Math.abs(+b.points||0); });
    return { pos, neg, latest: items.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,3) };
  }
  function sm_gradeStats(id,from,to){
    const rows=(d.grades||[]).filter(g=>g.studentId===id && g.date>=from && g.date<=to);
    if(!rows.length) return {best:null,last:null};
    const best=rows.slice().sort((a,b)=>(+b.total||0)-(+a.total||0))[0];
    const last=rows.slice().sort((a,b)=>b.date.localeCompare(a.date))[0];
    return {best,last};
  }
  function sm_buildText(){
    const stuId=$('#sm_student')?.value, pv=$('#sm_preview'); if(!stuId||!pv) return;
    const stu=(d.roster||[]).find(s=>s.id===stuId);
    const from=$('#sm_from')?.value||'0000-00-00', to=$('#sm_to')?.value||'9999-12-31';
    const incA=$('#sm_att')?.checked, incB=$('#sm_beh')?.checked, incG=$('#sm_grd')?.checked;
    let html=`<h2>Ù…Ø°ÙƒØ±Ø© Ø¨Ø´Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ / ${esc(stu?.name||'')}</h2>
              <div class="meta">Ø§Ù„ØµÙ: ${esc(stu?.class||'â€”')} â€” Ø§Ù„Ù…Ø¯Ø©: ${esc(from)} Ø¥Ù„Ù‰ ${esc(to)}</div>`;
    if(incA){ const A=sm_attendanceStats(stuId,from,to);
      html+=`<div class="sec"><strong>Ø£ÙˆÙ„Ù‹Ø§: Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</strong><br>
         Ø§Ù„Ø¬Ù„Ø³Ø§Øª: ${A.total||0}. Ø­Ø¶Ø±: ${A.present}, ØºÙŠØ§Ø¨: ${A.absent}, ØªØ£Ø®Ø±: ${A.late}, Ø§Ø³ØªØ¦Ø°Ø§Ù†: ${A.leave}.
         ${A.pct!=null?`Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${A.pct}%`:''}</div>`; }
    if(incB){ const B=sm_behaviorStats(stuId,from,to);
      const latest=B.latest.map(b=>`â€¢ ${esc(b.date)} â€” ${b.type==='positive'?'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ':'Ø³Ù„Ø¨ÙŠ'} (${b.points||0}): ${esc(b.category||'')} â€” ${esc(b.note||'')}`).join('<br>');
      html+=`<div class="sec"><strong>Ø«Ø§Ù†ÙŠÙ‹Ø§: Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</strong><br>
         Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ: ${B.pos}ØŒ Ø§Ù„Ø³Ù„Ø¨ÙŠ: ${B.neg}.<br>${latest?`Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:<br>${latest}`:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.'}</div>`; }
    if(incG){ const G=sm_gradeStats(stuId,from,to), L=G.last||{};
      html+=`<div class="sec"><strong>Ø«Ø§Ù„Ø«Ù‹Ø§: Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</strong><br>
         Ø£ÙØ¶Ù„ Ù…Ø¬Ù…ÙˆØ¹: ${G.best?(+G.best.total||0):'â€”'}.
         Ø£Ø­Ø¯Ø« Ø±ØµØ¯: ${esc(G.last?G.last.date:'â€”')}
         ${G.last?` â€” ÙˆØ§Ø¬Ø¨Ø§Øª ${+L.homework||0}/10ØŒ Ù…Ù‡Ø§Ù… ${+L.tasks||0}/20ØŒ Ù…Ø´Ø§Ø±ÙƒØ© ${+L.particip||0}/10ØŒ Ø§Ø®ØªØ¨Ø§Ø± ${+L.quiz||0}/20ØŒ Ù†Ù‡Ø§Ø¦ÙŠ ${+L.final||0}/40ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${+L.total||0}/100`:''}
      </div>`; }
    html+=`<div class="sec"><strong>Ø®Ù„Ø§ØµØ© ÙˆØªÙˆØµÙŠØ§Øª</strong><br>
       â€“ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚ØµÙŠØ±Ø©.<br>
       â€“ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.<br>
       â€“ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ù… ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ£Ø®Ø± Ù…Ø¨ÙƒØ±Ù‹Ø§.<br></div>
       <div style="margin-top:18px">Ø­Ø±Ø± ÙÙŠ: ${new Date().toLocaleDateString('ar')} â€” ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ____________</div>`;
    pv.innerHTML=html;
  }
  $('#sm_build')?.addEventListener('click', sm_buildText);
  $('#sm_print')?.addEventListener('click', ()=>window.print());
  (function(){ const t=new Date().toISOString().slice(0,10); if($('#sm_from')&&!$('#sm_from').value) $('#sm_from').value=t; if($('#sm_to')&&!$('#sm_to').value) $('#sm_to').value=t; })();

  /* ================== Ù†Ù‚Ø§Ø· Ø±Ø¨Ø· Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ================== */
  function afterRosterChanged(){ sm_fillStudents(); hookStudentSearch(); fillGradesStudents(); }
  function afterAttendanceChanged(){ refreshAttendanceSummary(); }
  function afterReportFiltersChanged(){ refreshReportStats(); }
  function afterGradesChanged(){ /* Ù„Ø§ Ø´ÙŠØ¡ ÙÙˆØ±ÙŠ */ }

  // ÙƒØ´ÙÙ‡Ø§ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ ÙƒÙŠ ÙŠÙ†Ø§Ø¯ÙŠÙ‡Ø§ ÙƒÙˆØ¯Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Supabase
  window.Daybook = Object.assign(window.Daybook||{}, {
    LAST, afterRosterChanged, afterAttendanceChanged, afterReportFiltersChanged, afterGradesChanged
  });

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  afterRosterChanged(); afterAttendanceChanged(); afterReportFiltersChanged();

  // Ø­Ù…Ø§ÙŠØ© Ù…Ù† ØªØ¹Ø±ÙŠÙ buildGrades Ø§Ù„ÙØ§Ø±Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…
  if (typeof window.buildGrades==='function' && String(window.buildGrades).length<50){
    try{ delete window.buildGrades; }catch{}
  }
})();
</script>