<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Daybook — Supabase</title>

  <!-- فافيكون بسيط -->
  <link rel="icon" href="data:image/svg+xml,
  %3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E
  %3Crect width='64' height='64' rx='10' fill='%230a3440'/%3E
  %3Ctext x='50%' y='50%' font-family='Arial,Segoe UI,Roboto' font-weight='700'
         font-size='28' fill='white' text-anchor='middle' dominant-baseline='central'%3ESD%3C/text%3E
  %3C/svg%3E" type="image/svg+xml" />

  <!-- ستايل خفيف -->
  <style>
    :root{
      --ink:#0a3440; --ink-2:#124a5a; --bg:#f5f7fa; --card:#fff;
      --muted:#6b7280; --ok:#16a34a; --warn:#ca8a04; --err:#dc2626;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:#111;font-family:"Noto Sans Arabic","Segoe UI",system-ui,Arial}
    header{background:var(--ink);color:#fff;padding:16px 12px}
    header .title{font-weight:800;letter-spacing:.3px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px;background:#e9f1f4}
    .tab{border:none;background:#dce9ee;color:#0b3a47;padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:600}
    .tab.active{background:#0b3a47;color:#fff}
    .wrap{max-width:1100px;margin:12px auto;padding:0 12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,.06);padding:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{font:inherit}
    input,select{width:100%;padding:9px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
    .btn{padding:9px 14px;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .btn.primary{background:#0b3a47;color:#fff;border-color:#0b3a47}
    .btn.ghost{background:#ecf3f6}
    .muted{color:var(--muted);font-size:.92rem}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;background:#fff}
    th{color:#475569;background:#eef5f8;font-weight:700}
    tr td:first-child, tr th:first-child{border-radius:12px 0 0 12px}
    tr td:last-child,  tr th:last-child{border-radius:0 12px 12px 0}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#eef5f8;color:#0b3a47;font-weight:700}
    .alert{padding:10px 12px;border-radius:10px;margin:8px 0}
    .alert.ok{background:#ecfdf5;color:#065f46}
    .alert.err{background:#fef2f2;color:#991b1b}
    .hidden{display:none}
  </style>

  <!-- مكتبة Supabase يجب أن تُحمّل قبل أي استعمال -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>

  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div class="title">School Daybook — Supabase</div>
        <button id="btnSync" class="btn ghost" title="اختبار الاتصال">⟳ Sync</button>
      </div>
    </div>
  </header>

  <div class="bar wrap">
    <button class="tab active" data-tab="students">الطلاب</button>
    <button class="tab" data-tab="attendance">الحضور</button>
    <button class="tab" data-tab="behavior">السلوك</button>
    <button class="tab" data-tab="grades">الدرجات</button>
    <button class="tab" data-tab="reports">التقارير</button>
    <button class="tab" data-tab="attachments">المرفقات</button>
  </div>

  <main class="wrap" id="app">

    <!-- تبويب الطلاب -->
    <section id="tab-students" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:6px 0">إدارة الطلاب</h3>
        <span id="studentsCount" class="muted"></span>
      </div>

      <div class="grid" style="margin-top:8px">
        <div><input id="inName" placeholder="اسم الطالب"/></div>
        <div><input id="inClass" placeholder="الصف/الشعبة: مثال ٦/ب"/></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnAdd" class="btn primary">إضافة</button>
        <span class="muted">* الترتيب أبجدي عربي في العرض فقط</span>
      </div>

      <div id="studentsAlert" class="alert hidden"></div>

      <div style="margin-top:14px;overflow:auto">
        <table id="studentsTable">
          <thead>
            <tr>
              <th style="width:72px;text-align:center">#</th>
              <th>الاسم</th>
              <th style="width:200px">الصف</th>
            </tr>
          </thead>
          <tbody><!-- يمتلئ ديناميكيًا --></tbody>
        </table>
      </div>
    </section>

    <!-- تبويبات جاهزة بدون منطق بعد -->
    <section id="tab-attendance" class="card hidden"><div class="muted">قسم الحضور — جاهز للإكمال لاحقًا.</div></section>
    <section id="tab-behavior"   class="card hidden"><div class="muted">قسم السلوك — جاهز للإكمال لاحقًا.</div></section>
    <section id="tab-grades"     class="card hidden"><div class="muted">قسم الدرجات — جاهز للإكمال لاحقًا.</div></section>
    <section id="tab-reports"    class="card hidden"><div class="muted">قسم التقارير — جاهز للإكمال لاحقًا.</div></section>
    <section id="tab-attachments" class="card hidden"><div class="muted">قسم المرفقات — جاهز للإكمال لاحقًا.</div></section>

  </main>

  <!-- سكربت التطبيق (بدون Babel) -->
  <script>
  (function(){
    // مفاتيحك (anon public) — انت طلبت تضمينها هنا
    const SUPABASE_URL = "https://alamidjtlxuquvjvvcac.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU";

    // إنشاء العميل — تأكد أن المكتبة فوق هذا السكربت
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // عناصر DOM
    const tabsBtns = document.querySelectorAll(".tab");
    const sections = {
      students: document.getElementById("tab-students"),
      attendance: document.getElementById("tab-attendance"),
      behavior: document.getElementById("tab-behavior"),
      grades: document.getElementById("tab-grades"),
      reports: document.getElementById("tab-reports"),
      attachments: document.getElementById("tab-attachments"),
    };
    const inName   = document.getElementById("inName");
    const inClass  = document.getElementById("inClass");
    const btnAdd   = document.getElementById("btnAdd");
    const tBody    = document.querySelector("#studentsTable tbody");
    const studentsAlert = document.getElementById("studentsAlert");
    const studentsCount = document.getElementById("studentsCount");
    const btnSync  = document.getElementById("btnSync");

    // أداة رسائل
    function showMsg(el, text, kind){
      el.textContent = text;
      el.className = "alert " + (kind === "err" ? "err" : "ok");
      el.classList.remove("hidden");
      setTimeout(()=> el.classList.add("hidden"), 3000);
    }

    // ترتيب أبجدي عربي في الواجهة
    function sortArabic(list, key){
      const collator = new Intl.Collator("ar", {sensitivity:"base"});
      return list.slice().sort((a,b)=> collator.compare(a[key] || "", b[key] || ""));
    }

    // تحميل الطلاب
    async function loadStudents(){
      tBody.innerHTML = "<tr><td colspan='3' class='muted'>جاري التحميل…</td></tr>";
      const { data, error } = await sb.from("students").select("id,name,klass");
      if(error){
        tBody.innerHTML = "";
        console.error(error);
        showMsg(studentsAlert,
          "لا يمكن قراءة جدول الطلاب. تأكد أن جدول students موجود ومفعل RLS/السياسات كما جهزناه سابقًا.",
          "err");
        return;
      }
      const rows = sortArabic(data || [], "name");
      studentsCount.textContent = rows.length ? `عدد الطلاب: ${rows.length}` : "";
      tBody.innerHTML = rows.map((r,idx)=>`
        <tr>
          <td style="text-align:center"><span class="pill">${idx+1}</span></td>
          <td>${escapeHtml(r.name||"")}</td>
          <td>${escapeHtml(r.klass||"")}</td>
        </tr>
      `).join("");
    }

    // إضافة طالب
    async function addStudent(){
      const name = (inName.value || "").trim();
      const klass = (inClass.value || "").trim();
      if(!name){ inName.focus(); return; }
      const { error } = await sb.from("students").insert({ name, klass });
      if(error){
        console.error(error);
        showMsg(studentsAlert, "فشل حفظ الطالب: " + error.message, "err");
        return;
      }
      inName.value = ""; inClass.value = "";
      await loadStudents();
      showMsg(studentsAlert, "تمت إضافة الطالب.", "ok");
    }

    // Sync اختبار اتصال سريع
    async function quickSync(){
      btnSync.disabled = true; btnSync.textContent = "⟳";
      const { error } = await sb.from("students").select("id").limit(1);
      if(error){ alert("Supabase ERROR: " + error.message); }
      else{ alert("Supabase OK ✅"); }
      btnSync.disabled = false; btnSync.textContent = "⟳ Sync";
    }

    // تبويب
    function activateTab(name){
      tabsBtns.forEach(b=> b.classList.toggle("active", b.dataset.tab===name));
      Object.entries(sections).forEach(([k,sec])=>{
        sec.classList.toggle("hidden", k!==name);
      });
    }

    // حماية ضد HTML داخل الحقول
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    // أحداث
    btnAdd.addEventListener("click", addStudent);
    btnSync.addEventListener("click", quickSync);
    tabsBtns.forEach(b=> b.addEventListener("click", ()=> activateTab(b.dataset.tab)));

    // تشغيل
    activateTab("students");
    loadStudents();
  })();
  </script>
</body>
</html>
