<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>School Daybook — No-Auth (Pages + Supabase)</title>
<meta name="theme-color" content="#0ea5e9" />
<style>
:root{--bg:#0f172a;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e5e7eb;--primary:#0ea5e9;--success:#10b981;--warn:#ef4444}
*{box-sizing:border-box}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans Arabic',sans-serif;background:#f1f5f9;color:var(--ink)}
header{background:var(--bg);color:#fff;padding:12px 16px}
header h1{margin:0 0 4px 0;font-size:18px}
nav{display:flex;gap:6px;background:#e2e8f0;padding:8px 12px;flex-wrap:wrap;align-items:center}
nav button{border:0;background:#cbd5e1;padding:8px 12px;border-radius:8px;cursor:pointer}
nav button.active{background:#fff}
main{padding:12px}
.panel{display:none}.panel.active{display:block}
.section{background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.grid .wide{grid-column:1/-1}
.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.table th,.table td{padding:8px;border-bottom:1px solid var(--line);text-align:right;font-size:14px}
.table thead th{background:#f8fafc;cursor:pointer}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.controls button,.controls label.import{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.secondary{background:var(--success);color:#fff;border-color:var(--success)}
.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
small.muted{color:#64748b}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
#syncStatus{font-size:12px;color:#334155}
a.btn{padding:4px 8px;border:1px solid var(--line);border-radius:6px;text-decoration:none}
.disabled{opacity:.6;pointer-events:none}
</style>
<style media="print">
  header, nav, .controls { display:none !important; }
  body { background:#fff; }
  .section { border:none; box-shadow:none; }
  @page { size: A4 portrait; margin: 12mm; }
  table.table { font-size:12px; }
</style>
</head>
<body>
<header>
  <h1>School Daybook — No-Auth</h1>
  <div id="syncStatus">Sync: idle</div>
</header>

<nav id="tabs">
  <button data-tab="students" class="active">الطلاب</button>
  <button data-tab="attendance">الحضور</button>
  <button data-tab="behavior">السلوك</button>
  <button data-tab="grades">الدرجات</button>
  <button data-tab="reports">التقارير</button>
  <button data-tab="analytics">التحليل</button>
  <button data-tab="guardians">أولياء الأمور</button>
  <button data-tab="settings">إعدادات</button>
  <span style="flex:1"></span>
  <button id="syncBtn" class="secondary">Sync ↕︎</button>
</nav>

<main>
  <!-- الطلاب -->
  <section id="panel-students" class="panel active">
    <div class="section">
      <div class="grid">
        <label>اسم الطالب<input id="st_name" /></label>
        <label>المعرّف (اختياري)<input id="st_code" /></label>
        <label>الصف/الشعبة<input id="st_class" /></label>
        <div class="wide controls">
          <button id="st_add" class="primary">إضافة</button>
          <button id="st_pull">سحب من السحابة</button>
          <button id="st_push">رفع للسحابة</button>
          <label class="import">استيراد CSV<input type="file" id="st_csv" accept=".csv,text/csv" /></label>
        </div>
      </div>
    </div>

    <div class="section">
      <table class="table" id="st_table">
        <thead><tr><th>#</th><th>الاسم</th><th>المعرف</th><th>الصف/الشعبة</th><th>إجراءات</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h3 style="margin-top:0">مرفقات الطالب</h3>
      <div class="grid">
        <label>اختر الطالب
          <select id="st_for_upload"></select>
        </label>
        <label>اختر ملفًا
          <input type="file" id="st_file" />
        </label>
        <div class="wide controls">
          <button id="st_upload" class="primary">رفع الملف</button>
          <button id="st_list">تحديث قائمة الملفات</button>
        </div>
      </div>
      <table class="table" id="files_table">
        <thead><tr><th>#</th><th>الاسم</th><th>الحجم</th><th>التاريخ</th><th>تحميل/نسخ</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
      <small class="muted">تُرفع الملفات إلى <code>student-docs</code> (عام). الروابط لأي شخص يملك الرابط.</small>
    </div>
  </section>

  <!-- الحضور -->
  <section id="panel-attendance" class="panel">
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="a_class"></select></label>
        <label>التاريخ<input type="date" id="a_date" /></label>
      </div>
      <div class="controls">
        <button id="all_present">الكل حاضر</button>
        <button id="all_absent">الكل غائب</button>
        <button id="toggle_pa">قلب</button>
        <button id="a_save" class="primary">حفظ الجلسة</button>
        <button id="a_pull">سحب</button>
        <button id="a_push">رفع</button>
        <span id="a_msg" class="muted"></span>
      </div>
      <table class="table" id="a_table">
        <thead><tr><th>#</th><th>الطالب</th><th>الحالة</th><th>ملاحظة</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ملخص الجلسات -->
    <div class="section">
      <h4 style="margin-top:0">ملخّص الجلسات</h4>
      <div class="controls"><button id="a_build_summary">تحديث الملخص</button></div>
      <table class="table" id="a_sum">
        <thead><tr><th>التاريخ</th><th>الصف</th><th>حاضر</th><th>غائب</th><th>متأخر</th><th>استئذان</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- السلوك -->
  <section id="panel-behavior" class="panel">
    <div class="section">
      <div class="grid">
        <label>التاريخ<input type="date" id="b_date" /></label>
        <label>الطالب<select id="b_student"></select></label>
        <label>النوع
          <select id="b_type"><option value="positive">سلوك إيجابي</option><option value="negative">سلوك سلبي</option></select>
        </label>
        <label>الفئة<input id="b_cat" placeholder="انضباط/تعاون..." /></label>
        <label>النقاط<input type="number" id="b_points" value="1" /></label>
        <label class="wide">ملاحظة<textarea id="b_note" rows="2"></textarea></label>
        <div class="wide controls">
          <button id="b_add" class="primary">إضافة</button>
          <button id="b_pull">سحب</button>
          <button id="b_push">رفع</button>
        </div>
      </div>
    </div>
    <div class="section">
      <table class="table" id="b_table">
        <thead><tr><th>#</th><th>التاريخ</th><th>الطالب</th><th>النوع</th><th>الفئة</th><th>النقاط</th><th>ملاحظة</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- الدرجات -->
  <section id="panel-grades" class="panel">
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="g_class"></select></label>
        <label>التاريخ<input type="date" id="g_date" /></label>
      </div>
      <table class="table" id="g_table">
        <thead><tr>
          <th>#</th><th>الطالب</th>
          <th>واجبات (10)</th><th>مهام أدائية (20)</th><th>مشاركة (10)</th><th>اختبار قصير (20)</th><th>نهائي (40)</th><th>المجموع</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="controls">
        <button id="g_save" class="primary">حفظ</button>
        <button id="g_pull">سحب</button>
        <button id="g_push">رفع</button>
      </div>
    </div>
  </section>

  <!-- التقارير -->
  <section id="panel-reports" class="panel">
    <div class="section" id="kpibox">
      <div class="grid">
        <div><div class="badge">عدد الطلاب</div><div id="kpi_students" style="font-size:22px;font-weight:700">0</div></div>
        <div><div class="badge">نسبة الحضور (آخر جلسة)</div><div id="kpi_att" style="font-size:22px;font-weight:700">—</div></div>
        <div><div class="badge">متوسط أعلى مجموع</div><div id="kpi_best" style="font-size:22px;font-weight:700">—</div></div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="rp_class"></select></label>
        <label>من<input type="date" id="rp_from" /></label>
        <label>إلى<input type="date" id="rp_to" /></label>
        <div class="wide controls">
          <button id="rp_term1">الفصل الأول</button>
          <button id="rp_term2">الفصل الثاني</button>
          <button id="rp_run" class="primary">توليد تقرير</button>
          <button id="rp_print">طباعة</button>
        </div>
      </div>
      <table class="table" id="rp_table">
        <thead><tr><th>#</th><th>الطالب</th><th>حضور</th><th>غياب</th><th>استئذان</th><th>إيجابي</th><th>سلبي</th><th>أعلى مجموع</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- التحليل -->
  <section id="panel-analytics" class="panel">
    <div class="section">
      <div class="grid">
        <label>الصف/الشعبة<select id="an_class"></select></label>
        <label>من<input type="date" id="an_from"></label>
        <label>إلى<input type="date" id="an_to"></label>
        <div class="wide controls"><button id="an_run" class="primary">تحليل</button></div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div><div class="badge">متوسط المجموع</div><div id="an_avg" style="font-size:22px;font-weight:700">—</div></div>
        <div><div class="badge">أعلى مجموع</div><div id="an_max" style="font-size:22px;font-weight:700">—</div></div>
        <div><div class="badge">أدنى مجموع</div><div id="an_min" style="font-size:22px;font-weight:700">—</div></div>
        <div><div class="badge">انحراف معياري</div><div id="an_std" style="font-size:22px;font-weight:700">—</div></div>
      </div>
    </div>
    <div class="section">
      <h4 style="margin-top:0">تفصيل المكوّنات</h4>
      <table class="table" id="an_break">
        <thead><tr><th>المكوّن</th><th>متوسط</th><th>أعلى</th><th>أدنى</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="section">
      <h4 style="margin-top:0">أفضل 10 طلاب</h4>
      <table class="table" id="an_top">
        <thead><tr><th>#</th><th>الطالب</th><th>أفضل مجموع</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- أولياء الأمور -->
  <section id="panel-guardians" class="panel">
    <div class="section">
      <h3 style="margin-top:0">إدارة أولياء الأمور</h3>
      <div class="grid">
        <label>اسم الولي<input id="gdn_name"></label>
        <label>جوال/واتساب<input id="gdn_phone" placeholder="05xxxxxxxx"></label>
        <label>البريد<input id="gdn_email" type="email"></label>
        <div class="wide controls">
          <button id="gdn_add" class="primary">إضافة</button>
          <button id="gdn_pull">سحب</button>
          <button id="gdn_push">رفع</button>
        </div>
      </div>
      <table class="table" id="gdn_table">
        <thead><tr><th>#</th><th>الاسم</th><th>الهاتف</th><th>البريد</th><th>ربط طالب</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h4>سجل التواصل</h4>
      <div class="grid">
        <label>الطالب<select id="cl_student"></select></label>
        <label>الولي<select id="cl_guardian"></select></label>
        <label>القناة
          <select id="cl_channel">
            <option value="call">اتصال</option>
            <option value="whatsapp">واتساب</option>
            <option value="sms">SMS</option>
            <option value="email">Email</option>
          </select>
        </label>
        <label class="wide">ملاحظات<textarea id="cl_notes" rows="2"></textarea></label>
        <div class="wide controls">
          <button id="cl_add" class="primary">تسجيل</button>
          <button id="cl_pull">سحب</button>
          <button id="cl_push">رفع</button>
        </div>
      </div>
      <table class="table" id="cl_table">
        <thead><tr><th>#</th><th>التاريخ</th><th>الطالب</th><th>الولي</th><th>القناة</th><th>الملاحظة</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- الإعدادات -->
  <section id="panel-settings" class="panel">
    <div class="section">
      <div class="grid">
        <label>اسم المدرسة<input id="s_school" /></label>
        <label>اسم الموقّع<input id="s_signer" /></label>
        <label class="wide">شعار المدرسة (اختياري)<input type="file" id="s_logo" accept="image/*" /></label>
        <div class="wide"><small class="muted">الفصل الأول: 1447/03/01 → 1447/07/20 — الفصل الثاني: 1447/07/29 → 1448/01/10</small></div>
      </div>
      <div class="controls">
        <button id="s_save" class="primary">حفظ</button>
        <button id="s_export">تصدير JSON</button>
        <label class="import">استيراد JSON<input type="file" id="s_import" accept="application/json" /></label>
      </div>
    </div>

    <!-- النسخ الاحتياطي/الاستعادة -->
    <div class="section">
      <h3 style="margin-top:0">النسخ الاحتياطي / الاستعادة</h3>
      <div class="grid">
        <label>وسم اللقطة (اختياري)<input id="bk_label" placeholder="قبل اختبار الفترة / بعد إدخال الدرجات" /></label>
        <div class="wide controls">
          <button id="bk_local_export">تنزيل نسخة محلية (JSON)</button>
          <button id="bk_cloud_save" class="primary">حفظ لقطة إلى السحابة</button>
          <button id="bk_refresh">تحديث قائمة اللقطات</button>
        </div>
      </div>
      <table class="table" id="bk_table">
        <thead>
          <tr><th>#</th><th>الملف</th><th>التاريخ</th><th>الحجم</th><th>وسم</th><th>استعادة</th><th>تنزيل</th><th>حذف</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <small class="muted">اللقطات تُحفظ في Bucket <code>backups</code> كملفات JSON عامة الرابط (وضع No-Auth).</small>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/*** Supabase ***/
const SUPABASE_URL='https://alamidjtlxuquvjvvcac.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU';
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET='student-docs';      // عام للملفات
const BK_BUCKET='backups';        // عام للقطات

/*** Helpers / Local storage ***/
const DBKEY='daybook_cloud_v1', BRAND='daybook_brand_v1';
const $=(q,r=document)=>r.querySelector(q), $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const esc=(s)=>String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
const today=()=>new Date().toISOString().slice(0,10);
const syncNote=(t)=>{$('#syncStatus').textContent='Sync: '+t};

function load(){try{return JSON.parse(localStorage.getItem(DBKEY)||'{}')}catch{return{}}}
function save(d){localStorage.setItem(DBKEY,JSON.stringify(d))}
function ensure(){
  const d=load();
  d.roster=d.roster||[]; d.attSessions=d.attSessions||[]; d.behavior=d.behavior||[];
  d.grades=d.grades||[]; d.events=d.events||[];
  d.guardians=d.guardians||[]; d.studentGuardians=d.studentGuardians||[]; d.contactLogs=d.contactLogs||[];
  d.terms=d.terms||{t1:{from:'',to:'',fromH:'1447/03/01',toH:'1447/07/20'},t2:{from:'',to:'',fromH:'1447/07/29',toH:'1448/01/10'}};
  save(d); return d;
}
const d=ensure();

/*** Tabs ***/
$$('#tabs button[data-tab]').forEach(btn=>{
  btn.onclick=()=>{$$('#tabs button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  $$('.panel').forEach(p=>p.classList.remove('active'));$('#panel-'+btn.dataset.tab).classList.add('active');};
});

/*** No-Auth UI ***/
function initNoAuthUI(){
  ['#st_push','#a_push','#b_push','#g_push','#st_upload','#st_list','#syncBtn','#gdn_push','#cl_push']
    .forEach(id=>{const el=$(id); if(el){ el.classList.remove('disabled'); el.disabled=false; }});
  syncNote('no-auth mode');
}

/*** الطلاب ***/
function renderStudents(){
  const tb=$('#st_table tbody'); tb.innerHTML='';
  d.roster.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td></td><td></td><td></td>
      <td><button data-e="">تعديل</button> <button data-x="">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.roster=d.roster.filter(x=>x.id!==b.dataset.x); save(d); renderStudents(); fillAllDropdowns(); refreshKPIs(); });
  tb.querySelectorAll('[data-e]').forEach(b=>b.onclick=()=>{ const s=d.roster.find(x=>x.id===b.dataset.e); if(!s) return;
    const name=prompt('الاسم:',s.name)||s.name; const cls=prompt('الصف/الشعبة:',s.class||'')||''; s.name=name; s.class=cls; save(d); renderStudents(); fillAllDropdowns(); refreshKPIs(); });
}
$('#st_add').onclick=()=>{
  const name=$('#st_name').value.trim(); if(!name) return alert('أدخل الاسم');
  d.roster.push({id:crypto.randomUUID(), code:$('#st_code').value.trim()||'', name, class:$('#st_class').value.trim()});
  save(d); $('#st_name').value=''; $('#st_code').value=''; $('#st_class').value='';
  renderStudents(); fillAllDropdowns(); refreshKPIs();
};
$('#st_pull').onclick=async()=>{ syncNote('pulling students…');
  const {data,error}=await supa.from('students').select('*').order('created_at'); if(error){alert(error.message); return}
  d.roster=data.map(r=>({id:r.id, code:r.code, name:r.name, class:r.class})); save(d); renderStudents(); fillAllDropdowns(); refreshKPIs(); fillAnalyticsDropdown(); syncNote('pulled');
};
$('#st_push').onclick=async()=>{ syncNote('pushing students…');
  await supa.from('students').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.roster.length){ const rows=d.roster.map(s=>({id:s.id,code:s.code,name:s.name,class:s.class}));
    const {error}=await supa.from('students').insert(rows); if(error) return alert(error.message); }
  refreshKPIs(); fillAnalyticsDropdown(); syncNote('pushed');
};
/*** CSV ***/
$('#st_csv').onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  const rows = txt.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
  const header = rows[0].toLowerCase().split(',');
  const iName = header.indexOf('name'), iClass = header.indexOf('class'), iCode = header.indexOf('code');
  if(iName===-1) return alert('CSV يجب أن يحتوي عمود name (ويمكن class, code)');
  for(let i=1;i<rows.length;i++){
    const cols = rows[i].split(',');
    const name=(cols[iName]||'').trim(); if(!name) continue;
    const cls = iClass>-1 ? (cols[iClass]||'').trim() : '';
    const code= iCode>-1 ? (cols[iCode]||'').trim() : '';
    d.roster.push({id:crypto.randomUUID(), name, class:cls, code});
  }
  save(d); renderStudents(); fillAllDropdowns(); refreshKPIs(); fillAnalyticsDropdown(); alert('تم الاستيراد');
};
function fillAllDropdowns(){
  const classes=[...new Set(d.roster.map(s=>s.class).filter(Boolean))];
  $('#a_class').innerHTML='<option value="">— الكل —</option>'+classes.map(c=>`<option></option>`).join('');
  $('#g_class').innerHTML='<option value="">— الكل —</option>'+classes.map(c=>`<option></option>`).join('');
  $('#rp_class').innerHTML='<option value="">— الكل —</option>'+classes.map(c=>`<option></option>`).join('');
  $('#an_class').innerHTML='<option value="">— الكل —</option>'+classes.map(c=>`<option></option>`).join('');
  $('#b_student').innerHTML=d.roster.map(s=>`<option value=""> ()</option>`).join('');
  $('#st_for_upload').innerHTML=d.roster.map(s=>`<option value=""> ()</option>`).join('');
  $('#cl_student').innerHTML=d.roster.map(s=>`<option value=""></option>`).join('');
}

/*** الحضور ***/
$('#a_date').value=today();
function buildAttendance(){
  const cls=$('#a_class').value; const list=d.roster.filter(s=>!cls || s.class===cls);
  const tb=$('#a_table tbody'); tb.innerHTML='';
  list.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td></td>
      <td><select data-s=""><option value=""></option><option>حاضر</option><option>غائب</option><option>متأخر</option><option>استئذان</option></select></td>
      <td><input data-n="" placeholder="ملاحظة" /></td>`;
    tb.appendChild(tr);
  });
}
$('#a_class').onchange=buildAttendance;
$('#all_present').onclick=()=> $$('#a_table select').forEach(s=>s.value='حاضر');
$('#all_absent').onclick=()=> $$('#a_table select').forEach(s=>s.value='غائب');
$('#toggle_pa').onclick=()=> $$('#a_table select').forEach(s=> s.value=(s.value==='حاضر'?'غائب':'حاضر'));
$('#a_save').onclick=()=>{
  const cls=$('#a_class').value, date=$('#a_date').value;
  const rows=$$('#a_table tbody tr'); const entries=[];
  rows.forEach(r=>{
    const sid=r.querySelector('select').dataset.s, st=r.querySelector('select').value, note=r.querySelector('input').value.trim();
    if(st||note) entries.push({studentId:sid,status:st,note});
  });
  if(!entries.length) return alert('لا بيانات');
  d.attSessions.push({id:crypto.randomUUID(), date, class:cls, entries});
  save(d); $('#a_msg').textContent='تم الحفظ'; setTimeout(()=>$('#a_msg').textContent='',1500);
};
$('#a_pull').onclick=async()=>{ syncNote('pulling attendance…');
  const {data:sess,error:sErr}=await supa.from('attendance_sessions').select('*').order('date'); if(sErr) return alert(sErr.message);
  const {data:ents,error:eErr}=await supa.from('attendance_entries').select('*'); if(eErr) return alert(eErr.message);
  const byId={}; sess.forEach(s=>byId[s.id]={id:s.id,date:String(s.date),class:s.class,entries:[]});
  ents.forEach(e=>{ if(byId[e.session_id]) byId[e.session_id].entries.push({studentId:e.student_id,status:e.status,note:e.note||''}) });
  d.attSessions=Object.values(byId); save(d); buildAttendance(); buildAttendanceSummary(); refreshKPIs(); syncNote('pulled');
};
$('#a_push').onclick=async()=>{ syncNote('pushing attendance…');
  await supa.from('attendance_entries').delete().neq('id','00000000-0000-0000-0000-000000000000');
  await supa.from('attendance_sessions').delete().neq('id','00000000-0000-0000-0000-000000000000');
  for(const s of d.attSessions){
    await supa.from('attendance_sessions').insert({id:s.id,date:s.date,class:s.class});
    if(s.entries?.length){
      const rows=s.entries.map(e=>({session_id:s.id,student_id:e.studentId,status:e.status||null,note:e.note||null}));
      if(rows.length){ const {error}=await supa.from('attendance_entries').insert(rows); if(error) return alert(error.message); }
    }
  }
  buildAttendanceSummary(); refreshKPIs(); syncNote('pushed');
};
function buildAttendanceSummary(){
  const rows={};
  d.attSessions.forEach(ss=>{
    const key=(ss.date||'')+'|'+(ss.class||'');
    if(!rows[key]) rows[key]={date:ss.date,class:ss.class, حاضر:0, غائب:0, متأخر:0, استئذان:0};
    (ss.entries||[]).forEach(e=>{
      if(e.status && rows[key][e.status]>=0) rows[key][e.status]+=1;
    });
  });
  const tb=$('#a_sum tbody'); tb.innerHTML='';
  Object.values(rows).sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td></td><td></td><td></td><td></td><td></td>`;
    tb.appendChild(tr);
  });
}
$('#a_build_summary').onclick=buildAttendanceSummary;

/*** السلوك ***/
$('#b_date').value=today();
$('#b_add').onclick=()=>{ const e={id:crypto.randomUUID(),date:$('#b_date').value,studentId:$('#b_student').value,type:$('#b_type').value,category:$('#b_cat').value.trim(),points:Number($('#b_points').value)||0,note:$('#b_note').value.trim()};
  d.behavior.push(e); save(d); renderBehavior(); $('#b_note').value='';};
function renderBehavior(){
  const tb=$('#b_table tbody'); tb.innerHTML='';
  d.behavior.forEach((e,i)=>{ const s=d.roster.find(x=>x.id===e.studentId);
    tb.innerHTML+=`<tr><td></td><td></td><td>'?')</td><td>'سلبي'</td><td></td><td></td><td></td><td><button data-x="">🗑</button></td></tr>`; });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.behavior=d.behavior.filter(x=>x.id!==b.dataset.x); save(d); renderBehavior(); });
}
$('#b_pull').onclick=async()=>{ syncNote('pulling behavior…');
  const {data,error}=await supa.from('behavior').select('*').order('date'); if(error) return alert(error.message);
  d.behavior=data.map(x=>({id:x.id,date:String(x.date),studentId:x.student_id,type:x.type,category:x.category,points:x.points||0,note:x.note||''})); save(d); renderBehavior(); refreshKPIs(); syncNote('pulled'); };
$('#b_push').onclick=async()=>{ syncNote('pushing behavior…');
  await supa.from('behavior').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.behavior.length){ const rows=d.behavior.map(e=>({id:e.id,date:e.date,student_id:e.studentId,type:e.type,category:e.category,points:e.points||0,note:e.note||null}));
    const {error}=await supa.from('behavior').insert(rows); if(error) return alert(error.message); }
  refreshKPIs(); syncNote('pushed');
};

/*** الدرجات ***/
$('#g_date').value=today();
function buildGrades(){
  const cls=$('#g_class').value; const list=d.roster.filter(s=>!cls || s.class===cls);
  const tb=$('#g_table tbody'); tb.innerHTML='';
  list.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td></td>
      <td><input type="number" min="0" max="10" step="1" data-k="homework" data-s=""></td>
      <td><input type="number" min="0" max="20" step="1" data-k="tasks" data-s=""></td>
      <td><input type="number" min="0" max="10" step="1" data-k="particip" data-s=""></td>
      <td><input type="number" min="0" max="20" step="1" data-k="quiz" data-s=""></td>
      <td><input type="number" min="0" max="40" step="1" data-k="final" data-s=""></td>
      <td data-total="">0</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input').forEach(inp=>inp.oninput=()=>{ const sid=inp.dataset.s; const vals={homework:0,tasks:0,particip:0,quiz:0,final:0};
    tb.querySelectorAll(`input[data-s=""]`).forEach(el=>{ vals[el.dataset.k]=Number(el.value)||0; });
    tb.querySelector(`[data-total=""]`).textContent=vals.homework+vals.tasks+vals.particip+vals.quiz+vals.final; });
}
$('#g_class').onchange=buildGrades;
$('#g_save').onclick=()=>{
  const limits={homework:10,tasks:20,particip:10,quiz:20,final:40};
  const cls=$('#g_class').value, date=$('#g_date').value; const rows=$$('#g_table tbody tr'); const recs=[]; let ok=true;
  rows.forEach(r=>{
    const sid=r.querySelector('input').dataset.s;
    const get=(k)=>Number(r.querySelector(`input[data-k=""][data-s=""]`).value)||0;
    const vals={homework:get('homework'),tasks:get('tasks'),particip:get('particip'),quiz:get('quiz'),final:get('final')};
    for(const k in vals){ const el=r.querySelector(`input[data-k=""]`); if(vals[k]>limits[k]||vals[k]<0){ ok=false; el.style.background='#fee2e2'; } else el.style.background=''; }
    recs.push({id:crypto.randomUUID(),date,studentId:sid,class:cls,...vals,total:vals.homework+vals.tasks+vals.particip+vals.quiz+vals.final});
  });
  if(!ok) return alert('تحقق من الحدود القصوى (10/20/10/20/40)');
  d.grades=d.grades.filter(g=>!(g.date===date && g.class===cls)); d.grades.push(...recs); save(d); alert('تم الحفظ');
};
$('#g_pull').onclick=async()=>{ syncNote('pulling grades…');
  const {data,error}=await supa.from('grades').select('*').order('date'); if(error) return alert(error.message);
  d.grades=data.map(g=>({id:g.id,date:String(g.date),studentId:g.student_id,class:g.class,homework:g.homework||0,tasks:g.tasks||0,particip:g.particip||0,quiz:g.quiz||0,final:g.final||0,total:g.total||0}));
  save(d); refreshKPIs(); fillAnalyticsDropdown(); syncNote('pulled');
};
$('#g_push').onclick=async()=>{ syncNote('pushing grades…');
  await supa.from('grades').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.grades.length){ const rows=d.grades.map(g=>({id:g.id,date:g.date,student_id:g.studentId,class:g.class,homework:g.homework,tasks:g.tasks,particip:g.particip,quiz:g.quiz,final:g.final}));
    const {error}=await supa.from('grades').insert(rows); if(error) return alert(error.message); }
  refreshKPIs(); fillAnalyticsDropdown(); syncNote('pushed');
};

/*** التقارير ***/
function runReport(){
  const cls=$('#rp_class').value, from=$('#rp_from').value||'0000-00-00', to=$('#rp_to').value||'9999-12-31';
  const students=d.roster.filter(s=>!cls||s.class===cls); const body=$('#rp_table tbody'); body.innerHTML='';
  students.forEach((s,i)=>{
    let present=0,absent=0,leave=0;
    d.attSessions.filter(ss=>(!cls||ss.class===cls)&&ss.date>=from&&ss.date<=to).forEach(ss=>{
      const e=ss.entries.find(x=>x.studentId===s.id); if(!e) return;
      if(e.status==='حاضر') present++; if(e.status==='غائب') absent++; if(e.status==='استئذان') leave++;
    });
    let pos=0,neg=0;
    d.behavior.filter(b=>b.studentId===s.id && b.date>=from && b.date<=to).forEach(b=>{ if(b.type==='positive') pos+=b.points||0; else neg+=Math.abs(b.points||0); });
    const g=d.grades.filter(g=>g.studentId===s.id && g.date>=from && g.date<=to); const maxTotal=g.length?Math.max(...g.map(x=>x.total||0)):0;
    const tr=document.createElement('tr'); tr.innerHTML=`<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
    body.appendChild(tr);
  });
}
$('#rp_term1').onclick=()=>{ $('#rp_from').value=d.terms.t1.from; $('#rp_to').value=d.terms.t1.to; };
$('#rp_term2').onclick=()=>{ $('#rp_from').value=d.terms.t2.from; $('#rp_to').value=d.terms.t2.to; };
$('#rp_run').onclick=runReport;
$('#rp_print').onclick=()=>window.print();

/*** KPIs ***/
function refreshKPIs(){
  $('#kpi_students').textContent = d.roster.length;
  const last=[...d.attSessions].sort((a,b)=>b.date.localeCompare(a.date))[0];
  if(last){
    const total=(last.entries||[]).length||1;
    const present=(last.entries||[]).filter(e=>e.status==='حاضر').length;
    $('#kpi_att').textContent=Math.round((present/total)*100)+'%';
  }else $('#kpi_att').textContent='—';
  let totals=[];
  d.roster.forEach(s=>{
    const g=d.grades.filter(x=>x.studentId===s.id);
    if(g.length) totals.push(Math.max(...g.map(x=>x.total||0)));
  });
  $('#kpi_best').textContent=totals.length?(totals.reduce((a,b)=>a+b,0)/totals.length).toFixed(1):'—';
}

/*** التحليل ***/
function stats(arr){
  if(!arr.length) return {avg:0,max:0,min:0,std:0};
  const n=arr.length, sum=arr.reduce((a,b)=>a+b,0), avg=sum/n;
  const max=Math.max(...arr), min=Math.min(...arr);
  const std=Math.sqrt(arr.reduce((a,b)=>a+(b-avg)**2,0)/n);
  return {avg,max,min,std};
}
function fillAnalyticsDropdown(){ /* ضمن fillAllDropdowns */ }
function runAnalytics(){
  const cls=$('#an_class').value;
  const from=$('#an_from').value||'0000-00-00';
  const to=$('#an_to').value||'9999-12-31';
  const filt=d.grades.filter(g=>(!cls||g.class===cls)&&g.date>=from&&g.date<=to);
  const totals=filt.map(x=>x.total||0).filter(x=>!isNaN(x));
  const s=stats(totals);
  $('#an_avg').textContent=totals.length?s.avg.toFixed(1):'—';
  $('#an_max').textContent=totals.length?s.max:'—';
  $('#an_min').textContent=totals.length?s.min:'—';
  $('#an_std').textContent=totals.length?s.std.toFixed(1):'—';

  const ks=['homework','tasks','particip','quiz','final'];
  const cap={'homework':'واجبات (10)','tasks':'مهام (20)','particip':'مشاركة (10)','quiz':'قصير (20)','final':'نهائي (40)'};
  const tb=$('#an_break tbody'); tb.innerHTML='';
  ks.forEach(k=>{
    const arr=filt.map(x=>Number(x[k])||0);
    const st=stats(arr);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td>'—'</td><td>'—'</td><td>'—'</td>`;
    tb.appendChild(tr);
  });

  const byStudent={};
  filt.forEach(x=>{ byStudent[x.studentId]=Math.max(byStudent[x.studentId]||0,x.total||0); });
  const top=Object.entries(byStudent).map(([sid,score])=>({sid,score})).sort((a,b)=>b.score-a.score).slice(0,10);
  const tb2=$('#an_top tbody'); tb2.innerHTML='';
  top.forEach((t,i)=>{
    const s=d.roster.find(x=>x.id===t.sid);
    const tr=document.createElement('tr'); tr.innerHTML=`<td></td><td>'?')</td><td></td>`;
    tb2.appendChild(tr);
  });
}
$('#an_run').onclick=runAnalytics;

/*** مرفقات — أيقونة/نسخ/فرز ***/
function iconFor(mime,name=''){
  const ext=(name.split('.').pop()||'').toLowerCase();
  if(mime?.includes('image')||['png','jpg','jpeg','gif','webp'].includes(ext)) return '🖼️';
  if(['pdf'].includes(ext)) return '📄';
  if(['doc','docx'].includes(ext)) return '📝';
  if(['xls','xlsx','csv'].includes(ext)) return '📊';
  if(['ppt','pptx'].includes(ext)) return '📽️';
  if(mime?.includes('audio')) return '🎵';
  if(mime?.includes('video')) return '🎬';
  return '📎';
}
function human(n){ if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB'; return (n/1024/1024/1024).toFixed(1)+' GB'; }
let filesSort={by:'uploaded_at',dir:'desc'};
$('#st_upload').onclick=async ()=>{
  const file=$('#st_file').files?.[0]; if(!file) return alert('اختر ملف');
  const studentId=$('#st_for_upload').value; if(!studentId) return alert('اختر الطالب');
  const path=`/_`;
  const up=await supa.storage.from(BUCKET).upload(path,file,{contentType:file.type,upsert:false});
  if(up.error) return alert(up.error.message);
  const ins=await supa.from('attachments').insert({student_id:studentId,name:file.name,path,mime:file.type,size:file.size});
  if(ins.error) return alert(ins.error.message);
  alert('تم الرفع'); $('#st_file').value=''; await listStudentFiles(studentId);
};
$('#st_list').onclick=()=>listStudentFiles($('#st_for_upload').value);
async function listStudentFiles(studentId){
  const {data,error}=await supa.from('attachments').select('*').eq('student_id',studentId);
  if(error){ alert(error.message); return; }
  data.sort((a,b)=>{let v=0; if(filesSort.by==='name') v=(a.name||'').localeCompare(b.name||'','ar'); if(filesSort.by==='size') v=(a.size||0)-(b.size||0); if(filesSort.by==='uploaded_at') v=new Date(a.uploaded_at)-new Date(b.uploaded_at); return filesSort.dir==='asc'?v:-v;});
  const tb=$('#files_table tbody'); tb.innerHTML=''; let i=1;
  for(const row of data){
    const pub=supa.storage.from(BUCKET).getPublicUrl(row.path).data.publicUrl;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td> </td><td></td><td></td>
      <td><a class="btn" target="_blank" href="">تحميل</a> <button data-copy="">نسخ</button></td>
      <td><button class="warn" data-del="" data-path="">🗑</button></td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('button[data-copy]').forEach(b=>b.onclick=()=>{navigator.clipboard.writeText(b.dataset.copy); b.textContent='نُسِخ'; setTimeout(()=>b.textContent='نسخ',1200);});
  tb.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{
    if(!confirm('تأكيد الحذف؟')) return;
    const path=btn.getAttribute('data-path'), id=btn.getAttribute('data-del');
    const del1=await supa.storage.from(BUCKET).remove([path]); if(del1.error) return alert(del1.error.message);
    const del2=await supa.from('attachments').delete().eq('id',id); if(del2.error) return alert(del2.error.message);
    await listStudentFiles($('#st_for_upload').value);
  });
}
$('#files_table thead').addEventListener('click',(e)=>{
  const th=e.target.closest('th'); if(!th) return;
  const idx=Array.from(th.parentNode.children).indexOf(th); const map={1:'name',2:'size',3:'uploaded_at'};
  if(!(idx in {1:1,2:1,3:1})) return;
  const by=map[idx]; filesSort.dir=(filesSort.by===by && filesSort.dir==='asc')?'desc':'asc'; filesSort.by=by;
  const sid=$('#st_for_upload').value; if(sid) listStudentFiles(sid);
});

/*** أولياء الأمور + التواصل ***/
function renderGuardians(){
  const tb=$('#gdn_table tbody'); tb.innerHTML='';
  d.guardians.forEach((g,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td></td><td></td><td></td>
      <td><button data-link="">ربط طالب</button></td><td><button class="warn" data-x="">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.guardians=d.guardians.filter(x=>x.id!==b.dataset.x);
    d.studentGuardians=d.studentGuardians.filter(x=>x.guardian_id!==b.dataset.x);
    save(d); renderGuardians(); fillGuardianDropdowns(); });
  tb.querySelectorAll('[data-link]').forEach(b=>b.onclick=()=>{
    const gid=b.dataset.link;
    const sid=prompt('أدخل ID الطالب (مؤقتًا). اكتب ? للمساعدة'); 
    if(sid==='?'){ alert('اذهب لتبويب الطلاب واضغط "تعديل" لنسخ ID الطالب من النافذة. سنحسّن الربط لاحقًا.'); return; }
    if(!sid) return;
    d.studentGuardians.push({id:crypto.randomUUID(), student_id:sid, guardian_id:gid, relationship:'ولي'}); save(d); alert('تم الربط');
  });
}
$('#gdn_add').onclick=()=>{
  const name=$('#gdn_name').value.trim(); if(!name) return alert('أدخل اسم الولي');
  d.guardians.push({id:crypto.randomUUID(), name, phone:$('#gdn_phone').value.trim(), email:$('#gdn_email').value.trim()});
  save(d); $('#gdn_name').value=''; $('#gdn_phone').value=''; $('#gdn_email').value=''; renderGuardians(); fillGuardianDropdowns();
};
$('#gdn_pull').onclick=async()=>{
  const g=await supa.from('guardians').select('*').order('created_at'); if(g.error) return alert(g.error.message);
  const sg=await supa.from('student_guardians').select('*'); if(sg.error) return alert(sg.error.message);
  d.guardians=g.data; d.studentGuardians=sg.data; save(d); renderGuardians(); fillGuardianDropdowns(); syncNote('pulled guardians');
};
$('#gdn_push').onclick=async()=>{
  await supa.from('student_guardians').delete().neq('id','00000000-0000-0000-0000-000000000000');
  await supa.from('guardians').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.guardians.length){ const r=await supa.from('guardians').insert(d.guardians); if(r.error) return alert(r.error.message); }
  if(d.studentGuardians.length){ const r2=await supa.from('student_guardians').insert(d.studentGuardians); if(r2.error) return alert(r2.error.message); }
  syncNote('pushed guardians');
};
function fillGuardianDropdowns(){
  $('#cl_student').innerHTML=d.roster.map(s=>`<option value=""></option>`).join('');
  $('#cl_guardian').innerHTML=d.guardians.map(g=>`<option value=""></option>`).join('');
}

/*** سجل التواصل ***/
$('#cl_add').onclick=()=>{
  const row={id:crypto.randomUUID(), date:new Date().toISOString(), student_id:$('#cl_student').value, guardian_id:$('#cl_guardian').value, channel:$('#cl_channel').value, notes:$('#cl_notes').value.trim()};
  d.contactLogs.push(row); save(d); $('#cl_notes').value=''; renderContactLogs();
};
function renderContactLogs(){
  const tb=$('#cl_table tbody'); tb.innerHTML=''; let i=1;
  d.contactLogs.sort((a,b)=>new Date(b.date)-new Date(a.date));
  d.contactLogs.forEach(c=>{
    const s=d.roster.find(x=>x.id===c.student_id), g=d.guardians.find(x=>x.id===c.guardian_id);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td></td><td></td><td>'?')</td><td>'?')</td><td></td><td></td><td><button data-x="">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.contactLogs=d.contactLogs.filter(x=>x.id!==b.dataset.x); save(d); renderContactLogs(); });
}
$('#cl_pull').onclick=async()=>{
  const r=await supa.from('contact_logs').select('*').order('date',{ascending:false}); if(r.error) return alert(r.error.message);
  d.contactLogs=r.data; save(d); renderContactLogs(); syncNote('pulled contacts');
};
$('#cl_push').onclick=async()=>{
  await supa.from('contact_logs').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.contactLogs.length){ const r=await supa.from('contact_logs').insert(d.contactLogs); if(r.error) return alert(r.error.message); }
  syncNote('pushed contacts');
};

/*** إعدادات / نسخ محلي ***/
const brand=JSON.parse(localStorage.getItem(BRAND)||'{}');
$('#s_school').value=brand.school||''; $('#s_signer').value=brand.signer||'';
$('#s_logo').onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const b=JSON.parse(localStorage.getItem(BRAND)||'{}'); b.logo=r.result; localStorage.setItem(BRAND,JSON.stringify(b)); alert('تم حفظ الشعار'); }; r.readAsDataURL(f); };
$('#s_save').onclick=()=>{ const b=JSON.parse(localStorage.getItem(BRAND)||'{}'); b.school=$('#s_school').value; b.signer=$('#s_signer').value; localStorage.setItem(BRAND,JSON.stringify(b)); alert('تم الحفظ'); };
$('#s_export').onclick=()=>{ const blob=new Blob([JSON.stringify(ensure(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='daybook-backup.json'; a.click(); URL.revokeObjectURL(a.href); };
$('#s_import').onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const obj=JSON.parse(await f.text()); localStorage.setItem(DBKEY,JSON.stringify(obj)); alert('تم الاستيراد'); location.reload(); }catch{ alert('ملف غير صالح'); }};

/*** ===== النسخ الاحتياطي السحابي (backups) ===== ***/
function nowStamp(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `--_--`; }
function safeLabel(s){ return (s||'').replace(/[^\w\u0600-\u06FF\- ]+/g,'').trim().replace(/\s+/g,'-').slice(0,40); }
async function backupSaveToCloud(label=''){
  const snapshot=ensure();
  const blob=new Blob([JSON.stringify(snapshot)],{type:'application/json'});
  const stamp=nowStamp(), tag=safeLabel(label);
  const name=`daybook_`:''}.json`;
  const up=await supa.storage.from(BK_BUCKET).upload(name,blob,{contentType:'application/json',upsert:false});
  if(up.error){ alert('فشل حفظ اللقطة: '+up.error.message); return null; }
  return {name,size:blob.size};
}
async function backupList(){
  const {data,error}=await supa.storage.from(BK_BUCKET).list('',{limit:200,sortBy:{column:'created_at',order:'desc'}});
  if(error){ return []; } // لا نكسر الصفحة
  return (data||[]).filter(x=>x.name?.toLowerCase().endsWith('.json'));
}
function humanBytes(n){ if(n==null) return '—'; if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB'; return (n/1024/1024/1024).toFixed(1)+' GB'; }
async function renderBackups(){
  const tb=$('#bk_table tbody'); tb.innerHTML='';
  let rows=[];
  try{ rows=await backupList(); }catch(e){ rows=[]; }
  if(!rows || !rows.length){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td colspan="8"><small class="muted">لا توجد لقطات أو لا يمكن الوصول للبكت <code></code>. أنشئه كـ Public من Storage.</small></td>`;
    tb.appendChild(tr);
    return;
  }
  let i=1;
  rows.forEach(r=>{
    const pub=supa.storage.from(BK_BUCKET).getPublicUrl(r.name).data.publicUrl;
    const parts=r.name.split('_'); const stamp=parts[1]?.replace('.json','')||''; 
    const label=(r.name.match(/_(.+)\.json$/)?.[1]||'').replace(/-/g,' ');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td><button data-restore="">استعادة</button></td>
      <td><a class="btn" href="" download>تنزيل</a></td>
      <td><button class="warn" data-del="">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-restore]').forEach(btn=>btn.onclick=async()=>{
    if(!confirm('سيتم استبدال بياناتك بهذه اللقطة. متابعة؟')) return;
    const name=btn.getAttribute('data-restore'); const url=supa.storage.from(BK_BUCKET).getPublicUrl(name).data.publicUrl;
    try{ const res=await fetch(url); const json=await res.json(); localStorage.setItem(DBKEY,JSON.stringify(json)); alert('تمت الاستعادة. ستُعاد تحميل الصفحة.'); location.reload(); }
    catch(e){ alert('فشل الاستعادة: '+(e.message||e)); }
  });
  tb.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{
    if(!confirm('حذف اللقطة نهائيًا؟')) return;
    const name=btn.getAttribute('data-del'); const del=await supa.storage.from(BK_BUCKET).remove([name]);
    if(del.error){ alert('فشل الحذف: '+del.error.message); return; }
    renderBackups();
  });
}
// أزرار واجهة النسخ الاحتياطي
$('#bk_local_export').onclick = ()=>$('#s_export').click();
$('#bk_cloud_save').onclick = async ()=>{ syncNote('saving snapshot…'); const ok=await backupSaveToCloud($('#bk_label').value.trim()); if(ok){ alert('تم حفظ لقطة في السحابة'); renderBackups(); syncNote('snapshot saved'); } };
$('#bk_refresh').onclick = ()=>renderBackups();

/*** لقطة تلقائية قبل أي Push — فقط الرفع، بدون اللعب بزِر Sync ***/
async function autoSnapshot(label='auto'){ try{ await backupSaveToCloud(label); }catch(e){ console.warn('autoSnapshot failed:', e); } }
{
  const old_st_push=$('#st_push').onclick; $('#st_push').onclick=async()=>{ await autoSnapshot('before_students_push'); return old_st_push(); };
  const old_a_push=$('#a_push').onclick;   $('#a_push').onclick  =async()=>{ await autoSnapshot('before_attendance_push'); return old_a_push(); };
  const old_b_push=$('#b_push').onclick;   $('#b_push').onclick  =async()=>{ await autoSnapshot('before_behavior_push'); return old_b_push(); };
  const old_g_push=$('#g_push').onclick;   $('#g_push').onclick  =async()=>{ await autoSnapshot('before_grades_push'); return old_g_push(); };
  const old_gdn_push=$('#gdn_push').onclick; $('#gdn_push').onclick=async()=>{ await autoSnapshot('before_guardians_push'); return old_gdn_push(); };
  const old_cl_push=$('#cl_push').onclick;   $('#cl_push').onclick=async()=>{ await autoSnapshot('before_contacts_push'); return old_cl_push(); };
}

/*** Sync ↕︎ — مُعالج واحد فقط (سَحب + لقطة قبل السحب) ***/
$('#syncBtn').onclick = async () => {
  try{
    syncNote('snapshot…');
    await autoSnapshot('before_full_sync');

    syncNote('pulling…');
    if (typeof $('#st_pull').onclick === 'function') await $('#st_pull').onclick();
    if (typeof $('#a_pull').onclick  === 'function') await $('#a_pull').onclick();
    if (typeof $('#b_pull').onclick  === 'function') await $('#b_pull').onclick();
    if (typeof $('#g_pull').onclick  === 'function') await $('#g_pull').onclick();
    if (typeof $('#gdn_pull').onclick=== 'function') await $('#gdn_pull').onclick();
    if (typeof $('#cl_pull').onclick === 'function') await $('#cl_pull').onclick();

    syncNote('done');
    alert('تمت المزامنة + حفظ لقطة احتياطية.');
  }catch(e){
    console.error(e);
    alert('تعذّرت المزامنة: '+(e.message||e));
    syncNote('error');
  }
};

/*** التقارير/KPI/تحليلات ***/
function fillAnalyticsDropdown(){ /* ضمن fillAllDropdowns */ }

/*** بناء مبدئي ***/
function renderAll(){ renderStudents(); fillAllDropdowns(); buildAttendance(); renderBehavior(); renderGuardians(); renderContactLogs(); }
$('#g_date').value=today(); $('#b_date').value=today(); $('#a_date').value=today();

/*** init ***/
function init(){ initNoAuthUI(); renderAll(); refreshKPIs(); renderBackups(); }
init();

/*** Service Worker بسيط ***/
if('serviceWorker' in navigator){
  const swBlob=new Blob([`
    const CACHE='daybook-pages-supa-v11';
    const ASSETS=['./index.html'];
    self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))));
    self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE?caches.delete(k):null)))));
    self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match('./index.html'))))});
  `],{type:'text/javascript'});
  const swUrl=URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}
</script>
</body>
</html>