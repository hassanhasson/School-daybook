<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>School Daybook — Supabase (Single File)</title>
<link rel="icon" href="favicon.png" type="image/png" />
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#1a2433; --muted:#6b7280; --pri:#0ea5e9; --pri-ink:#fff;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --soft:#e2e8f0; --chip:#eef6ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans Arabic",system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{background:#0b2239;color:#ecfeff;padding:14px 10px}
  .wrap{max-width:1050px;margin:auto;padding:0 10px}
  .bar{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand{font-weight:700;font-size:18px}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
  .tabs button{border:1px solid var(--soft);background:#e9eef7;color:#0b2239;border-radius:999px;padding:8px 14px;cursor:pointer}
  .tabs button.active{background:var(--pri);color:var(--pri-ink);border-color:transparent}
  .card{background:var(--card);border:1px solid var(--soft);border-radius:12px;padding:14px;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 180px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--soft);border-radius:8px;background:#fff}
  textarea{min-height:110px;resize:vertical}
  .btn{padding:9px 14px;border-radius:10px;border:1px solid var(--soft);background:#fff;cursor:pointer}
  .btn.pri{background:var(--pri);color:#fff;border-color:transparent}
  .btn.bad{background:var(--bad);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--soft);text-align:center}
  th{background:#f3f6fb;font-weight:700}
  .chip{background:var(--chip);color:#064e8a;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px}
  .pill.ok{background:#ecfdf5;color:#065f46}
  .pill.bad{background:#fef2f2;color:#7f1d1d}
  .pill.warn{background:#fffbeb;color:#78350f}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:780px){ .grid2{grid-template-columns:1fr} }
  .right{display:flex;align-items:center;gap:8px}
  .space{height:6px}
</style>
<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="wrap bar">
    <div class="brand">School Daybook — Supabase</div>
    <div class="right">
      <button id="btnSyncDown" class="btn">سحب من السحابة</button>
      <button id="btnSyncUp" class="btn">رفع للسحابة</button>
      <span id="syncNote" class="chip">جاهز</span>
    </div>
  </div>
  <div class="wrap tabs" id="tabs">
    <button data-tab="students" class="active">الطلاب</button>
    <button data-tab="attendance">الحضور</button>
    <button data-tab="behavior">السلوك</button>
    <button data-tab="grades">الدرجات</button>
    <button data-tab="reports">التقارير</button>
    <button data-tab="attachments">المرفقات</button>
    <button data-tab="settings">الإعدادات</button>
  </div>
</header>

<main class="wrap">
  <!-- الطلاب -->
  <section id="tab-students" class="card">
    <h3>إدارة الطلاب</h3>
    <div class="row">
      <input id="stName" placeholder="اسم الطالب" />
      <input id="stClass" placeholder="الصف/الشعبة مثال: ٦/ب" />
      <button id="btnAddStudent" class="btn pri">إضافة</button>
    </div>
    <div class="space"></div>
    <div class="row">
      <select id="stFilterClass">
        <option value="">كل الصفوف</option>
      </select>
      <input id="stSearch" placeholder="بحث بالاسم.." />
      <span class="muted">* الترتيب أبجدي عربي في العرض فقط</span>
    </div>

    <div class="card">
      <table id="stTable">
        <thead>
          <tr>
            <th style="width:70px">إجراءات</th>
            <th>الصف</th>
            <th>الاسم</th>
            <th style="width:60px">#</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card grid2">
      <div>
        <h4>مجاميع المسار الدراسي (بدون النهائي)</h4>
        <div class="muted">يحسب من: مشاركة (10) + واجبات (10) + مهام (20) + اختبار فترة (20)</div>
        <table id="stCourseTotals">
          <thead><tr><th>الطالب</th><th>المجموع / 60</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h4>نقاط الانضباط والسلوك</h4>
        <div class="muted">+0.5 حضور / +0.5 سلوك إيجابي / -1 غياب / -1 سلوك سلبي</div>
        <table id="stPointTotals">
          <thead><tr><th>الطالب</th><th>النقاط</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- الحضور -->
  <section id="tab-attendance" class="card" hidden>
    <h3>الحضور (انضباط)</h3>
    <div class="row">
      <select id="attFilterClass"><option value="">كل الصفوف</option></select>
      <select id="attStudent"><option value="">اختر طالب</option></select>
    </div>
    <div class="row">
      <input id="attDate" type="date" />
      <select id="attPeriod">
        <option value="1">الحصة 1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
      </select>
      <select id="attType">
        <option value="present">حاضر (+0.5)</option>
        <option value="absent">غائب (-1)</option>
        <option value="excused">مستأذن (0)</option>
      </select>
      <button id="btnAddAtt" class="btn pri">تسجيل</button>
    </div>
    <div class="card">
      <table id="attTable">
        <thead><tr><th>إجراء</th><th>الطالب</th><th>التاريخ</th><th>الحصة</th><th>النوع</th><th>الأثر</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- السلوك -->
  <section id="tab-behavior" class="card" hidden>
    <h3>السلوك</h3>
    <div class="row">
      <select id="bhFilterClass"><option value="">كل الصفوف</option></select>
      <select id="bhStudent"><option value="">اختر طالب</option></select>
    </div>
    <div class="row">
      <input id="bhDate" type="date" />
      <select id="bhPeriod">
        <option value="1">الحصة 1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
      </select>
      <select id="bhType">
        <option value="positive">إيجابي (+0.5)</option>
        <option value="negative">سلبي (-1)</option>
      </select>
    </div>
    <div class="row">
      <textarea id="bhNote" placeholder="وصف السلوك (اختياري)"></textarea>
      <button id="btnAddBh" class="btn pri">تسجيل</button>
    </div>
    <div class="card">
      <table id="bhTable">
        <thead><tr><th>إجراء</th><th>الطالب</th><th>التاريخ</th><th>الحصة</th><th>النوع</th><th>الوصف</th><th>الأثر</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- الدرجات -->
  <section id="tab-grades" class="card" hidden>
    <h3>الدرجات</h3>
    <div class="row">
      <select id="grFilterClass"><option value="">اختر الصف لإظهار القائمة</option></select>
      <button id="btnSaveGrades" class="btn pri">حفظ جميع الدرجات</button>
      <span class="muted">المجموع يحسب تلقائيًا</span>
    </div>
    <div class="card">
      <table id="grTable">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>مشاركة (10)</th>
            <th>واجبات (10)</th>
            <th>مهام (20)</th>
            <th>اختبار فترة (20)</th>
            <th>اختبار نهائي (40)</th>
            <th>المجموع</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- التقارير -->
  <section id="tab-reports" class="card" hidden>
    <h3>التقارير</h3>
    <div class="row">
      <select id="rpStudent"><option value="">اختر الطالب</option></select>
      <select id="rpType">
        <option value="absence">غياب</option>
        <option value="discipline">انضباط وسلوك</option>
      </select>
      <input id="rpDateHijri" placeholder="تاريخ هجري (يُكتب يدويًا)" />
    </div>
    <div class="row">
      <select id="rpTo">
        <option value="manager">مدير المدرسة</option>
        <option value="guide">الموجه الطلابي</option>
        <option value="teacher">المعلم</option>
        <option value="guardian">ولي أمر الطالب</option>
      </select>
      <textarea id="rpBody" placeholder="وصف التقرير"></textarea>
    </div>
    <div class="row">
      <button id="btnPrintReport" class="btn pri">طباعة التقرير</button>
      <span class="muted">الترويسة تُبنى تلقائيًا من الإعدادات.</span>
    </div>
    <div id="printArea" class="card" style="background:#fff"></div>
  </section>

  <!-- المرفقات -->
  <section id="tab-attachments" class="card" hidden>
    <h3>مرفقات الطلاب</h3>
    <div class="row">
      <select id="upFilterClass"><option value="">كل الصفوف</option></select>
      <select id="upStudent"><option value="">اختر الطالب</option></select>
      <input id="filePick" type="file" />
      <button id="btnUpload" class="btn pri">رفع</button>
    </div>
    <div class="space"></div>
    <div class="card">
      <table id="upTable">
        <thead><tr><th>#</th><th>الاسم</th><th>الحجم</th><th>التاريخ</th><th>رابط</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="muted">يرفع إلى Bucket اسمه <b>student-docs</b> (عام أو بسياسات قراءة anon).</div>
  </section>

  <!-- الإعدادات -->
  <section id="tab-settings" class="card" hidden>
    <h3>الإعدادات</h3>
    <div class="grid2">
      <div class="card">
        <h4>بيانات المدرسة</h4>
        <input id="scSchool" placeholder="اسم المدرسة" />
        <input id="scManager" placeholder="اسم المدير" />
        <input id="scGuide" placeholder="اسم الموجه الطلابي" />
        <input id="scTeacher" placeholder="اسم المعلم (الرياضيات)" />
        <div class="space"></div>
        <button id="btnSaveSchool" class="btn pri">حفظ</button>
      </div>
      <div class="card">
        <h4>Supabase</h4>
        <input id="scUrl" placeholder="SUPABASE_URL" />
        <input id="scKey" placeholder="ANON_KEY" />
        <div class="space"></div>
        <button id="btnSaveKeys" class="btn">حفظ المفاتيح محليًا</button>
        <button id="btnClearLocal" class="btn bad">مسح البيانات المحلية</button>
        <button id="btnClearCloud" class="btn bad">مسح الجداول السحابية (تحذير)</button>
      </div>
    </div>
  </section>
</main>

<script>
/* =========================
   1) الإعدادات و Supabase
   ========================= */
const DEFAULT_URL = "https://alamidjtlxuquvjvvcac.supabase.co"; // يمكنك تعديله من الإعدادات
const DEFAULT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU";

const store = {
  get url(){ return localStorage.getItem('SB_URL') || DEFAULT_URL; },
  get key(){ return localStorage.getItem('SB_KEY') || DEFAULT_KEY; },
  set url(v){ localStorage.setItem('SB_URL', v); },
  set key(v){ localStorage.setItem('SB_KEY', v); },
  school: {
    get(){ try{return JSON.parse(localStorage.getItem('SCHOOL_INFO')||'{}')}catch{ return {} } },
    set(v){ localStorage.setItem('SCHOOL_INFO', JSON.stringify(v)); }
  }
};

let supa = window.supabase.createClient(store.url, store.key);

/* ملاحظة الجداول المتوقعة:
   - students(id uuid pk, name text, class_name text, external_id text)
   - attendance(id uuid, student_id uuid fk, date date, period int, type text, delta numeric)
   - behavior(id uuid, student_id uuid fk, date date, period int, type text, note text, delta numeric)
   - grades(id uuid, student_id uuid fk, part double precision, hw double precision, task double precision, quiz double precision, final double precision)
   - مرفقات: bucket اسمه student-docs و مسارات: student_id/filename
*/

/* =========================
   2) أدوات واجهة عامة
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toast(msg, tone='ok'){
  const badge = $("#syncNote");
  badge.textContent = msg;
  badge.className = "chip";
  if(tone==='ok') badge.classList.add("pill","ok");
  if(tone==='bad') badge.classList.add("pill","bad");
  if(tone==='warn') badge.classList.add("pill","warn");
  setTimeout(()=>{ badge.className="chip"; badge.textContent="جاهز"; }, 1800);
}

function arabicSort(a,b){
  return a.localeCompare(b,'ar',{sensitivity:'base'});
}

function fmt(n, d=1){
  if(n===null || n===undefined || isNaN(n)) return "0";
  return Number(n).toFixed(d).replace(/\.0+$/,'');
}

/* =========================
   3) التبويبات
   ========================= */
const tabButtons = $$("#tabs button");
const sections = {
  students: $("#tab-students"),
  attendance: $("#tab-attendance"),
  behavior: $("#tab-behavior"),
  grades: $("#tab-grades"),
  reports: $("#tab-reports"),
  attachments: $("#tab-attachments"),
  settings: $("#tab-settings")
};

tabButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    for(const k in sections){ sections[k].hidden = true; }
    sections[btn.dataset.tab].hidden = false;
    if(btn.dataset.tab==='attachments'){ refreshFiles(); }
    if(btn.dataset.tab==='grades'){ refreshGradesTable(); }
  });
});

/* =========================
   4) الطلاب
   ========================= */
const stName = $("#stName");
const stClass = $("#stClass");
const stFilterClass = $("#stFilterClass");
const stSearch = $("#stSearch");
const stTableBody = $("#stTable tbody");
const stCourseTotalsBody = $("#stCourseTotals tbody");
const stPointTotalsBody = $("#stPointTotals tbody");

$("#btnAddStudent").addEventListener('click', async ()=>{
  const name = stName.value.trim();
  const cls  = stClass.value.trim();
  if(!name || !cls){ toast("أدخل الاسم والصف", 'warn'); return; }
  const { error } = await supa.from('students').insert({ name, class_name: cls });
  if(error){ toast("خطأ إضافة", 'bad'); console.error(error); return; }
  stName.value = ""; stClass.value="";
  await loadStudents();
  toast("تمت الإضافة");
});

async function deleteStudent(id){
  if(!confirm("حذف الطالب وكل سجلاته؟")) return;
  // احذف من الجداول التابعة (ON DELETE CASCADE إن وُجد) — احتياط:
  await supa.from('attendance').delete().eq('student_id', id);
  await supa.from('behavior').delete().eq('student_id', id);
  await supa.from('grades').delete().eq('student_id', id);
  await supa.from('students').delete().eq('id', id);
  await loadStudents();
  toast("حُذف الطالب");
}

async function loadStudents(){
  const { data, error } = await supa.from('students').select('*').order('name',{ascending:true});
  if(error){ console.error(error); return; }
  // فيلتر الصف والبحث
  const q = stSearch.value.trim();
  const cls = stFilterClass.value;
  const items = data.filter(s => (!cls || s.class_name===cls) && (!q || s.name.includes(q)));
  // تعبئة جدول
  stTableBody.innerHTML = items.sort((a,b)=>arabicSort(a.name,b.name)).map((s,i)=>`
    <tr>
      <td>
        <button class="btn bad" onclick="deleteStudent('${s.id}')">حذف</button>
      </td>
      <td>${s.class_name||''}</td>
      <td>${s.name}</td>
      <td>${i+1}</td>
    </tr>
  `).join('');

  // تعبئة قائمة الصفوف في الفلاتر المختلفة
  fillClassFilters(data);

  // حساب المجاميع (دراسي بدون النهائي + نقاط)
  await refreshTotals();
}

function fillClassFilters(all){
  const classes = [...new Set(all.map(s=>s.class_name).filter(Boolean))].sort((a,b)=>arabicSort(a,b));
  const fill = (sel, withAllText="كل الصفوف")=>{
    const el = $(sel); const cur = el.value;
    el.innerHTML = `<option value="">${withAllText}</option>` + classes.map(c=>`<option>${c}</option>`).join('');
    if(classes.includes(cur)) el.value = cur;
  };
  fill("#stFilterClass");
  fill("#attFilterClass");
  fill("#bhFilterClass");
  fill("#grFilterClass","اختر الصف لإظهار القائمة");
  fill("#upFilterClass");
}

stFilterClass.addEventListener('change', loadStudents);
stSearch.addEventListener('input', loadStudents);

/* =========================
   5) الحضور (انضباط)
   ========================= */
const attFilterClass = $("#attFilterClass");
const attStudent = $("#attStudent");
const attDate = $("#attDate"); const attPeriod = $("#attPeriod"); const attType = $("#attType");
const attTableBody = $("#attTable tbody");

attFilterClass.addEventListener('change', fillStudentsPickers);
async function fillStudentsPickers(){
  const cls = this.value || $("#bhFilterClass").value || $("#upFilterClass").value || $("#grFilterClass").value || "";
  const { data } = await supa.from('students').select('id,name,class_name').order('name',{ascending:true});
  const list = data.filter(s=>!cls || s.class_name===cls);
  const toOptions = arr => `<option value="">اختر طالب</option>` + arr.map(s=>`<option value="${s.id}">${s.name} (${s.class_name})</option>`).join('');
  attStudent.innerHTML = toOptions(list);
  $("#bhStudent").innerHTML = toOptions(list);
  $("#rpStudent").innerHTML = toOptions(data); // تقارير: جميع الطلاب
  $("#upStudent").innerHTML = toOptions(list);
}

$("#btnAddAtt").addEventListener('click', async ()=>{
  const sid = attStudent.value; if(!sid){ toast("اختر الطالب", 'warn'); return; }
  const date = attDate.value || new Date().toISOString().slice(0,10);
  const period = Number(attPeriod.value||1);
  const type = attType.value;
  const delta = type==='present'?0.5 : type==='absent'?-1 : 0;
  const { error } = await supa.from('attendance').insert({ student_id:sid, date, period, type, delta });
  if(error){ console.error(error); toast("خطأ حفظ","bad"); return; }
  await refreshAttendance();
  await refreshTotals();
  toast("سُجل الحضور");
});

async function refreshAttendance(){
  const { data } = await supa.from('attendance').select('id,student_id,date,period,type,delta,students(name)').order('date',{ascending:false}).limit(200);
  attTableBody.innerHTML = data.map(r=>`
    <tr>
      <td><button class="btn" onclick="delAtt('${r.id}')">حذف</button></td>
      <td>${r.students?.name||'-'}</td>
      <td>${r.date}</td><td>${r.period}</td>
      <td>${r.type==='present'?'<span class="pill ok">حاضر</span>': r.type==='absent'?'<span class="pill bad">غائب</span>':'<span class="pill warn">مستأذن</span>'}</td>
      <td>${fmt(r.delta)}</td>
    </tr>
  `).join('');
}
async function delAtt(id){ await supa.from('attendance').delete().eq('id',id); refreshAttendance(); refreshTotals(); }

/* =========================
   6) السلوك
   ========================= */
const bhFilterClass = $("#bhFilterClass");
const bhStudent = $("#bhStudent");
const bhDate = $("#bhDate"); const bhPeriod = $("#bhPeriod"); const bhType = $("#bhType"); const bhNote = $("#bhNote");
const bhTableBody = $("#bhTable tbody");

bhFilterClass.addEventListener('change', fillStudentsPickers);

$("#btnAddBh").addEventListener('click', async ()=>{
  const sid = bhStudent.value; if(!sid){ toast("اختر الطالب","warn"); return; }
  const date = bhDate.value || new Date().toISOString().slice(0,10);
  const period = Number(bhPeriod.value||1);
  const type = bhType.value;
  const delta = type==='positive'?0.5 : -1;
  const note = bhNote.value.trim();
  const { error } = await supa.from('behavior').insert({ student_id:sid, date, period, type, note, delta });
  if(error){ console.error(error); toast("خطأ حفظ","bad"); return; }
  bhNote.value="";
  await refreshBehavior(); await refreshTotals();
  toast("سُجل السلوك");
});

async function refreshBehavior(){
  const { data } = await supa.from('behavior').select('id,student_id,date,period,type,delta,note,students(name)').order('date',{ascending:false}).limit(200);
  bhTableBody.innerHTML = data.map(r=>`
    <tr>
      <td><button class="btn" onclick="delBh('${r.id}')">حذف</button></td>
      <td>${r.students?.name||'-'}</td>
      <td>${r.date}</td><td>${r.period}</td>
      <td>${r.type==='positive'?'<span class="pill ok">إيجابي</span>':'<span class="pill bad">سلبي</span>'}</td>
      <td style="text-align:right">${r.note||''}</td>
      <td>${fmt(r.delta)}</td>
    </tr>
  `).join('');
}
async function delBh(id){ await supa.from('behavior').delete().eq('id',id); refreshBehavior(); refreshTotals(); }

/* =========================
   7) الدرجات
   ========================= */
const grFilterClass = $("#grFilterClass");
const grTableBody = $("#grTable tbody");
grFilterClass.addEventListener('change', refreshGradesTable);

async function refreshGradesTable(){
  const cls = grFilterClass.value; if(!cls){ grTableBody.innerHTML=""; return; }
  const { data: studs } = await supa.from('students').select('*').eq('class_name',cls).order('name',{ascending:true});
  // اجلب درجات موجودة
  const ids = studs.map(s=>s.id);
  let exist = [];
  if(ids.length){
    const { data } = await supa.from('grades').select('*').in('student_id', ids);
    exist = data||[];
  }
  const byId = Object.fromEntries(exist.map(g=>[g.student_id,g]));
  grTableBody.innerHTML = studs.map(s=>{
    const g = byId[s.id] || {};
    const total = (g.part||0)+(g.hw||0)+(g.task||0)+(g.quiz||0)+(g.final||0);
    return `<tr data-id="${s.id}">
      <td style="text-align:right">${s.name}</td>
      <td><input type="number" min="0" max="10" step="0.5" value="${g.part??''}"></td>
      <td><input type="number" min="0" max="10" step="0.5" value="${g.hw??''}"></td>
      <td><input type="number" min="0" max="20" step="0.5" value="${g.task??''}"></td>
      <td><input type="number" min="0" max="20" step="0.5" value="${g.quiz??''}"></td>
      <td><input type="number" min="0" max="40" step="0.5" value="${g.final??''}"></td>
      <td class="gTotal">${fmt(total,1)}</td>
    </tr>`;
  }).join('');
  // تحديث المجموع عند التغيير
  grTableBody.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const tr = inp.closest('tr');
      const vals = Array.from(tr.querySelectorAll('input')).map(i=>Number(i.value||0));
      tr.querySelector('.gTotal').textContent = fmt(vals.reduce((a,b)=>a+b,0),1);
    });
  });
}

$("#btnSaveGrades").addEventListener('click', async ()=>{
  const rows = Array.from(grTableBody.querySelectorAll('tr'));
  const payload = rows.map(tr=>{
    const [part,hw,task,quiz,final] = Array.from(tr.querySelectorAll('input')).map(i=>Number(i.value||0));
    return { student_id: tr.dataset.id, part, hw, task, quiz, final };
  });
  // upsert
  for(const g of payload){
    const { error } = await supa.from('grades').upsert(g, { onConflict: 'student_id' });
    if(error){ console.error(error); toast("خطأ حفظ الدرجات",'bad'); return; }
  }
  await refreshTotals();
  toast("تم حفظ الدرجات");
});

/* =========================
   8) المجاميع (دراسي + نقاط)
   ========================= */
async function refreshTotals(){
  // جدول مجاميع الدراسة بدون النهائي
  const { data: j } = await supa.rpc('pg_temp.do', {}); // placeholder لا شيء
  // اجلب الطلاب + درجات + نقاط
  const { data: studs } = await supa.from('students').select('id,name').order('name',{ascending:true});
  // درجات
  const sids = studs.map(s=>s.id);
  let grades = [], att=[], bh=[];
  if(sids.length){
    const gq = await supa.from('grades').select('student_id,part,hw,task,quiz,final').in('student_id', sids);
    grades = gq.data||[];
    const aq = await supa.from('attendance').select('student_id,delta').in('student_id', sids);
    att = aq.data||[];
    const bq = await supa.from('behavior').select('student_id,delta').in('student_id', sids);
    bh = bq.data||[];
  }
  const gBy = Object.groupBy ? Object.groupBy(grades, x=>x.student_id) : groupByPoly(grades, x=>x.student_id);
  const aBy = Object.groupBy ? Object.groupBy(att, x=>x.student_id) : groupByPoly(att, x=>x.student_id);
  const bBy = Object.groupBy ? Object.groupBy(bh, x=>x.student_id) : groupByPoly(bh, x=>x.student_id);

  stCourseTotalsBody.innerHTML = studs.map(s=>{
    const g = (gBy[s.id]||[])[0] || {};
    const course = (g.part||0)+(g.hw||0)+(g.task||0)+(g.quiz||0); // بدون final
    return `<tr><td style="text-align:right">${s.name}</td><td>${fmt(course,1)} / 60</td></tr>`;
  }).join('');

  stPointTotalsBody.innerHTML = studs.map(s=>{
    const p = (aBy[s.id]||[]).reduce((a,x)=>a+(x.delta||0),0) + (bBy[s.id]||[]).reduce((a,x)=>a+(x.delta||0),0);
    return `<tr><td style="text-align:right">${s.name}</td><td>${fmt(p,1)}</td></tr>`;
  }).join('');
}

function groupByPoly(arr, fn){
  const m = {};
  for(const it of arr){ const k = fn(it); (m[k]??=[]).push(it); }
  return m;
}

/* =========================
   9) التقارير والطباعة
   ========================= */
$("#btnPrintReport").addEventListener('click', async ()=>{
  const sid = $("#rpStudent").value; if(!sid){ toast("اختر الطالب",'warn'); return; }
  const to = $("#rpTo").value;
  const tp = $("#rpType").value;
  const hj = $("#rpDateHijri").value.trim();
  const body = $("#rpBody").value.trim();
  const { data: s } = await supa.from('students').select('name,class_name').eq('id',sid).single();
  const sc = store.school.get();
  const title = "وزارة التعليم";
  const sub1 = "إدارة تعليم عسير";
  const sub2 = sc.school || "—";
  const today = hj || "—/—/—";
  const toText = to==='manager' ? `سعادة مدير المدرسة ${sc.manager||''}` :
                 to==='guide'   ? `الموجه الطلابي ${sc.guide||''}` :
                 to==='teacher' ? `المعلم ${sc.teacher||''}` :
                 `ولي أمر الطالب`;
  const typeText = tp==='absence' ? "بخصوص غياب الطالب" : "بخصوص انضباط وسلوك الطالب";
  const html = `
  <div style="padding:22px;font-family:'Noto Sans Arabic',sans-serif">
    <div style="text-align:center">
      <div style="font-size:18px;font-weight:700">${title}</div>
      <div>${sub1}</div>
      <div style="margin-bottom:8px">${sub2}</div>
      <div style="float:left">التاريخ الهجري: ${today}</div>
    </div>
    <hr/>
    <div style="margin:14px 0">إلى: <b>${toText}</b></div>
    <div style="margin:8px 0">الموضوع: <b>${typeText}</b></div>
    <div style="margin:8px 0">الطالب: <b>${s?.name||''}</b> — الصف: <b>${s?.class_name||''}</b></div>
    <p style="line-height:1.9">${body||'—'}</p>
    <div style="margin-top:24px">وتقبلوا خالص التحية،،</div>
    <div style="margin-top:14px">المعلم: ${sc.teacher||'—'}</div>
  </div>`;
  $("#printArea").innerHTML = html;
  setTimeout(()=>window.print(), 100);
});

/* =========================
   10) المرفقات (Storage)
   ========================= */
const upFilterClass = $("#upFilterClass");
const upStudent = $("#upStudent");
const upTableBody = $("#upTable tbody");
upFilterClass.addEventListener('change', fillStudentsPickers);

$("#btnUpload").addEventListener('click', async ()=>{
  const sid = upStudent.value; if(!sid) return toast("اختر الطالب",'warn');
  const f = $("#filePick").files[0]; if(!f) return toast("اختر ملفًا",'warn');
  const path = `${sid}/${Date.now()}_${f.name}`;
  const { error } = await supa.storage.from('student-docs').upload(path, f, { upsert:false });
  if(error){ console.error(error); toast(error.message.includes('not found')?'أنشئ bucket student-docs':'فشل الرفع','bad'); return; }
  toast("تم الرفع");
  await refreshFiles();
});

async function refreshFiles(){
  const sid = upStudent.value;
  if(!sid){ upTableBody.innerHTML=""; return; }
  const { data, error } = await supa.storage.from('student-docs').list(sid, { search: '', limit: 100 });
  if(error){ console.warn(error.message); upTableBody.innerHTML = `<tr><td colspan="6" class="muted">لا توجد ملفات أو البكت غير موجود.</td></tr>`; return; }
  let i=1;
  upTableBody.innerHTML = (data||[]).map(it=>{
    const url = supa.storage.from('student-docs').getPublicUrl(`${sid}/${it.name}`).data.publicUrl;
    const size = it.metadata?.size ? humanSize(it.metadata.size) : '—';
    const dt = it.created_at ? new Date(it.created_at).toLocaleString('ar-SA') : '—';
    return `<tr>
      <td>${i++}</td><td>${it.name}</td><td>${size}</td><td>${dt}</td>
      <td><a href="${url}" target="_blank">نسخ/فتح</a></td>
      <td><button class="btn" onclick="delFile('${sid}','${it.name}')">حذف</button></td>
    </tr>`;
  }).join('');
}
function humanSize(b){ const u=['B','KB','MB','GB']; let i=0; let n=b; while(n>1024&&i<u.length-1){n/=1024;i++;} return `${n.toFixed(1)} ${u[i]}`; }
async function delFile(sid,name){
  if(!confirm("حذف الملف؟")) return;
  await supa.storage.from('student-docs').remove([`${sid}/${name}`]);
  refreshFiles();
}

/* =========================
   11) الإعدادات
   ========================= */
$("#btnSaveSchool").addEventListener('click', ()=>{
  store.school.set({
    school: $("#scSchool").value.trim(),
    manager: $("#scManager").value.trim(),
    guide: $("#scGuide").value.trim(),
    teacher: $("#scTeacher").value.trim()
  });
  toast("حُفظت معلومات المدرسة");
});

$("#btnSaveKeys").addEventListener('click', ()=>{
  const u = $("#scUrl").value.trim(); const k = $("#scKey").value.trim();
  if(u) store.url = u; if(k) store.key = k;
  supa = window.supabase.createClient(store.url, store.key);
  toast("تم تحديث مفاتيح Supabase");
});

$("#btnClearLocal").addEventListener('click', ()=>{
  if(!confirm("سيتم مسح التخزين المحلي فقط، المتابعة؟")) return;
  localStorage.clear();
  toast("تم المسح المحلي");
});

$("#btnClearCloud").addEventListener('click', async ()=>{
  if(!confirm("تحذير: سيتم مسح جداول السحابة (students/attendance/behavior/grades). متابعة؟")) return;
  await supa.from('attendance').delete().neq('id',null);
  await supa.from('behavior').delete().neq('id',null);
  await supa.from('grades').delete().neq('id',null);
  await supa.from('students').delete().neq('id',null);
  toast("تم المسح السحابي");
  await loadStudents(); refreshAttendance(); refreshBehavior(); refreshGradesTable(); refreshTotals();
});

/* =========================
   12) مزامنة (اختيارية)
   ========================= */
$("#btnSyncDown").addEventListener('click', async ()=>{
  await Promise.all([loadStudents(), refreshAttendance(), refreshBehavior(), refreshGradesTable(), refreshTotals()]);
  toast("تم السحب");
});
$("#btnSyncUp").addEventListener('click', async ()=>{
  toast("لا يوجد مزامنة محلية/سحابية الآن. البيانات تذهب مباشرة للسحابة.",'warn');
});

/* =========================
   13) إقلاع
   ========================= */
(async function boot(){
  // عبّئ مفاتيح الإعدادات في الحقول للعلم
  $("#scUrl").value = store.url;
  $("#scKey").value = store.key;
  const sc = store.school.get();
  $("#scSchool").value = sc.school||"";
  $("#scManager").value = sc.manager||"";
  $("#scGuide").value = sc.guide||"";
  $("#scTeacher").value = sc.teacher||"";

  await loadStudents();
  await fillStudentsPickers.call(attFilterClass); // يملأ القوائم حسب الصف الافتراضي
  await refreshAttendance();
  await refreshBehavior();
  toast("جاهز");
})();

</script>
</body>
</html>