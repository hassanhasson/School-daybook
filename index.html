<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <!DOCTYPE html>
<html lang="ar">
<head>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Daybook</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
  <link rel="icon" href="favicon.png" type="image/png">

  <!-- Ø¨Ù‚ÙŠØ© Ø±ÙˆØ§Ø¨Ø· CSS Ø£Ùˆ Ù…ÙƒØªØ¨Ø§Øª -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  ...
</body>
</html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>School Daybook â€” Final (No-Auth)</title>
<meta name="theme-color" content="#0ea5e9">
<style>
:root{--bg:#0f172a;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--card:#fff;--primary:#0ea5e9;--ok:#10b981;--warn:#ef4444}
*{box-sizing:border-box}html,body{margin:0;background:#f1f5f9;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans Arabic',sans-serif}
header{background:var(--bg);color:#fff;padding:12px 16px}header h1{margin:0 0 4px;font-size:18px}#sync{font-size:12px;opacity:.8}
nav{display:flex;gap:6px;flex-wrap:wrap;background:#e2e8f0;padding:8px 12px}
nav button{border:0;background:#cbd5e1;padding:8px 12px;border-radius:8px;cursor:pointer}
nav button.active{background:#fff}
main{padding:12px}
.panel{display:none}.panel.active{display:block}
.section{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}.grid .wide{grid-column:1/-1}
.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:10px;background:#fff;overflow:hidden}
.table th,.table td{padding:8px;border-bottom:1px solid var(--line);font-size:14px;text-align:right}
.table thead th{background:#f8fafc}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.controls button,.controls label.import{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.secondary{background:var(--ok);color:#fff;border-color:var(--ok)}
.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
.badge{display:inline-block;padding:3px 8px;border-radius:99px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
small.muted{color:var(--muted)}
a.btn{padding:4px 8px;border:1px solid var(--line);border-radius:6px;text-decoration:none}
.memo-doc{background:#fff;border:1px solid var(--line);border-radius:8px;padding:16px;min-height:220px;line-height:1.9;font-size:15px}
.memo-doc h2{margin:0 0 8px;font-size:18px}.memo-doc .meta{color:#475569;margin-bottom:10px}.memo-doc .sec{margin:10px 0}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
@media print{header,nav,.controls,.section:not(.printable){display:none !important}body{background:#fff}.section{border:none}@page{size:A4;margin:12mm}}
/* Ø®Ø·Ø£ ØºÙŠØ± Ù‚Ø§ØªÙ„ */
#errToast{position:fixed;bottom:12px;left:12px;max-width:90vw;background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:.95;display:none;z-index:9999}
</style>
</head>
<body>
<header>
  <h1>School Daybook â€” Final (No-Auth)</h1>
  <div id="sync">Ø¬Ø§Ù‡Ø²</div>
</header>

<nav id="tabs">
  <button data-tab="students" class="active">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
  <button data-tab="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
  <button data-tab="behavior">Ø§Ù„Ø³Ù„ÙˆÙƒ</button>
  <button data-tab="grades">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
  <button data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  <button data-tab="memo">Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
  <button data-tab="settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  <span style="flex:1"></span>
  <button id="syncAll" class="secondary">Sync â†•ï¸</button>
</nav>

<main>

  <!-- Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <section id="panel-students" class="panel active">
    <div class="section">
      <div class="grid">
        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨<input id="st_name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ø­Ù…Ø¯"></label>
        <label>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)<input id="st_code" placeholder="Ø¥Ù† ÙˆØ¬Ø¯"></label>
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<input id="st_class" placeholder="Ù…Ø«Ø§Ù„: 3/Ø¨"></label>
        <div class="wide controls">
          <button id="st_add" class="primary">Ø¥Ø¶Ø§ÙØ©</button>
          <button id="st_pull">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
          <button id="st_push">Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</button>
          <label class="import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV<input type="file" id="st_csv" accept=".csv,text/csv"></label>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="controls">
        <input id="st_search" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡..." style="flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:8px">
      </div>
      <table class="table" id="st_table">
        <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¹Ø±Ù</th><th>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h3 style="margin:0 0 8px">Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <div class="grid">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨<select id="st_for_upload"></select></label>
        <label>Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§<input type="file" id="st_file"></label>
        <div class="wide controls">
          <button id="st_upload" class="primary">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
          <button id="st_list">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</button>
        </div>
      </div>
      <table class="table" id="files_table">
        <thead><tr><th>#</th><th>Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø¬Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ø§Ø¨Ø·</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
      <small class="muted">ØªÙØ±ÙØ¹ Ø¥Ù„Ù‰ Bucket <code>student-docs</code>. Ù„Ùˆ Ø¸Ù‡Ø± â€œBucket not foundâ€ Ø£Ù†Ø´Ø¦Ù‡ Ù…Ù† Supabase â–¸ Storage.</small>
    </div>
  </section>

  <!-- Ø§Ù„Ø­Ø¶ÙˆØ± -->
  <section id="panel-attendance" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<select id="a_class"></select></label>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®<input type="date" id="a_date"></label>
      </div>
      <div class="controls">
        <button id="all_present">Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±</button>
        <button id="all_absent">Ø§Ù„ÙƒÙ„ ØºØ§Ø¦Ø¨</button>
        <button id="toggle_pa">Ù‚Ù„Ø¨</button>
        <button id="a_save" class="primary">Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        <button id="a_pull">Ø³Ø­Ø¨</button>
        <button id="a_push">Ø±ÙØ¹</button>
        <span id="a_sumBadge" class="badge" style="margin-inline-start:auto">Ø¬Ù„Ø³Ø§Øª: 0</span>
      </div>
      <table class="table" id="a_table">
        <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Ø§Ù„Ø³Ù„ÙˆÙƒ -->
  <section id="panel-behavior" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®<input type="date" id="b_date"></label>
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨<select id="b_student"></select></label>
        <label>Ø§Ù„Ù†ÙˆØ¹
          <select id="b_type"><option value="positive">Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</option><option value="negative">Ø³Ù„Ø¨ÙŠ</option></select>
        </label>
        <label>Ø§Ù„ÙØ¦Ø©<input id="b_cat" placeholder="Ø§Ù†Ø¶Ø¨Ø§Ø·/ØªØ¹Ø§ÙˆÙ†.."></label>
        <label>Ø§Ù„Ù†Ù‚Ø§Ø·<input type="number" id="b_points" value="1"></label>
        <label class="wide">Ù…Ù„Ø§Ø­Ø¸Ø©<textarea id="b_note" rows="2"></textarea></label>
        <div class="wide controls">
          <button id="b_add" class="primary">Ø¥Ø¶Ø§ÙØ©</button>
          <button id="b_pull">Ø³Ø­Ø¨</button>
          <button id="b_push">Ø±ÙØ¹</button>
        </div>
      </div>
    </div>
    <div class="section">
      <table class="table" id="b_table">
        <thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Ø§Ù„Ø¯Ø±Ø¬Ø§Øª -->
  <section id="panel-grades" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<select id="g_class"></select></label>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®<input type="date" id="g_date"></label>
      </div>
      <table class="table" id="g_table">
        <thead><tr>
          <th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>ÙˆØ§Ø¬Ø¨Ø§Øª (10)</th><th>Ù…Ù‡Ø§Ù… (20)</th><th>Ù…Ø´Ø§Ø±ÙƒØ© (10)</th><th>Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± (20)</th><th>Ù†Ù‡Ø§Ø¦ÙŠ (40)</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
        </tr></thead><tbody></tbody>
      </table>
      <div class="controls">
        <button id="g_save" class="primary">Ø­ÙØ¸</button>
        <button id="g_pull">Ø³Ø­Ø¨</button>
        <button id="g_push">Ø±ÙØ¹</button>
        <button id="g_analyze">ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</button>
      </div>
      <div id="g_analysis" class="section" style="display:none"></div>
    </div>
  </section>

  <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
  <section id="panel-reports" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<select id="rp_class"></select></label>
        <label>Ù…Ù†<input type="date" id="rp_from"></label>
        <label>Ø¥Ù„Ù‰<input type="date" id="rp_to"></label>
        <div class="wide controls">
          <button id="rp_run" class="primary">ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±</button>
          <button id="rp_print">Ø·Ø¨Ø§Ø¹Ø©</button>
          <span id="rp_stats" class="badge" style="margin-inline-start:auto">â€”</span>
        </div>
      </div>
      <div class="section printable" style="margin-top:0">
        <table class="table" id="rp_table">
          <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø­Ø¶ÙˆØ±</th><th>ØºÙŠØ§Ø¨</th><th>Ø§Ø³ØªØ¦Ø°Ø§Ù†</th><th>Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</th><th>Ø³Ù„Ø¨ÙŠ</th><th>Ø£Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
  <section id="panel-memo" class="panel">
    <div class="section">
      <h3 style="margin:0 0 8px">Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <div class="grid">
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨<select id="sm_student"></select></label>
        <label>Ù…Ù†<input type="date" id="sm_from"></label>
        <label>Ø¥Ù„Ù‰<input type="date" id="sm_to"></label>
        <div class="wide">
          <label class="badge"><input type="checkbox" id="sm_att" checked> Ø§Ù„Ø­Ø¶ÙˆØ±</label>
          <label class="badge"><input type="checkbox" id="sm_beh" checked> Ø§Ù„Ø³Ù„ÙˆÙƒ</label>
          <label class="badge"><input type="checkbox" id="sm_grd" checked> Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</label>
        </div>
        <div class="wide controls">
          <button id="sm_build" class="primary">ØªÙˆÙ„ÙŠØ¯</button>
          <button id="sm_print">Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>
    </div>
    <div class="section printable">
      <div id="sm_preview" class="memo-doc" contenteditable="true"></div>
      <small class="muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙÙ‚Ø·.</small>
    </div>
  </section>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <section id="panel-settings" class="panel">
    <div class="section">
      <h3 style="margin:0 0 8px">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</h3>
      <div class="controls">
        <button id="s_backup_cloud">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</button>
        <button id="s_restore_cloud">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
        <button id="s_reset" class="warn">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
      </div>
      <small class="muted">Buckets Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <code>student-docs</code> Ù„Ù„Ù…Ø±ÙÙ‚Ø§ØªØŒ <code>backups</code> Ù„Ù„Ù†Ø³Ø®.</small>
    </div>
  </section>

</main>

<div id="errToast"></div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ===== ØªÙ‡ÙŠØ¦Ø© Supabase ===== */
const SUPABASE_URL='https://alamidjtlxuquvjvvcac.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU';
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<script>
/* ======= Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ======= */
(function(){
  const toast = document.getElementById('errToast');
  function showErr(msg){ try{ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 6000); }catch{} }
  window.addEventListener('error', e=>{ console.error(e); showErr('JS: '+(e.message||e)); });
  window.addEventListener('unhandledrejection', e=>{ console.error(e); showErr('Promise: '+(e.reason?.message||e.reason)); });
})();
</script>

<script>
/* ================== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ================== */
(function(){
"use strict";
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const DBKEY='daybook_cloud_v1', DOCS_BUCKET='student-docs', BACKUPS_BUCKET='backups';
const syncNote=t=>{ const el=$('#sync'); if(el) el.textContent=t; };

let d={ roster:[], attSessions:[], behavior:[], grades:[], terms:[] };
try{ const raw=localStorage.getItem(DBKEY); if(raw) d=JSON.parse(raw); }catch{}
function save(){ try{ localStorage.setItem(DBKEY, JSON.stringify(d)); }catch{} }

/* ===== Tabs ===== */
$$('#tabs button[data-tab]').forEach(b=>b.addEventListener('click',()=>{
  $$('#tabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  $$('.panel').forEach(p=>p.classList.remove('active')); $('#panel-'+b.dataset.tab).classList.add('active');
}));

/* ===== Helpers ===== */
const UUID_RE=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
const today=()=>new Date().toISOString().slice(0,10);
function sanitize(){
  let ch=false;
  d.roster=(d.roster||[]).filter(s=>s && (s.name||s.student_name)).map(s=>{ if(s.student_name && !s.name){ s.name=s.student_name; ch=true; } if(!UUID_RE.test(s.id||'')){ s.id=crypto.randomUUID(); ch=true; } s.class=s.class||s.class_name||''; s.code=s.code||''; return s; });
  d.attSessions=(d.attSessions||[]).map(ss=>{ if(!UUID_RE.test(ss.id||'')){ ss.id=crypto.randomUUID(); ch=true; } ss.entries=(ss.entries||[]).map(e=>{ if(!e.studentId&&e.student_id){ e.studentId=e.student_id; ch=true; } return e; }); return ss; });
  d.behavior=(d.behavior||[]).map(b=>{ if(!UUID_RE.test(b.id||'')){ b.id=crypto.randomUUID(); ch=true; } if(!b.studentId&&b.student_id){ b.studentId=b.student_id; ch=true; } return b; });
  d.grades=(d.grades||[]).map(g=>{ if(!UUID_RE.test(g.id||'')){ g.id=crypto.randomUUID(); ch=true; } if(!g.studentId&&g.student_id){ g.studentId=g.student_id; ch=true; } return g; });
  if(ch) save();
}

/* ===== Ø±Ø¨Ø· Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø­Ø³Ø¨ Ø§Ù„ØµÙ ===== */
function classes(){ return [...new Set((d.roster||[]).map(s=>s.class).filter(Boolean))]; }
function fillClassSelect(sel){
  if(!sel) return;
  const opts=['<option value="">â€” Ø§Ù„ÙƒÙ„ â€”</option>'].concat(classes().map(c=>`<option>${esc(c)}</option>`)).join('');
  sel.innerHTML=opts;
}
function fillAllClassFilters(){
  fillClassSelect($('#a_class')); fillClassSelect($('#g_class')); fillClassSelect($('#rp_class'));
}

/* ===== Ø§Ù„Ø·Ù„Ø§Ø¨ ===== */
function renderStudents(filter=''){
  const tb=$('#st_table tbody'); if(!tb) return; tb.innerHTML='';
  const list=(d.roster||[]).filter(s=>s && s.name && (!filter || s.name.includes(filter)));
  let i=1; list.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td><td>${esc(s.code||'â€”')}</td><td>${esc(s.class||'â€”')}</td>
      <td><button data-e="${s.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button data-x="${s.id}" class="warn">ğŸ—‘</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.roster=d.roster.filter(x=>x.id!==b.dataset.x); save(); renderStudents($('#st_search')?.value.trim()||''); fillAllDropdowns(); });
  tb.querySelectorAll('[data-e]').forEach(b=>b.onclick=()=>{ const s=d.roster.find(x=>x.id===b.dataset.e); if(!s) return;
    const name=prompt('Ø§Ù„Ø§Ø³Ù…:',s.name)||s.name; const cls=prompt('Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©:',s.class||'')||''; s.name=name; s.class=cls; save(); renderStudents($('#st_search')?.value.trim()||''); fillAllDropdowns(); });
}
$('#st_add')?.addEventListener('click',()=>{ const name=$('#st_name')?.value.trim(); if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
  d.roster.push({id:crypto.randomUUID(), name, code:$('#st_code')?.value.trim()||'', class:$('#st_class')?.value.trim()||''});
  save(); $('#st_name').value=''; $('#st_code').value=''; $('#st_class').value=''; renderStudents(); fillAllDropdowns();
});
$('#st_search')?.addEventListener('input',e=>renderStudents(e.target.value.trim()));

$('#st_csv')?.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
  const rows=txt.split(/\r?\n/).map(r=>r.trim()).filter(Boolean); const h=rows[0].toLowerCase().split(',').map(s=>s.trim());
  const iName=h.indexOf('name'), iClass=h.indexOf('class'), iCode=h.indexOf('code'); if(iName===-1) return alert('CSV Ù„Ø§Ø²Ù… Ø¹Ù…ÙˆØ¯ name');
  for(let i=1;i<rows.length;i++){ const cols=rows[i].split(','); const name=(cols[iName]||'').trim(); if(!name) continue;
    d.roster.push({id:crypto.randomUUID(), name, class:iClass>-1?(cols[iClass]||'').trim():'', code:iCode>-1?(cols[iCode]||'').trim():''});
  } save(); renderStudents(); fillAllDropdowns(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); });

/* Ø³Ø­Ø¨/Ø±ÙØ¹ Ø·Ù„Ø§Ø¨ */
$('#st_pull')?.addEventListener('click',async()=>{ syncNote('Ø³Ø­Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨â€¦');
  const {data,error}=await supa.from('students').select('*').order('created_at'); if(error) return alert(error.message);
  d.roster=(data||[]).map(r=>({id:r.id, name:r.name, code:r.code||'', class:r.class||''})); save(); sanitize(); renderStudents(); fillAllDropdowns(); syncNote('ØªÙ…');
});
$('#st_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨â€¦');
  await supa.from('students').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.roster?.length){ const rows=d.roster.map(s=>({id:s.id,name:s.name,code:s.code||null,class:s.class||null})); const {error}=await supa.from('students').insert(rows); if(error) return alert(error.message); }
  syncNote('ØªÙ…');
});

/* Ù‚ÙˆØ§Ø¦Ù… Ù…Ø´ØªØ±ÙƒØ© */
function fillAllDropdowns(){
  const roster=(d.roster||[]).filter(s=>s && s.name);
  $('#b_student') && ($('#b_student').innerHTML=roster.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join(''));
  $('#st_for_upload') && ($('#st_for_upload').innerHTML=roster.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join(''));
  $('#sm_student') && ($('#sm_student').innerHTML=roster.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join(''));
  fillAllClassFilters();
}

/* ===== Ø§Ù„Ø­Ø¶ÙˆØ± ===== */
$('#a_date') && ($('#a_date').value=today());
function buildAttendance(){
  const cls=$('#a_class')?.value||''; const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
  const tb=$('#a_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; list.forEach(s=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td>
      <td><select data-s="${s.id}"><option value=""></option><option>Ø­Ø§Ø¶Ø±</option><option>ØºØ§Ø¦Ø¨</option><option>Ù…ØªØ£Ø®Ø±</option><option>Ø§Ø³ØªØ¦Ø°Ø§Ù†</option></select></td>
      <td><input data-n="${s.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©"></td>`; tb.appendChild(tr); });
  refreshAttBadge();
}
function refreshAttBadge(){
  const date=$('#a_date')?.value||''; const cls=$('#a_class')?.value||''; const count=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&s.date===date).length;
  $('#a_sumBadge') && ($('#a_sumBadge').textContent=`Ø¬Ù„Ø³Ø§Øª: ${count}`);
}
$('#a_class')?.addEventListener('change', ()=>{ buildAttendance(); });
$('#a_date')?.addEventListener('change', refreshAttBadge);
$('#all_present')?.addEventListener('click',()=>$$('#a_table select').forEach(s=>s.value='Ø­Ø§Ø¶Ø±'));
$('#all_absent')?.addEventListener('click',()=>$$('#a_table select').forEach(s=>s.value='ØºØ§Ø¦Ø¨'));
$('#toggle_pa')?.addEventListener('click',()=>$$('#a_table select').forEach(s=>s.value=(s.value==='Ø­Ø§Ø¶Ø±'?'ØºØ§Ø¦Ø¨':'Ø­Ø§Ø¶Ø±')));
$('#a_save')?.addEventListener('click',()=>{ const cls=$('#a_class')?.value||'', date=$('#a_date')?.value||today();
  const rows=$$('#a_table tbody tr'); const entries=[]; rows.forEach(r=>{ const sel=r.querySelector('select'), note=r.querySelector('input'); const sid=sel.dataset.s, st=sel.value, nt=note.value.trim(); if(st||nt) entries.push({studentId:sid,status:st,note:nt}); });
  if(!entries.length) return alert('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª'); d.attSessions.push({id:crypto.randomUUID(),date,class:cls,entries}); save(); refreshAttBadge(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
});
$('#a_pull')?.addEventListener('click',async()=>{ syncNote('Ø³Ø­Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ±â€¦');
  const s=await supa.from('attendance_sessions').select('*').order('date'); if(s.error) return alert(s.error.message);
  const e=await supa.from('attendance_entries').select('*'); if(e.error) return alert(e.error.message);
  const byId={}; (s.data||[]).forEach(x=>byId[x.id]={id:x.id,date:String(x.date),class:x.class,entries:[]});
  (e.data||[]).forEach(x=>{ if(byId[x.session_id]) byId[x.session_id].entries.push({studentId:x.student_id,status:x.status||'',note:x.note||''}); });
  d.attSessions=Object.values(byId); save(); buildAttendance(); refreshAttBadge(); syncNote('ØªÙ…');
});
$('#a_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('Ø±ÙØ¹ Ø§Ù„Ø­Ø¶ÙˆØ±â€¦');
  await supa.from('attendance_entries').delete().neq('id','00000000-0000-0000-0000-000000000000');
  await supa.from('attendance_sessions').delete().neq('id','00000000-0000-0000-0000-000000000000');
  for(const s of (d.attSessions||[])){ await supa.from('attendance_sessions').insert({id:s.id,date:s.date,class:s.class});
    if(s.entries?.length){ const rows=s.entries.map(e=>({session_id:s.id,student_id:e.studentId,status:e.status||null,note:e.note||null})); const {error}=await supa.from('attendance_entries').insert(rows); if(error) return alert(error.message); } }
  syncNote('ØªÙ…');
});

/* ===== Ø§Ù„Ø³Ù„ÙˆÙƒ ===== */
$('#b_date') && ($('#b_date').value=today());
$('#b_add')?.addEventListener('click',()=>{ const e={id:crypto.randomUUID(),date:$('#b_date')?.value||today(),studentId:$('#b_student')?.value,type:$('#b_type')?.value,category:$('#b_cat')?.value.trim(),points:Number($('#b_points')?.value)||0,note:$('#b_note')?.value.trim()};
  if(!e.studentId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨'); d.behavior.push(e); save(); renderBehavior(); $('#b_note').value=''; });
function renderBehavior(){ const tb=$('#b_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; (d.behavior||[]).forEach(e=>{ const s=(d.roster||[]).find(x=>x.id===e.studentId);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i++}</td><td>${esc(e.date)}</td><td>${esc(s?s.name:'?')}</td><td>${e.type==='positive'?'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ':'Ø³Ù„Ø¨ÙŠ'}</td><td>${esc(e.category||'â€”')}</td><td>${e.points||0}</td><td>${esc(e.note||'â€”')}</td><td><button data-x="${e.id}" class="warn">ğŸ—‘</button></td>`; tb.appendChild(tr); });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.behavior=d.behavior.filter(x=>x.id!==b.dataset.x); save(); renderBehavior(); });
}
$('#b_pull')?.addEventListener('click',async()=>{ syncNote('Ø³Ø­Ø¨ Ø§Ù„Ø³Ù„ÙˆÙƒâ€¦'); const r=await supa.from('behavior').select('*').order('date'); if(r.error) return alert(r.error.message);
  d.behavior=(r.data||[]).map(x=>({id:x.id,date:String(x.date),studentId:x.student_id,type:x.type,category:x.category,points:x.points||0,note:x.note||''})); save(); renderBehavior(); syncNote('ØªÙ…'); });
$('#b_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('Ø±ÙØ¹ Ø§Ù„Ø³Ù„ÙˆÙƒâ€¦');
  await supa.from('behavior').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.behavior?.length){ const rows=d.behavior.map(e=>({id:e.id,date:e.date,student_id:e.studentId,type:e.type,category:e.category,points:e.points||0,note:e.note||null})); const {error}=await supa.from('behavior').insert(rows); if(error) return alert(error.message); }
  syncNote('ØªÙ…');
});

/* ===== Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ===== */
$('#g_date') && ($('#g_date').value=today());
function buildGrades(){
  const cls=$('#g_class')?.value||''; const list=(d.roster||[]).filter(s=>!cls||s.class===cls);
  const tb=$('#g_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; list.forEach(s=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td>
      <td><input type="number" min="0" max="10" step="1" data-k="homework" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="20" step="1" data-k="tasks" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="10" step="1" data-k="particip" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="20" step="1" data-k="quiz" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="40" step="1" data-k="final" data-s="${s.id}"></td>
      <td data-total="${s.id}">0</td>`; tb.appendChild(tr); });
  tb.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',()=>{ const sid=inp.dataset.s; const vals={homework:0,tasks:0,particip:0,quiz:0,final:0};
    tb.querySelectorAll(`input[data-s="${sid}"]`).forEach(el=>{ vals[el.dataset.k]=Number(el.value)||0; });
    tb.querySelector(`[td][data-total="${sid}"]`) || null; const cell=tb.querySelector(`[data-total="${sid}"]`); if(cell) cell.textContent=vals.homework+vals.tasks+vals.particip+vals.quiz+vals.final; }));
}
$('#g_class')?.addEventListener('change', buildGrades);
$('#g_save')?.addEventListener('click',()=>{ const limits={homework:10,tasks:20,particip:10,quiz:20,final:40}; const cls=$('#g_class')?.value||'', date=$('#g_date')?.value||today();
  const rows=$$('#g_table tbody tr'); const recs=[]; let ok=true;
  rows.forEach(r=>{ const sid=r.querySelector('input')?.dataset.s; if(!sid) return;
    const get=k=>Number(r.querySelector(`input[data-k="${k}"][data-s="${sid}"]`)?.value)||0;
    const v={homework:get('homework'),tasks:get('tasks'),particip:get('particip'),quiz:get('quiz'),final:get('final')};
    for(const k in v){ const el=r.querySelector(`input[data-k="${k}"]`); if(v[k]<0||v[k]>limits[k]){ ok=false; if(el) el.style.background='#fee2e2'; } else if(el) el.style.background=''; }
    recs.push({id:crypto.randomUUID(),date,studentId:sid,class:cls,...v,total:v.homework+v.tasks+v.particip+v.quiz+v.final}); });
  if(!ok) return alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯: 10/20/10/20/40');
  d.grades=d.grades.filter(g=>!(g.date===date && g.class===cls)); d.grades.push(...recs); save(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
});
$('#g_pull')?.addEventListener('click',async()=>{ syncNote('Ø³Ø­Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø§Øªâ€¦'); const r=await supa.from('grades').select('*').order('date'); if(r.error) return alert(r.error.message);
  d.grades=(r.data||[]).map(g=>({id:g.id,date:String(g.date),studentId:g.student_id,class:g.class,homework:g.homework||0,tasks:g.tasks||0,particip:g.particip||0,quiz:g.quiz||0,final:g.final||0,total:g.total||0})); save(); syncNote('ØªÙ…'); });
$('#g_push')?.addEventListener('click',async()=>{ sanitize(); syncNote('Ø±ÙØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øªâ€¦');
  await supa.from('grades').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.grades?.length){ const rows=d.grades.map(g=>({id:g.id,date:g.date,student_id:g.studentId,class:g.class,homework:g.homework,tasks:g.tasks,particip:g.particip,quiz:g.quiz,final:g.final,total:g.total||null}));
    const {error}=await supa.from('grades').insert(rows); if(error) return alert(error.message); }
  syncNote('ØªÙ…');
});
$('#g_analyze')?.addEventListener('click',()=>{ const box=$('#g_analysis'); if(!box) return; const cls=$('#g_class')?.value||'';
  const lastBy={}; [...(d.grades||[])].reverse().forEach(g=>{ if(!lastBy[g.studentId]) lastBy[g.studentId]=g; });
  const rows=(d.roster||[]).filter(s=>!cls||s.class===cls).map(s=>({name:s.name,total:+(lastBy[s.id]?.total||0)}));
  const top=rows.slice().sort((a,b)=>b.total-a.total).slice(0,5), weak=rows.filter(r=>r.total<50).sort((a,b)=>a.total-b.total).slice(0,5);
  box.style.display='block'; box.innerHTML=`<h3>ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</h3><div class="grid">
    <div><strong>Ø£Ø¹Ù„Ù‰ 5:</strong><ol>${top.map(r=>`<li>${esc(r.name)} â€” ${r.total}</li>`).join('')}</ol></div>
    <div><strong>Ø¨Ø­Ø§Ø¬Ø© Ø¯Ø¹Ù… (&lt;50):</strong><ol>${weak.map(r=>`<li>${esc(r.name)} â€” ${r.total}</li>`).join('')}</ol></div></div>`;
});

/* ===== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ===== */
function refreshReportStats(){
  const tag=$('#rp_stats'); if(!tag) return; const from=$('#rp_from')?.value||'0000-00-00', to=$('#rp_to')?.value||'9999-12-31', cls=$('#rp_class')?.value||'';
  const sess=(d.attSessions||[]).filter(s=>(!cls||s.class===cls)&&s.date>=from&&s.date<=to);
  const entries=sess.reduce((n,s)=>n+(s.entries?.length||0),0);
  const all=(d.grades||[]).filter(g=>(!cls||g.class===cls)&&g.date>=from&&g.date<=to).map(g=>+g.total||0);
  const avg=all.length?(all.reduce((a,b)=>a+b,0)/all.length).toFixed(1):'â€”';
  tag.textContent=`Ø¬Ù„Ø³Ø§Øª: ${sess.length} | Ù‚ÙŠÙˆØ¯ Ø­Ø¶ÙˆØ±: ${entries} | Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: ${avg}`;
}
$('#rp_run')?.addEventListener('click',()=>{ const cls=$('#rp_class')?.value||'', from=$('#rp_from')?.value||'0000-00-00', to=$('#rp_to')?.value||'9999-12-31';
  const students=(d.roster||[]).filter(s=>!cls||s.class===cls); const body=$('#rp_table tbody'); if(!body) return; body.innerHTML='';
  let i=1; students.forEach(s=>{ let present=0,absent=0,leave=0; (d.attSessions||[]).filter(ss=>(!cls||ss.class===cls)&&ss.date>=from&&ss.date<=to).forEach(ss=>{ const e=ss.entries.find(x=>x.studentId===s.id); if(!e) return; if(e.status==='Ø­Ø§Ø¶Ø±') present++; if(e.status==='ØºØ§Ø¦Ø¨') absent++; if(e.status==='Ø§Ø³ØªØ¦Ø°Ø§Ù†') leave++; });
    let pos=0,neg=0; (d.behavior||[]).filter(b=>b.studentId===s.id && b.date>=from && b.date<=to).forEach(b=>{ if(b.type==='positive') pos+=b.points||0; else neg+=Math.abs(b.points||0); });
    const g=(d.grades||[]).filter(g=>g.studentId===s.id && g.date>=from && g.date<=to); const maxTotal=g.length?Math.max(...g.map(x=>x.total||0)):0;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i++}</td><td>${esc(s.name)}</td><td>${present}</td><td>${absent}</td><td>${leave}</td><td>${pos}</td><td>${neg}</td><td>${maxTotal}</td>`; body.appendChild(tr); });
  refreshReportStats();
});
$('#rp_print')?.addEventListener('click',()=>window.print());
['#rp_from','#rp_to','#rp_class'].forEach(sel=>$(sel)?.addEventListener('change',refreshReportStats));

/* ===== Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ===== */
$('#sm_from') && ($('#sm_from').value=today());
$('#sm_to') && ($('#sm_to').value=today());
function sm_attendanceStats(id,from,to){ let pr=0,ab=0,lt=0,lv=0,tot=0; (d.attSessions||[]).forEach(ss=>{ if(ss.date<from||ss.date>to) return; const e=(ss.entries||[]).find(x=>x.studentId===id); if(!e) return; tot++; if(e.status==='Ø­Ø§Ø¶Ø±') pr++; else if(e.status==='ØºØ§Ø¦Ø¨') ab++; else if(e.status==='Ù…ØªØ£Ø®Ø±') lt++; else if(e.status==='Ø§Ø³ØªØ¦Ø°Ø§Ù†') lv++; }); return {present:pr,absent:ab,late:lt,leave:lv,total:tot,pct: tot?Math.round(pr/tot*100):null}; }
function sm_behaviorStats(id,from,to){ let pos=0,neg=0; const items=(d.behavior||[]).filter(b=>b.studentId===id && b.date>=from && b.date<=to); items.forEach(b=>{ if(b.type==='positive') pos+=(+b.points||0); else neg+=Math.abs(+b.points||0); }); return {pos,neg,latest:items.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,3)}; }
function sm_gradeStats(id,from,to){ const rows=(d.grades||[]).filter(g=>g.studentId===id && g.date>=from && g.date<=to); if(!rows.length) return {best:null,last:null}; const best=rows.slice().sort((a,b)=>(+b.total||0)-(+a.total||0))[0]; const last=rows.slice().sort((a,b)=>b.date.localeCompare(a.date))[0]; return {best,last}; }
$('#sm_build')?.addEventListener('click',()=>{ const pv=$('#sm_preview'); const sid=$('#sm_student')?.value; if(!pv||!sid) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨'); const stu=(d.roster||[]).find(s=>s.id===sid);
  const from=$('#sm_from')?.value||'0000-00-00', to=$('#sm_to')?.value||'9999-12-31', ia=$('#sm_att')?.checked, ib=$('#sm_beh')?.checked, ig=$('#sm_grd')?.checked;
  let html=`<h2>Ù…Ø°ÙƒØ±Ø© Ø¨Ø´Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ / ${esc(stu?.name||'')}</h2><div class="meta">Ø§Ù„ØµÙ: ${esc(stu?.class||'â€”')} â€” Ø§Ù„Ù…Ø¯Ø©: ${esc(from)} Ø¥Ù„Ù‰ ${esc(to)}</div>`;
  if(ia){ const A=sm_attendanceStats(sid,from,to); html+=`<div class="sec"><strong>Ø£ÙˆÙ„Ù‹Ø§: Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</strong><br>Ø§Ù„Ø¬Ù„Ø³Ø§Øª: ${A.total||0}. Ø­Ø¶Ø±: ${A.present}, ØºÙŠØ§Ø¨: ${A.absent}, ØªØ£Ø®Ø±: ${A.late}, Ø§Ø³ØªØ¦Ø°Ø§Ù†: ${A.leave}. ${A.pct!=null?`Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${A.pct}%`:''}</div>`; }
  if(ib){ const B=sm_behaviorStats(sid,from,to); const latest=B.latest.map(b=>`â€¢ ${esc(b.date)} â€” ${b.type==='positive'?'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ':'Ø³Ù„Ø¨ÙŠ'} (${b.points||0}): ${esc(b.category||'')} â€” ${esc(b.note||'')}`).join('<br>'); html+=`<div class="sec"><strong>Ø«Ø§Ù†ÙŠÙ‹Ø§: Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</strong><br>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ: ${B.pos}ØŒ Ø§Ù„Ø³Ù„Ø¨ÙŠ: ${B.neg}.<br>${latest?`Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:<br>${latest}`:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.'}</div>`; }
  if(ig){ const G=sm_gradeStats(sid,from,to), L=G.last||{}; html+=`<div class="sec"><strong>Ø«Ø§Ù„Ø«Ù‹Ø§: Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</strong><br>Ø£ÙØ¶Ù„ Ù…Ø¬Ù…ÙˆØ¹: ${G.best?(+G.best.total||0):'â€”'}. Ø£Ø­Ø¯Ø« Ø±ØµØ¯: ${esc(G.last?G.last.date:'â€”')}${G.last?` â€” ÙˆØ§Ø¬Ø¨Ø§Øª ${+L.homework||0}/10ØŒ Ù…Ù‡Ø§Ù… ${+L.tasks||0}/20ØŒ Ù…Ø´Ø§Ø±ÙƒØ© ${+L.particip||0}/10ØŒ Ø§Ø®ØªØ¨Ø§Ø± ${+L.quiz||0}/20ØŒ Ù†Ù‡Ø§Ø¦ÙŠ ${+L.final||0}/40ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${+L.total||0}/100`:''}</div>`; }
  html+=`<div class="sec"><strong>Ø®Ù„Ø§ØµØ© ÙˆØªÙˆØµÙŠØ§Øª</strong><br>â€“ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚ØµÙŠØ±Ø©.<br>â€“ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.<br>â€“ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ù… ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ£Ø®Ø± Ù…Ø¨ÙƒØ±Ù‹Ø§.<br></div><div style="margin-top:18px">Ø­Ø±Ø± ÙÙŠ: ${new Date().toLocaleDateString('ar')} â€” ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ____________</div>`;
  pv.innerHTML=html;
});
$('#sm_print')?.addEventListener('click',()=>window.print());

/* ===== Ù…Ø±ÙÙ‚Ø§Øª ===== */
function iconFor(m){ if(!m) return 'ğŸ“'; if(m.startsWith('image/'))return'ğŸ–¼ï¸'; if(m.includes('pdf'))return'ğŸ“„'; if(m.startsWith('video/'))return'ğŸï¸'; if(m.includes('zip'))return'ğŸ—œï¸'; return'ğŸ“'; }
function human(n){ if(!n) return 'â€”'; if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB'; return (n/1024/1024/1024).toFixed(1)+' GB'; }
$('#st_upload')?.addEventListener('click',async()=>{ const f=$('#st_file')?.files?.[0]; if(!f) return alert('Ø§Ø®ØªØ± Ù…Ù„Ù'); const sid=$('#st_for_upload')?.value; if(!UUID_RE.test(sid||'')) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨');
  const path=`${sid}/${Date.now()}_${f.name}`; const up=await supa.storage.from(DOCS_BUCKET).upload(path,f,{contentType:f.type||undefined,upsert:false});
  if(up.error){ if(/Bucket not found/i.test(up.error.message)) alert('Ø£Ù†Ø´Ø¦ bucket Ø§Ø³Ù…Ù‡ student-docs'); else alert(up.error.message); return; }
  const ins=await supa.from('attachments').insert({student_id:sid,name:f.name,path,mime:f.type||null,size:f.size||null}); if(ins.error) return alert(ins.error.message);
  alert('ØªÙ… Ø§Ù„Ø±ÙØ¹'); $('#st_file').value=''; listStudentFiles(sid);
});
$('#st_list')?.addEventListener('click',()=>{ const sid=$('#st_for_upload')?.value; if(!sid) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨'); listStudentFiles(sid); });
async function listStudentFiles(sid){
  const q=await supa.from('attachments').select('*').eq('student_id',sid); if(q.error) return alert(q.error.message);
  const tb=$('#files_table tbody'); if(!tb) return; tb.innerHTML='';
  let i=1; for(const r of (q.data||[])){ const pub=supa.storage.from(DOCS_BUCKET).getPublicUrl(r.path).data.publicUrl; const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td><span>${iconFor(r.mime)}</span> ${esc(r.name)}</td><td>${human(r.size||0)}</td><td>${new Date(r.uploaded_at||0).toLocaleString('ar')}</td>
      <td><a class="btn" target="_blank" href="${pub}">ÙØªØ­</a> <button data-copy="${pub}">Ù†Ø³Ø®</button></td>
      <td><button class="warn" data-del="${r.id}" data-path="${esc(r.path)}">ğŸ—‘</button></td>`; tb.appendChild(tr); }
  tb.querySelectorAll('button[data-copy]').forEach(b=>b.onclick=()=>{ navigator.clipboard.writeText(b.dataset.copy); b.textContent='Ù†ÙØ³Ø®'; setTimeout(()=>b.textContent='Ù†Ø³Ø®',1200); });
  tb.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async()=>{ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return; const path=btn.getAttribute('data-path'), id=btn.getAttribute('data-del');
    const del1=await supa.storage.from(DOCS_BUCKET).remove([path]); if(del1.error) return alert(del1.error.message); const del2=await supa.from('attachments').delete().eq('id',id); if(del2.error) return alert(del2.error.message); listStudentFiles($('#st_for_upload')?.value); });
}

/* ===== Sync Ø´Ø§Ù…Ù„ ===== */
$('#syncAll')?.addEventListener('click',async()=>{ try{
  syncNote('Ù„Ù‚Ø·Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©â€¦'); // Ø¨Ø³ÙŠØ·Ø©: Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·
  save();
  syncNote('Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©â€¦');
  await $('#st_pull')?.onclick?.();
  await $('#a_pull')?.onclick?.();
  await $('#b_pull')?.onclick?.();
  await $('#g_pull')?.onclick?.();
  syncNote('ØªÙ…');
}catch(e){ alert('ØªØ¹Ø°Ù‘Ø±Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: '+(e.message||e)); syncNote('Ø®Ø·Ø£'); }});

/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===== */
$('#s_backup_cloud')?.addEventListener('click',async()=>{ try{
  const blob=new Blob([JSON.stringify(d||{})],{type:'application/json'}); const name=`daybook_${Date.now()}.json`;
  const up=await supa.storage.from(BACKUPS_BUCKET).upload(name,blob,{contentType:'application/json',upsert:false});
  if(up.error){ if(/Bucket not found/i.test(up.error.message)) alert('Ø£Ù†Ø´Ø¦ bucket Ø§Ø³Ù…Ù‡ backups'); else alert(up.error.message); return; }
  alert('ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
}catch(e){ alert(e.message); }});
$('#s_restore_cloud')?.addEventListener('click',async()=>{ try{
  const list=await supa.storage.from(BACKUPS_BUCKET).list('',{sortBy:{column:'created_at',order:'desc'},limit:1});
  if(list.error) return alert(list.error.message); if(!list.data?.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®');
  const dl=await supa.storage.from(BACKUPS_BUCKET).download(list.data[0].name); if(dl.error) return alert(dl.error.message);
  d=JSON.parse(await dl.data.text()); save(); alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); location.reload();
}catch(e){ alert(e.message); }});
$('#s_reset')?.addEventListener('click',()=>{ if(confirm('Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')){ localStorage.removeItem(DBKEY); location.reload(); }});

/* ===== Ø¨Ù†Ø§Ø¡ Ø£ÙˆÙ„ÙŠ ===== */
function init(){
  sanitize(); renderStudents(); fillAllDropdowns(); buildAttendance(); renderBehavior(); buildGrades();
  $('#g_date') && ($('#g_date').value=today()); $('#b_date') && ($('#b_date').value=today());
}
init();

})(); // app IIFE
</script>
</body>
</html>
