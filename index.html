<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>School Daybook — الطلاب</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' rx='10' fill='%230b3954'/%3E%3Ctext x='50%25' y='52%25' text-anchor='middle' dominant-baseline='central' font-size='28' font-family='Arial' fill='white'%3ESD%3C/text%3E%3C/svg%3E">

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--brand:#0b3954;--good:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans Arabic",system-ui,Segoe UI,Arial}
    header{background:var(--brand);color:#fff;padding:16px 20px;font-weight:800}
    .wrap{max-width:1100px;margin:14px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{font-size:15px;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px}
    button{cursor:pointer}
    .btn{background:#e2e8f0}
    .btn.primary{background:#0b3954;color:#fff;border-color:#0b3954}
    .btn.danger{background:#dc2626;color:#fff;border-color:#dc2626}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef}
    th{background:#f3f4f6;text-align:right}
    .pill{display:inline-block;background:#e9eef3;border-radius:999px;padding:4px 10px}
    .grow{flex:1}
  </style>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>School Daybook — تبويب الطلاب</header>
  <main class="wrap">

    <section class="card">
      <h3 style="margin:4px 0 10px">إضافة طالب</h3>
      <div class="row">
        <input id="name" placeholder="اسم الطالب" class="grow"/>
        <input id="klass" placeholder="الصف/الشعبة (مثال: ٦/أ)" style="min-width:180px"/>
        <button id="add" class="btn primary">إضافة</button>
        <input id="importFile" type="file" accept=".csv,.txt" class="hidden"/>
        <button id="importBtn" class="btn">استيراد CSV</button>
        <button id="exportBtn" class="btn">تصدير CSV</button>
      </div>
      <div class="muted" style="margin-top:6px">* الحقول: الاسم + الصف فقط. الحفظ يتم مباشرة على السحابة.</div>
    </section>

    <section class="card">
      <h3 style="margin:4px 0 10px">قائمة الطلاب</h3>
      <div class="row" style="margin-bottom:8px">
        <input id="q" class="grow" placeholder="بحث بالاسم (أتركه فارغ = الكل)"/>
        <select id="filterClass" style="min-width:180px">
          <option value="">الكل (كل الصفوف)</option>
        </select>
        <span class="pill" id="count">—</span>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:60px">#</th>
              <th>الاسم</th>
              <th style="width:200px">الصف</th>
              <th style="width:220px">مجموع الدرجات (بدون النهائي)</th>
              <th style="width:220px">مجموع نقاط السلوك/المواظبة</th>
              <th style="width:120px">إجراءات</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted">جاري التحميل…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
  (function(){
    // === مفاتيح Supabase (تقدر تغيّرها لاحقًا) ===
    const SUPABASE_URL  = "https://alamidjtlxuquvjvvcac.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // DOM
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const collAr = new Intl.Collator('ar', {sensitivity:'base'});
    const tbody = $('#tbody'), countEl = $('#count');

    // حالة
    let students = [];      // من جدول students
    let metrics  = {};      // من view student_metrics {student_id: {coursework_sum, conduct_points}}
    let classes  = new Set();

    // تحميل الطلاب + المقاييس
    async function loadAll() {
      // students
      const {data:stu, error:err1} = await sb.from('students').select('id,name,class_name');
      if (err1) { console.error(err1); alert('قراءة الطلاب فشلت: '+err1.message); return; }
      students = (stu||[]).slice().sort((a,b)=> collAr.compare(a.name||'', b.name||''));
      // classes
      classes = new Set(students.map(s=>s.class_name).filter(Boolean));

      // metrics view
      const {data:met, error:err2} = await sb.from('student_metrics').select('*');
      if (err2) { console.error(err2); alert('قراءة المقاييس فشلت: '+err2.message); return; }
      metrics = {};
      (met||[]).forEach(m => metrics[m.student_id] = {coursework_sum: Number(m.coursework_sum)||0, conduct_points: Number(m.conduct_points)||0});

      fillClassFilter();
      render();
    }

    // تعبئة فلتر الصف
    function fillClassFilter(){
      const sel = $('#filterClass');
      const cur = sel.value;
      sel.innerHTML = '<option value="">الكل (كل الصفوف)</option>' +
        Array.from(classes).sort((a,b)=>collAr.compare(a,b)).map(c=>`<option value="${c}">${c}</option>`).join('');
      if (Array.from(classes).includes(cur)) sel.value = cur;
    }

    // فلترة + رسم
    function render(){
      const q = ($('#q').value||'').trim();
      const klass = $('#filterClass').value||'';
      let rows = students.slice();

      if (klass) rows = rows.filter(s => (s.class_name||'') === klass);
      if (q) rows = rows.filter(s => (s.name||'').includes(q));

      rows = rows.sort((a,b)=> collAr.compare(a.name||'', b.name||''));

      countEl.textContent = `العدد: ${rows.length}`;

      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">لا نتائج</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map((s, i) => {
        const m = metrics[s.id] || {coursework_sum:0, conduct_points:0};
        const cp = m.conduct_points;
        const cpClass = cp >= 0 ? 'style="color:#16a34a;font-weight:700"' : 'style="color:#dc2626;font-weight:700"';
        return `
          <tr>
            <td>${i+1}</td>
            <td>${escapeHtml(s.name||'')}</td>
            <td>${escapeHtml(s.class_name||'')}</td>
            <td>${m.coursework_sum.toFixed(1)}</td>
            <td ${cpClass}>${cp.toFixed(1)}</td>
            <td><button class="btn danger" data-del="${s.id}">حذف</button></td>
          </tr>`;
      }).join('');
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // إضافة طالب
    $('#add').addEventListener('click', async ()=>{
      const name = ($('#name').value||'').trim();
      const klass = ($('#klass').value||'').trim();
      if (!name){ $('#name').focus(); return; }
      const { data, error } = await sb.from('students').insert({ name, class_name: klass||null }).select().single();
      if (error){ alert('فشل الإضافة: '+error.message); return; }
      $('#name').value = ''; $('#klass').value='';
      await loadAll();
    });

    // حذف طالب
    tbody.addEventListener('click', async (e)=>{
      const id = e.target?.dataset?.del; if (!id) return;
      if (!confirm('حذف الطالب نهائيًا؟')) return;
      const { error } = await sb.from('students').delete().eq('id', id);
      if (error){ alert('فشل الحذف: '+error.message); return; }
      await loadAll();
    });

    // بحث/فلترة
    $('#q').addEventListener('input', render);
    $('#filterClass').addEventListener('change', render);

    // استيراد CSV (عمودين: name,class_name) سطر لكل طالب
    $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const text = await f.text();
      const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if (!rows.length) return;
      // تخطي هيدر محتمل
      const guessHeader = rows[0].toLowerCase().includes('name') || rows[0].includes('الاسم');
      const data = (guessHeader ? rows.slice(1) : rows).map(line=>{
        const [name, klass] = line.split(',').map(x=> (x||'').trim());
        return { name, class_name: klass||null };
      }).filter(r=>r.name);
      if (!data.length) return;
      const { error } = await sb.from('students').insert(data);
      if (error){ alert('فشل الاستيراد: '+error.message); return; }
      $('#importFile').value = '';
      await loadAll();
    });

    // تصدير CSV
    $('#exportBtn').addEventListener('click', ()=>{
      const header = 'name,class_name,coursework_sum,conduct_points';
      const lines = students.map(s=>{
        const m = metrics[s.id] || {coursework_sum:0, conduct_points:0};
        return `"${(s.name||'').replace(/"/g,'""')}","${(s.class_name||'').replace(/"/g,'""')}",${m.coursework_sum},${m.conduct_points}`;
      });
      const csv = [header, ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'students.csv';
      a.click();
    });

    // تشغيل أولي
    loadAll();
  })();
  </script>
</body>
</html>