<script>
(function(){
  "use strict";

  /* ========= Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù…Ø´ØªØ±ÙƒØ© ========= */
  const $ = (sel,root=document)=> root.querySelector(sel);
  const $$ = (sel,root=document)=> [...root.querySelectorAll(sel)];
  const esc = s => String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const DBKEY = window.DBKEY || 'daybook_cloud_v1';

  // Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© (Ù†ÙØ³ Ø¨Ù†ÙŠØ© Ù…Ù„ÙÙƒ: roster, attSessions, behavior, grades, terms ...)
  if (!window.d) window.d = { roster:[], attSessions:[], behavior:[], grades:[], terms:[] };

  // ØªØ°ÙƒÙ‘Ø± Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø± ØµÙ
  const LAST = {
    set(cls){ try{ localStorage.setItem('last_class', cls||''); }catch{} },
    get(){ try{ return localStorage.getItem('last_class')||''; }catch{ return '' } }
  };

  // Ø£Ø¯ÙˆØ§Øª ØªØ®Ø²ÙŠÙ† JSON ÙÙŠ localStorage
  function saveAll() {
    try { localStorage.setItem(DBKEY, JSON.stringify(window.d)); }
    catch (e) { alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§: '+e.message); }
  }
  function loadAll() {
    try {
      const raw = localStorage.getItem(DBKEY);
      if (raw) window.d = JSON.parse(raw);
    } catch {}
  }

  // Ø§Ø³ØªØ¯Ø¹Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹
  loadAll();

  /* ========= 1) Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ / Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ========= */
  const BACKUPS_BUCKET = 'backups';

  async function backupToCloud() {
    try{
      const blob = new Blob([JSON.stringify(window.d||{})], {type:'application/json'});
      const path = `backup_${Date.now()}.json`;
      const up = await supa.storage.from(BACKUPS_BUCKET).upload(path, blob, {contentType:'application/json', upsert:false});
      if (up.error) throw up.error;
      alert('ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.');
    }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: '+e.message); }
  }

  async function restoreLatestFromCloud() {
    try{
      const L = await supa.storage.from(BACKUPS_BUCKET).list('', {sortBy:{column:'created_at',order:'desc'}, limit:1});
      if (L.error) throw L.error;
      if (!L.data || !L.data.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
      const file = L.data[0].name;
      const dl = await supa.storage.from(BACKUPS_BUCKET).download(file);
      if (dl.error) throw dl.error;
      const text = await dl.data.text();
      const obj = JSON.parse(text);
      window.d = obj; saveAll();
      alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©. Ø³ÙŠÙØ¹Ø§Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
      location.reload();
    }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: '+e.message); }
  }

  const btnBackup = $('#s_backup_cloud');
  if (btnBackup) btnBackup.addEventListener('click', backupToCloud);
  const btnRestore = $('#s_restore_cloud');
  if (btnRestore) btnRestore.addEventListener('click', restoreLatestFromCloud);

  // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
  function resetLocal(){
    if (confirm('Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ')) {
      localStorage.removeItem(DBKEY);
      alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­. Ø³ÙŠÙØ¹Ø§Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
      location.reload();
    }
  }
  // ÙƒØ´ÙÙ‡Ø§ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ù…Ù† ÙŠØ±ÙŠØ¯ Ø²Ø± Ù…Ù†ÙØµÙ„
  window.Daybook = Object.assign(window.Daybook||{}, { resetLocal, backupToCloud, restoreLatestFromCloud });

  /* ========= 2) Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ========= */
  const btnRptPrint = $('#rp_print');
  if (btnRptPrint) btnRptPrint.addEventListener('click', ()=> window.print());

  /* ========= 3) ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø£ÙŠÙ‚ÙˆÙ†Ø©/Ø­Ø¬Ù…/Ù†Ø³Ø® Ø±Ø§Ø¨Ø·) ========= */
  function iconFor(mime){
    if(!mime) return 'ğŸ“';
    if (mime.startsWith('image/')) return 'ğŸ–¼ï¸';
    if (mime.includes('pdf')) return 'ğŸ“„';
    if (mime.startsWith('video/')) return 'ğŸï¸';
    if (mime.includes('zip')) return 'ğŸ—œï¸';
    return 'ğŸ“';
  }
  function humanSize(b){
    if (!+b) return 'â€”';
    const u=['B','KB','MB','GB','TB']; let i=0, s=+b;
    while(s>=1024 && i<u.length-1){ s/=1024; i++; }
    return s.toFixed(1)+' '+u[i];
  }
  // call this Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¨Ù†ÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ ØµÙØ­ØªÙƒ
  function enhanceAttachmentsUI(container){
    const root = container || document;
    // Ø£Ø²Ø±Ø§Ø± Ù†Ø³Ø®
    root.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const url = btn.getAttribute('data-copy');
        navigator.clipboard.writeText(url).then(()=> alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'));
      });
    });
    // Ø£Ø·Ø¨Ø¹ Ø­Ø¬Ù…Ù‹Ø§ Ø¨ØµÙŠØºØ© Ø¨Ø´Ø±ÙŠØ© Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§
    root.querySelectorAll('[data-size-bytes]').forEach(el=>{
      const v = +el.getAttribute('data-size-bytes') || 0;
      el.textContent = humanSize(v);
    });
    // Ø¶Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ mime
    root.querySelectorAll('[data-mime]').forEach(el=>{
      const m = el.getAttribute('data-mime')||'';
      el.textContent = iconFor(m);
    });
  }
  window.Daybook.enhanceAttachmentsUI = enhanceAttachmentsUI;

  /* ========= 4) Ù…Ù„Ø®Ù‘Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ========= */
  function refreshAttendanceSummary(){
    const badge = $('#a_summary'); if(!badge) return;
    const date = $('#a_date')?.value || '';
    const cls  = $('#a_class')?.value || '';
    const sessions = (d.attSessions||[]).filter(s => (!cls || s.class===cls) && (!date || s.date===date));
    badge.textContent = `Ø¬Ù„Ø³Ø§Øª: ${sessions.length}`;
  }
  // Ø§Ø±Ø¨Ø·Ù‡ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  ['a_date','a_class'].forEach(id=>{
    const el = $('#'+id); if(el) el.addEventListener('change', refreshAttendanceSummary);
  });

  /* ========= 5) Ø´Ø±ÙŠØ· Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ========= */
  function refreshReportStats(){
    const badge = $('#rp_stats'); if(!badge) return;
    const from = $('#rp_from')?.value || '0000-00-00';
    const to   = $('#rp_to')?.value   || '9999-12-31';
    const cls  = $('#rp_class')?.value || '';
    const sess = (d.attSessions||[]).filter(s=>(!cls || s.class===cls) && s.date>=from && s.date<=to);
    const totalEntries = sess.reduce((n,s)=> n + ((s.entries||[]).length), 0);
    const all = (d.grades||[]).filter(g=>(!cls || g.class===cls) && g.date>=from && g.date<=to).map(g=> +g.total||0);
    const avg = all.length ? (all.reduce((a,b)=>a+b,0)/all.length).toFixed(1) : 'â€”';
    badge.textContent = `Ø¬Ù„Ø³Ø§Øª: ${sess.length} | Ù‚ÙŠÙˆØ¯ Ø­Ø¶ÙˆØ±: ${totalEntries} | Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: ${avg}`;
  }
  ['rp_from','rp_to','rp_class'].forEach(id=>{
    const el = $('#'+id); if(el) el.addEventListener('change', refreshReportStats);
  });

  /* ========= 6) ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ========= */
  function buildGradesAnalysis(){
    const btn = $('#g_analyze'); const box = $('#g_analysis');
    if(!btn || !box) return;
    btn.addEventListener('click', ()=>{
      const cls = $('#g_class')?.value || '';
      const list = (d.roster||[]).filter(s=>!cls || s.class===cls);
      // Ø¢Ø®Ø± Ø±ØµØ¯ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
      const lastBy = {};
      [...(d.grades||[])].reverse().forEach(g=>{ if(!lastBy[g.studentId]) lastBy[g.studentId]=g; });
      const rows = list.map(s=>{
        const g = lastBy[s.id]||{};
        return { name:s.name, total:+g.total||0 };
      });
      const top = rows.slice().sort((a,b)=>b.total-a.total).slice(0,5);
      const weak = rows.filter(r=>r.total<50).sort((a,b)=>a.total-b.total).slice(0,5);

      box.style.display = 'block';
      box.innerHTML = `
        <h3>ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</h3>
        <div class="grid">
          <div>
            <strong>Ø£Ø¹Ù„Ù‰ 5:</strong>
            <ol>${top.map(r=>`<li>${esc(r.name)} â€” ${r.total}</li>`).join('')}</ol>
          </div>
          <div>
            <strong>Ø¨Ø­Ø§Ø¬Ø© Ø¯Ø¹Ù… (&lt;50):</strong>
            <ol>${weak.map(r=>`<li>${esc(r.name)} â€” ${r.total}</li>`).join('')}</ol>
          </div>
        </div>
      `;
    });
  }

  /* ========= 7) Ø¨Ø­Ø« Ø§Ù„Ø·Ù„Ø§Ø¨ + ØªØ°ÙƒÙ‘Ø± Ø§Ù„ØµÙ ========= */
  function hookStudentSearch(){
    const inp = $('#st_search'); if(!inp) return;
    inp.addEventListener('input', ()=>{
      const q = inp.value.trim();
      // Ù†Ø·Ù„Ù‚ Ø­Ø¯Ø«Ù‹Ø§ Ø¹Ø§Ù…Ù‘Ù‹Ø§ Ù„ÙŠØ¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨ÙÙ„ØªØ±
      document.dispatchEvent(new CustomEvent('roster:search', {detail:{q}}));
    });
  }

  /* ========= 8) Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ========= */
  function sm_fillStudents(){
    const sel = $('#sm_student'); if(!sel) return;
    const roster = (d.roster||[]).filter(s=>s && s.name);
    sel.innerHTML = roster.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'')})</option>`).join('');
  }
  function sm_attendanceStats(studentId, from, to){
    let present=0, absent=0, late=0, leave=0, total=0;
    (d.attSessions||[]).forEach(ss=>{
      if(ss.date < from || ss.date > to) return;
      const e = (ss.entries||[]).find(x=>x.studentId===studentId); if(!e) return;
      total++; const s=e.status;
      if(s==='Ø­Ø§Ø¶Ø±') present++;
      else if(s==='ØºØ§Ø¦Ø¨') absent++;
      else if(s==='Ù…ØªØ£Ø®Ø±') late++;
      else if(s==='Ø§Ø³ØªØ¦Ø°Ø§Ù†') leave++;
    });
    const pct = total ? Math.round((present/total)*100) : null;
    return {present, absent, late, leave, total, pct};
  }
  function sm_behaviorStats(studentId, from, to){
    let pos=0, neg=0;
    const items = (d.behavior||[]).filter(b=>b.studentId===studentId && b.date>=from && b.date<=to);
    items.forEach(b=>{ if(b.type==='positive') pos+=(+b.points||0); else neg+=Math.abs(+b.points||0); });
    const latest = items.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,3);
    return {pos, neg, latest};
  }
  function sm_gradeStats(studentId, from, to){
    const rows = (d.grades||[]).filter(g=>g.studentId===studentId && g.date>=from && g.date<=to);
    if(!rows.length) return {best:null,last:null};
    const best = rows.slice().sort((a,b)=> (+b.total||0)-(+a.total||0))[0];
    const last = rows.slice().sort((a,b)=> b.date.localeCompare(a.date))[0];
    return {best,last};
  }
  function sm_buildText(){
    const sid = $('#sm_student')?.value; const pv = $('#sm_preview'); if(!sid||!pv) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨');
    const stu = (d.roster||[]).find(s=>s.id===sid);
    const from = $('#sm_from')?.value || '0000-00-00';
    const to   = $('#sm_to')?.value   || '9999-12-31';
    const incAtt = $('#sm_att')?.checked; const incBeh = $('#sm_beh')?.checked; const incGrd = $('#sm_grd')?.checked;

    let html = `<h2>Ù…Ø°ÙƒØ±Ø© Ø¨Ø´Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ / ${esc(stu?.name||'')}</h2>
      <div class="meta">Ø§Ù„ØµÙ: ${esc(stu?.class||'â€”')} â€” Ø§Ù„Ù…Ø¯Ø©: ${esc(from)} Ø¥Ù„Ù‰ ${esc(to)}</div>`;

    if(incAtt){
      const A = sm_attendanceStats(sid, from, to);
      html += `<div class="sec"><strong>Ø£ÙˆÙ„Ù‹Ø§: Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</strong><br>
        Ø§Ù„Ø¬Ù„Ø³Ø§Øª: ${A.total||0}. Ø­Ø¶Ø±: ${A.present}, ØºÙŠØ§Ø¨: ${A.absent}, ØªØ£Ø®Ø±: ${A.late}, Ø§Ø³ØªØ¦Ø°Ø§Ù†: ${A.leave}.
        ${A.pct!=null?`Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${A.pct}%`:''}
      </div>`;
    }
    if(incBeh){
      const B = sm_behaviorStats(sid, from, to);
      const latest = B.latest.map(b=>`â€¢ ${esc(b.date)} â€” ${b.type==='positive'?'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ':'Ø³Ù„Ø¨ÙŠ'} (${b.points||0}): ${esc(b.category||'')} â€” ${esc(b.note||'')}`).join('<br>');
      html += `<div class="sec"><strong>Ø«Ø§Ù†ÙŠÙ‹Ø§: Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</strong><br>
        Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ: ${B.pos}ØŒ Ø§Ù„Ø³Ù„Ø¨ÙŠ: ${B.neg}.<br>
        ${latest?`Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:<br>${latest}`:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.'}
      </div>`;
    }
    if(incGrd){
      const G = sm_gradeStats(sid, from, to), last = G.last||{};
      html += `<div class="sec"><strong>Ø«Ø§Ù„Ø«Ù‹Ø§: Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</strong><br>
        Ø£ÙØ¶Ù„ Ù…Ø¬Ù…ÙˆØ¹: ${G.best?(+G.best.total||0):'â€”'}.
        Ø£Ø­Ø¯Ø« Ø±ØµØ¯: ${esc(G.last?G.last.date:'â€”')}
        ${G.last?` â€” ÙˆØ§Ø¬Ø¨Ø§Øª ${+last.homework||0}/10ØŒ Ù…Ù‡Ø§Ù… ${+last.tasks||0}/20ØŒ Ù…Ø´Ø§Ø±ÙƒØ© ${+last.particip||0}/10ØŒ Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± ${+last.quiz||0}/20ØŒ Ù†Ù‡Ø§Ø¦ÙŠ ${+last.final||0}/40ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${+last.total||0}/100`:''}.
      </div>`;
    }
    html += `<div class="sec"><strong>Ø®Ù„Ø§ØµØ© ÙˆØªÙˆØµÙŠØ§Øª</strong><br>
      â€“ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚ØµÙŠØ±Ø©.<br>
      â€“ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.<br>
      â€“ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ù… ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ£Ø®Ø± Ù…Ø¨ÙƒØ±Ù‹Ø§.<br>
    </div>
    <div style="margin-top:18px">Ø­Ø±Ø± ÙÙŠ: ${new Date().toLocaleDateString('ar')} â€” ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ____________</div>`;

    pv.innerHTML = html;
  }
  function sm_print(){ window.print(); }

  const smBuild = $('#sm_build'); if(smBuild) smBuild.addEventListener('click', sm_buildText);
  const smPrn = $('#sm_print'); if(smPrn) smPrn.addEventListener('click', sm_print);

  // ØªØ¹ÙŠÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  (function(){
    const today = new Date().toISOString().slice(0,10);
    if($('#sm_from') && !$('#sm_from').value) $('#sm_from').value = today;
    if($('#sm_to') && !$('#sm_to').value) $('#sm_to').value = today;
  })();

  /* ========= 9) Ù†Ù‚Ø§Ø· Ø±Ø¨Ø· Ù…Ø¹ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ========= */
  // Ù†Ø¯Ø§Ø¡Ø§Øª ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„/ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
  function afterRosterChanged(){
    sm_fillStudents();
    hookStudentSearch();
  }
  function afterAttendanceChanged(){
    refreshAttendanceSummary();
  }
  function afterReportFiltersChanged(){
    refreshReportStats();
  }
  function afterGradesChanged(){
    buildGradesAnalysis();
  }

  // Ø§ÙƒØ´Ù Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ ÙƒÙŠ ØªÙ†Ø§Ø¯ÙŠÙ‡Ø§ Ù…Ù† Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¯ÙŠÙƒ
  window.Daybook = Object.assign(window.Daybook||{}, {
    afterRosterChanged, afterAttendanceChanged, afterReportFiltersChanged, afterGradesChanged,
    LAST
  });

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  afterRosterChanged();
  afterAttendanceChanged();
  afterReportFiltersChanged();
  afterGradesChanged();

  /* ========= 10) Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶: Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ØªÙƒØ±Ø§Ø± buildGrades ÙØ§Ø±Øº ========= */
  if (typeof window.buildGrades === 'function' && String(window.buildGrades).length < 50) {
    // Ù„Ùˆ ÙÙŠÙ‡ ØªØ¹Ø±ÙŠÙ ÙØ§Ø±Øº Ù‚Ø¯ÙŠÙ…ØŒ Ø§Ø­Ø°ÙÙ‡ (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯)
    try{ delete window.buildGrades; }catch{}
  }

})();
</script>