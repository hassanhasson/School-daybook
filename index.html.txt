

<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>School Daybook Suite â€” Pages + Supabase</title>
<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;School Daybook Suite&quot;,&quot;short_name&quot;:&quot;Daybook&quot;,&quot;start_url&quot;:&quot;./index.html&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;dir&quot;:&quot;rtl&quot;,&quot;lang&quot;:&quot;ar&quot;,&quot;background_color&quot;:&quot;#0f172a&quot;,&quot;theme_color&quot;:&quot;#0ea5e9&quot;}" />
<style>
:root{--bg:#0f172a;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e5e7eb;--primary:#0ea5e9;--success:#10b981;--warn:#ef4444}
*{box-sizing:border-box}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans Arabic',sans-serif;background:#f1f5f9;color:var(--ink)}
header{background:var(--bg);color:#fff;padding:12px 16px}
header h1{margin:0 0 4px 0;font-size:18px}
nav{display:flex;gap:6px;background:#e2e8f0;padding:8px 12px;flex-wrap:wrap}
nav button{border:0;background:#cbd5e1;padding:8px 12px;border-radius:8px;cursor:pointer}
nav button.active{background:#fff}
main{padding:12px}
.panel{display:none}.panel.active{display:block}
.section{background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.grid .wide{grid-column:1/-1}
.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.table th,.table td{padding:8px;border-bottom:1px solid var(--line);text-align:right;font-size:14px}
.table thead th{background:#f8fafc}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.controls button,.controls label.import{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.secondary{background:var(--success);color:#fff;border-color:var(--success)}
.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
small.muted{color:#64748b}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
#syncStatus{font-size:12px;color:#334155}
</style>
</head>
<body>
<header>
  <h1>School Daybook Suite â€” GitHub Pages + Supabase</h1>
  <div id="syncStatus">Sync: idle</div>
</header>
<nav id="tabs">
  <button data-tab="students" class="active">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
  <button data-tab="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
  <button data-tab="behavior">Ø§Ù„Ø³Ù„ÙˆÙƒ</button>
  <button data-tab="grades">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
  <button data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  <button data-tab="settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  <button id="syncBtn" class="secondary" style="margin-inline-start:auto">Sync â†•ï¸</button>
</nav>
<main>
  <!-- students -->
  <section id="panel-students" class="panel active">
    <div class="section">
      <div class="grid">
        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨<input id="st_name" /></label>
        <label>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)<input id="st_code" /></label>
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<input id="st_class" /></label>
        <div class="wide controls">
          <button id="st_add" class="primary">Ø¥Ø¶Ø§ÙØ©</button>
          <button id="st_pull">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
          <button id="st_push">Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</button>
        </div>
      </div>
    </div>
    <div class="section">
      <table class="table" id="st_table">
        <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¹Ø±Ù</th><th>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- attendance -->
  <section id="panel-attendance" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<select id="a_class"></select></label>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®<input type="date" id="a_date" /></label>
      </div>
      <div class="controls">
        <button id="all_present">Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±</button>
        <button id="all_absent">Ø§Ù„ÙƒÙ„ ØºØ§Ø¦Ø¨</button>
        <button id="toggle_pa">Ù‚Ù„Ø¨</button>
        <button id="a_save" class="primary">Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        <button id="a_pull">Ø³Ø­Ø¨</button>
        <button id="a_push">Ø±ÙØ¹</button>
        <span id="a_msg" class="muted"></span>
      </div>
      <table class="table" id="a_table">
        <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- behavior -->
  <section id="panel-behavior" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®<input type="date" id="b_date" /></label>
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨<select id="b_student"></select></label>
        <label>Ø§Ù„Ù†ÙˆØ¹
          <select id="b_type"><option value="positive">Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</option><option value="negative">Ø³Ù„ÙˆÙƒ Ø³Ù„Ø¨ÙŠ</option></select>
        </label>
        <label>Ø§Ù„ÙØ¦Ø©<input id="b_cat" placeholder="Ø§Ù†Ø¶Ø¨Ø§Ø·/ØªØ¹Ø§ÙˆÙ†..." /></label>
        <label>Ø§Ù„Ù†Ù‚Ø§Ø·<input type="number" id="b_points" value="1" /></label>
        <label class="wide">Ù…Ù„Ø§Ø­Ø¸Ø©<textarea id="b_note" rows="2"></textarea></label>
        <div class="wide controls">
          <button id="b_add" class="primary">Ø¥Ø¶Ø§ÙØ©</button>
          <button id="b_pull">Ø³Ø­Ø¨</button>
          <button id="b_push">Ø±ÙØ¹</button>
        </div>
      </div>
    </div>
    <div class="section">
      <table class="table" id="b_table">
        <thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- grades -->
  <section id="panel-grades" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<select id="g_class"></select></label>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®<input type="date" id="g_date" /></label>
      </div>
      <table class="table" id="g_table">
        <thead><tr>
          <th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>ÙˆØ§Ø¬Ø¨Ø§Øª (10)</th><th>Ù…Ù‡Ø§Ù… Ø£Ø¯Ø§Ø¦ÙŠØ© (20)</th><th>Ù…Ø´Ø§Ø±ÙƒØ© (10)</th><th>Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± (20)</th><th>Ù†Ù‡Ø§Ø¦ÙŠ (40)</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="controls">
        <button id="g_save" class="primary">Ø­ÙØ¸</button>
        <button id="g_pull">Ø³Ø­Ø¨</button>
        <button id="g_push">Ø±ÙØ¹</button>
      </div>
    </div>
  </section>

  <!-- reports -->
  <section id="panel-reports" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©<select id="rp_class"></select></label>
        <label>Ù…Ù†<input type="date" id="rp_from" /></label>
        <label>Ø¥Ù„Ù‰<input type="date" id="rp_to" /></label>
        <div class="wide controls">
          <button id="rp_term1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</button>
          <button id="rp_term2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
          <button id="rp_run" class="primary">ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
      <table class="table" id="rp_table">
        <thead><tr><th>#</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø­Ø¶ÙˆØ±</th><th>ØºÙŠØ§Ø¨</th><th>Ø§Ø³ØªØ¦Ø°Ø§Ù†</th><th>Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</th><th>Ø³Ù„Ø¨ÙŠ</th><th>Ø£Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- settings -->
  <section id="panel-settings" class="panel">
    <div class="section">
      <div class="grid">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<input id="s_school" /></label>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹<input id="s_signer" /></label>
        <label class="wide">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)<input type="file" id="s_logo" accept="image/*" /></label>
        <div class="wide"><small class="muted">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„: 1447/03/01 â†’ 1447/07/20 â€” Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: 1447/07/29 â†’ 1448/01/10</small></div>
      </div>
      <div class="controls">
        <button id="s_save" class="primary">Ø­ÙØ¸</button>
        <button id="s_export">ØªØµØ¯ÙŠØ± JSON</button>
        <label class="import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON<input type="file" id="s_import" accept="application/json" /></label>
      </div>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" defer></script>
<script>
/*** Supabase keys (Ø®Ø§ØµØ© Ø¨Ùƒ) ***/
const SUPABASE_URL = 'https://alamidjtlxuquvjvvcac.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYW1pZGp0bHh1cXV2anZ2Y2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDAwMTMsImV4cCI6MjA3MTYxNjAxM30.WGMo2sdJszJRp4Pkf91BfL7OOWrjNV_z82L8T-ZrjtU';

/*** Local storage ***/
const DBKEY='daybook_cloud_v1', BRAND='daybook_brand_v1';
function load(){try{return JSON.parse(localStorage.getItem(DBKEY)||'{}')}catch{return{}}}
function save(d){localStorage.setItem(DBKEY,JSON.stringify(d))}
function ensure(){
  const d=load();
  d.roster=d.roster||[];            // [{id,code,name,class}]
  d.attSessions=d.attSessions||[];  // [{id,date,class,entries:[{studentId,status,note}]}]
  d.behavior=d.behavior||[];        // [{id,date,studentId,type,category,points,note}]
  d.grades=d.grades||[];            // [{id,date,studentId,class,homework,tasks,particip,quiz,final,total}]
  d.events=d.events||[];
  d.terms=d.terms||{t1:{from:'',to:'',fromH:'1447/03/01',toH:'1447/07/20'},t2:{from:'',to:'',fromH:'1447/07/29',toH:'1448/01/10'}};
  save(d); return d;
}
function esc(s){return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function today(){return new Date().toISOString().slice(0,10)}
const syncNote = (t)=>{document.getElementById('syncStatus').textContent='Sync: '+t}

/*** Tabs ***/
const $=(q,r=document)=>r.querySelector(q), $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
$$('#tabs button[data-tab]').forEach(btn=>{
  btn.onclick=()=>{$$('#tabs button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  $$('.panel').forEach(p=>p.classList.remove('active'));$('#panel-'+btn.dataset.tab).classList.add('active');};
});

/*** Supabase client ***/
let supa = null;
function supaReady(){return SUPABASE_URL && SUPABASE_KEY}
function supaInit(){ if(!supaReady()) return null; if(!supa) supa = supabase.createClient(SUPABASE_URL,SUPABASE_KEY); return supa; }

/*** Data model ***/
const d=ensure();

/*** Students ***/
function renderStudents(){
  const tb=$('#st_table tbody'); tb.innerHTML='';
  d.roster.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${esc(s.name)}</td><td>${esc(s.code||'â€”')}</td><td>${esc(s.class||'â€”')}</td>
      <td><button data-e="${s.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button data-x="${s.id}">Ø­Ø°Ù</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.roster=d.roster.filter(x=>x.id!==b.dataset.x); save(d); renderStudents(); });
  tb.querySelectorAll('[data-e]').forEach(b=>b.onclick=()=>{ const s=d.roster.find(x=>x.id===b.dataset.e); if(!s) return;
    const name=prompt('Ø§Ù„Ø§Ø³Ù…:',s.name)||s.name; const cls=prompt('Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©:',s.class||'')||''; s.name=name; s.class=cls; save(d); renderStudents(); });
}
$('#st_add').onclick=()=>{
  const name=$('#st_name').value.trim(); if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
  d.roster.push({id:crypto.randomUUID(), code:$('#st_code').value.trim()||'', name, class:$('#st_class').value.trim()});  // (fixed)
  save(d); $('#st_name').value=''; $('#st_code').value=''; $('#st_class').value=''; renderStudents(); fillClassSelectors(); fillStudentSelect(); buildGrades(); buildAttendance();
};
$('#st_pull').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase Ø£ÙˆÙ„Ø§Ù‹'); syncNote('pulling studentsâ€¦');
  const {data,error}=await supa.from('students').select('*').order('created_at'); if(error){alert(error.message); return}
  d.roster=data.map(r=>({id:r.id, code:r.code, name:r.name, class:r.class})); save(d); renderStudents(); fillClassSelectors(); fillStudentSelect(); buildGrades(); buildAttendance(); syncNote('pulled');
};
$('#st_push').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase Ø£ÙˆÙ„Ø§Ù‹'); syncNote('pushing studentsâ€¦');
  await supa.from('students').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.roster.length){ const rows=d.roster.map(s=>({id:s.id,code:s.code,name:s.name,class:s.class})); const {error}=await supa.from('students').insert(rows); if(error) return alert(error.message); }
  syncNote('pushed');
};

/*** Helpers for selects ***/
function fillClassSelectors(){
  const list=[...new Set(d.roster.map(s=>s.class).filter(Boolean))];
  $('#a_class').innerHTML='<option value="">â€” Ø§Ù„ÙƒÙ„ â€”</option>'+list.map(c=>`<option>${esc(c)}</option>`).join('');
  $('#g_class').innerHTML='<option value="">â€” Ø§Ù„ÙƒÙ„ â€”</option>'+list.map(c=>`<option>${esc(c)}</option>`).join('');
  $('#rp_class').innerHTML='<option value="">â€” Ø§Ù„ÙƒÙ„ â€”</option>'+list.map(c=>`<option>${esc(c)}</option>`).join('');
}
function fillStudentSelect(){ $('#b_student').innerHTML=d.roster.map(s=>`<option value="${s.id}">${esc(s.name)} (${esc(s.class||'â€”')})</option>`).join(''); }

/*** Attendance ***/
$('#a_date').value=today();
function buildAttendance(){
  const cls=$('#a_class').value; const list=d.roster.filter(s=>!cls || s.class===cls);
  const tb=$('#a_table tbody'); tb.innerHTML='';
  list.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${esc(s.name)}</td>
      <td><select data-s="${s.id}"><option value=""></option><option>Ø­Ø§Ø¶Ø±</option><option>ØºØ§Ø¦Ø¨</option><option>Ù…ØªØ£Ø®Ø±</option><option>Ø§Ø³ØªØ¦Ø°Ø§Ù†</option></select></td>
      <td><input data-n="${s.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" /></td>`;
    tb.appendChild(tr);
  });
}
$('#a_class').onchange=buildAttendance;
$('#all_present').onclick=()=> $$('#a_table select').forEach(s=>s.value='Ø­Ø§Ø¶Ø±');
$('#all_absent').onclick=()=> $$('#a_table select').forEach(s=>s.value='ØºØ§Ø¦Ø¨');
$('#toggle_pa').onclick=()=> $$('#a_table select').forEach(s=> s.value = (s.value==='Ø­Ø§Ø¶Ø±'?'ØºØ§Ø¦Ø¨':'Ø­Ø§Ø¶Ø±'));
$('#a_save').onclick=()=>{
  const cls=$('#a_class').value, date=$('#a_date').value;
  const rows=$$('#a_table tbody tr'); const entries=[];
  rows.forEach(r=>{
    const sid=r.querySelector('select').dataset.s, st=r.querySelector('select').value, note=r.querySelector('input').value.trim();
    if(st||note) entries.push({studentId:sid,status:st,note});
  });
  if(!entries.length) return alert('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª');
  d.attSessions.push({id:crypto.randomUUID(), date, class:cls, entries});
  save(d); $('#a_msg').textContent='ØªÙ… Ø§Ù„Ø­ÙØ¸'; setTimeout(()=>$('#a_msg').textContent='',1500);
};
$('#a_pull').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase');
  syncNote('pulling attendanceâ€¦');
  const {data:sess,error:sErr}=await supa.from('attendance_sessions').select('*').order('date'); if(sErr) return alert(sErr.message);
  const {data:ents,error:eErr}=await supa.from('attendance_entries').select('*'); if(eErr) return alert(eErr.message);
  const byId={}; sess.forEach(s=>byId[s.id]={id:s.id,date:String(s.date),class:s.class,entries:[]});
  ents.forEach(e=>{ if(byId[e.session_id]) byId[e.session_id].entries.push({studentId:e.student_id,status:e.status,note:e.note||''}) });
  d.attSessions=Object.values(byId); save(d); buildAttendance(); syncNote('pulled');
};
$('#a_push').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase');
  syncNote('pushing attendanceâ€¦');
  await supa.from('attendance_entries').delete().neq('id','00000000-0000-0000-0000-000000000000');
  await supa.from('attendance_sessions').delete().neq('id','00000000-0000-0000-0000-000000000000');
  for(const s of d.attSessions){
    await supa.from('attendance_sessions').insert({id:s.id,date:s.date,class:s.class});
    if(s.entries?.length){
      const rows=s.entries.map(e=>({session_id:s.id,student_id:e.studentId,status:e.status||null,note:e.note||null}));
      if(rows.length){ const {error}=await supa.from('attendance_entries').insert(rows); if(error) return alert(error.message); }
    }
  }
  syncNote('pushed');
};

/*** Behavior ***/
$('#b_date').value=today();
$('#b_add').onclick=()=>{ const e={id:crypto.randomUUID(),date:$('#b_date').value,studentId:$('#b_student').value,type:$('#b_type').value,category:$('#b_cat').value.trim(),points:Number($('#b_points').value)||0,note:$('#b_note').value.trim()};
  d.behavior.push(e); save(d); renderBehavior(); $('#b_note').value='';};
function renderBehavior(){
  const tb=$('#b_table tbody'); tb.innerHTML='';
  d.behavior.forEach((e,i)=>{ const s=d.roster.find(x=>x.id===e.studentId);
    tb.innerHTML+=`<tr><td>${i+1}</td><td>${esc(e.date)}</td><td>${esc(s?s.name:'?')}</td><td>${e.type==='positive'?'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ':'Ø³Ù„Ø¨ÙŠ'}</td><td>${esc(e.category||'â€”')}</td><td>${e.points||0}</td><td>${esc(e.note||'â€”')}</td><td><button data-x="${e.id}">ğŸ—‘</button></td></tr>`; });
  tb.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{ d.behavior=d.behavior.filter(x=>x.id!==b.dataset.x); save(d); renderBehavior(); });
}
$('#b_pull').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase'); syncNote('pulling behaviorâ€¦');
  const {data,error}=await supa.from('behavior').select('*').order('date'); if(error) return alert(error.message);
  d.behavior=data.map(x=>({id:x.id,date:String(x.date),studentId:x.student_id,type:x.type,category:x.category,points:x.points||0,note:x.note||''})); save(d); renderBehavior(); syncNote('pulled'); };
$('#b_push').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase'); syncNote('pushing behaviorâ€¦');
  await supa.from('behavior').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.behavior.length){ const rows=d.behavior.map(e=>({id:e.id,date:e.date,student_id:e.studentId,type:e.type,category:e.category,points:e.points||0,note:e.note||null}));
    const {error}=await supa.from('behavior').insert(rows); if(error) return alert(error.message); }
  syncNote('pushed');
};

/*** Grades (10/20/10/20/40) ***/
$('#g_date').value=today();
function buildGrades(){
  const cls=$('#g_class').value; const list=d.roster.filter(s=>!cls || s.class===cls);
  const tb=$('#g_table tbody'); tb.innerHTML='';
  list.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${esc(s.name)}</td>
      <td><input type="number" min="0" max="10" step="1" data-k="homework" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="20" step="1" data-k="tasks" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="10" step="1" data-k="particip" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="20" step="1" data-k="quiz" data-s="${s.id}"></td>
      <td><input type="number" min="0" max="40" step="1" data-k="final" data-s="${s.id}"></td>
      <td data-total="${s.id}">0</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input').forEach(inp=>inp.oninput=()=>{
    const sid=inp.dataset.s; const vals={homework:0,tasks:0,particip:0,quiz:0,final:0};
    tb.querySelectorAll(`input[data-s="${sid}"]`).forEach(el=>{ vals[el.dataset.k]=Number(el.value)||0; });
    const total=vals.homework+vals.tasks+vals.particip+vals.quiz+vals.final;
    tb.querySelector(`[data-total="${sid}"]`).textContent=total; // (fixed)
  });
}
$('#g_class').onchange=buildGrades;
$('#g_save').onclick=()=>{
  const cls=$('#g_class').value, date=$('#g_date').value; const rows=$$('#g_table tbody tr'); const recs=[];
  rows.forEach(r=>{
    const sid=r.querySelector('input').dataset.s;
    const get=(k)=>Number(r.querySelector(`input[data-k="${k}"][data-s="${sid}"]`).value)||0;
    const vals={homework:get('homework'),tasks:get('tasks'),particip:get('particip'),quiz:get('quiz'),final:get('final')};
    recs.push({id:crypto.randomUUID(),date,studentId:sid,class:cls,...vals,total:vals.homework+vals.tasks+vals.particip+vals.quiz+vals.final});
  });
  d.grades=d.grades.filter(g=>!(g.date===date && g.class===cls)); d.grades.push(...recs); save(d); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
};
$('#g_pull').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase'); syncNote('pulling gradesâ€¦');
  const {data,error}=await supa.from('grades').select('*').order('date'); if(error) return alert(error.message);
  d.grades=data.map(g=>({id:g.id,date:String(g.date),studentId:g.student_id,class:g.class,homework:g.homework||0,tasks:g.tasks||0,particip:g.particip||0,quiz:g.quiz||0,final:g.final||0,total:g.total||0}));
  save(d); syncNote('pulled');
};
$('#g_push').onclick=async()=>{ if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase'); syncNote('pushing gradesâ€¦');
  await supa.from('grades').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(d.grades.length){ const rows=d.grades.map(g=>({id:g.id,date:g.date,student_id:g.studentId,class:g.class,homework:g.homework,tasks:g.tasks,particip:g.particip,quiz:g.quiz,final:g.final}));
    const {error}=await supa.from('grades').insert(rows); if(error) return alert(error.message); }
  syncNote('pushed');
};

/*** Reports ***/
function runReport(){
  const cls=$('#rp_class').value, from=$('#rp_from').value||'0000-00-00', to=$('#rp_to').value||'9999-12-31';
  const students=d.roster.filter(s=>!cls||s.class===cls); const body=$('#rp_table tbody'); body.innerHTML='';
  students.forEach((s,i)=>{
    let present=0,absent=0,leave=0;
    d.attSessions.filter(ss=>(!cls||ss.class===cls)&&ss.date>=from&&ss.date<=to).forEach(ss=>{
      const e=ss.entries.find(x=>x.studentId===s.id); if(!e) return;
      if(e.status==='Ø­Ø§Ø¶Ø±') present++; if(e.status==='ØºØ§Ø¦Ø¨') absent++; if(e.status==='Ø§Ø³ØªØ¦Ø°Ø§Ù†') leave++;
    });
    let pos=0,neg=0;
    d.behavior.filter(b=>b.studentId===s.id && b.date>=from && b.date<=to).forEach(b=>{ if(b.type==='positive') pos+=b.points||0; else neg+=Math.abs(b.points||0); });
    const g=d.grades.filter(g=>g.studentId===s.id && g.date>=from && g.date<=to); const maxTotal=g.length?Math.max(...g.map(x=>x.total||0)):0;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${esc(s.name)}</td><td>${present}</td><td>${absent}</td><td>${leave}</td><td>${pos}</td><td>${neg}</td><td>${maxTotal}</td>`;
    body.appendChild(tr);
  });
}
$('#rp_term1').onclick=()=>{ $('#rp_from').value=d.terms.t1.from; $('#rp_to').value=d.terms.t1.to; };
$('#rp_term2').onclick=()=>{ $('#rp_from').value=d.terms.t2.from; $('#rp_to').value=d.terms.t2.to; };
$('#rp_run').onclick=runReport;

/*** Settings / Backup ***/
const brand=JSON.parse(localStorage.getItem(BRAND)||'{}');
$('#s_school').value=brand.school||''; $('#s_signer').value=brand.signer||'';
$('#s_logo').onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const b=JSON.parse(localStorage.getItem(BRAND)||'{}'); b.logo=r.result; localStorage.setItem(BRAND,JSON.stringify(b)); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±'); }; r.readAsDataURL(f); };
$('#s_save').onclick=()=>{ const b=JSON.parse(localStorage.getItem(BRAND)||'{}'); b.school=$('#s_school').value; b.signer=$('#s_signer').value; localStorage.setItem(BRAND,JSON.stringify(b)); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); };
$('#s_export').onclick=()=>{ const blob=new Blob([JSON.stringify(ensure(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='daybook-backup.json'; a.click(); URL.revokeObjectURL(a.href); };
$('#s_import').onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const obj=JSON.parse(await f.text()); localStorage.setItem(DBKEY,JSON.stringify(obj)); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); location.reload(); }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }};

/*** Global sync button ***/
$('#syncBtn').onclick=async()=>{
  if(!supaInit()) return alert('Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙˆØ§Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø©');
  await $('#st_pull').onclick(); await $('#a_pull').onclick(); await $('#b_pull').onclick(); await $('#g_pull').onclick();
  syncNote('sync done');
};

/*** Init ***/
function init(){
  renderStudents(); fillClassSelectors(); buildAttendance(); fillStudentSelect(); renderBehavior(); buildGrades();
  $('#g_date').value=today(); $('#b_date').value=today();
}
init();

/*** PWA SW (inline) ***/
if('serviceWorker' in navigator){
  const swBlob = new Blob([`
    const CACHE='daybook-pages-supa-v1';
    const ASSETS=['./index.html'];
    self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))));
    self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE?caches.delete(k):null)))));
    self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match('./index.html'))))});
  `],{type:'text/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}
</script>
</body>
</html>